<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>考勤管理</title>
    <style>
        :root {
      --bg: #f4f6fb;
      --card: #ffffff;
      --card-soft: #f6f8ff;
      --text: #1f2a3d;
      --muted: #6b7686;
      --border: #e5e9f2;
      --line: #e5e9f2;
      --primary: #1c7bff;
      --primary-strong: #1b6fe8;
      --brand: #1c7bff;
      --brand2: #2e7bff;
      --accent: rgba(28, 123, 255, 0.08);
      --blue: #2f6fec;
      --purple: #7c3aed;
      --green: #16a34a;
      --orange: #f59e0b;
      --red: #ef4444;
      --danger: #ef4444;
      --warning: #f59e0b;
      --warn: #f59e0b;
      --success: #10b981;
      --shadow: 0 12px 28px rgba(31, 53, 90, 0.08);
      --shadowSoft: 0 10px 24px rgba(31, 53, 90, 0.07);
      --radius: 14px;
      --sidebar-w: 260px;
      --sidebar-w-collapsed: 68px;
    }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "PingFang SC", -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .page {
            padding: 24px;
        }

        .card {
            background: var(--card);
            border-radius: 16px;
            border: 1px solid var(--line);
            box-shadow: 0 12px 28px rgba(31, 53, 90, 0.08);
            padding: 22px 26px 10px;
        }

        .title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: 800;
            margin: 0 0 6px;
        }

        .title::before {
            content: "";
            width: 4px;
            height: 20px;
            border-radius: 12px;
            background: var(--primary);
            box-shadow: 0 0 0 6px rgba(36, 107, 253, 0.15);
        }

        .hint {
            margin: 0 0 18px;
            color: var(--muted);
            font-size: 14px;
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 18px;
            align-items: flex-end;
        }

        .filter-field {
            display: flex;
            flex-direction: column;
            font-size: 13px;
            color: var(--muted);
        }

        .filter-field label {
            margin-bottom: 6px;
        }

        .filter-field select,
        .filter-field input {
            min-width: 180px;
            border-radius: 8px;
            border: 1px solid var(--line);
            padding: 8px 10px;
            font-size: 14px;
            color: var(--text);
            background: #fff;
        }

        .filter-actions {
            display: flex;
            gap: 8px;
        }

        .filter-button {
            border-radius: 8px;
            border: 1px solid var(--primary);
            padding: 8px 18px;
            font-size: 13px;
            cursor: pointer;
        }

        .filter-apply {
            background: var(--primary);
            color: #fff;
        }

        .filter-reset {
            background: transparent;
            color: var(--primary);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            text-align: left;
            font-weight: 600;
            color: var(--muted);
            padding: 12px 8px;
            border-bottom: 1px solid var(--line);
        }

        tbody td {
            padding: 14px 8px;
            border-bottom: 1px solid var(--line);
            transition: background 0.2s;
        }

        tbody tr.summary-row {
            cursor: pointer;
        }

        tbody tr.summary-row:hover {
            background: var(--accent);
        }

        tbody tr.summary-row.active {
            background: rgba(36, 107, 253, 0.12);
        }

        .status-badge {
            display: inline-flex;
            min-width: 62px;
            justify-content: center;
            font-size: 12px;
            border-radius: 999px;
            padding: 2px 10px;
            color: #fff;
        }

        .status-normal {
            background: #00c48c;
        }

        .status-alert {
            background: #ff9f43;
        }

        .status-warning {
            background: #ff5f5f;
        }

        .detail-row {
            background: #f9faff;
        }

        .detail-wrapper {
            padding: 8px 0 16px 0;
        }

        .detail-header {
            font-weight: 600;
            margin: 6px 0 12px;
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .detail-table thead th {
            border-bottom: 1px solid var(--line);
            color: var(--muted);
            padding: 8px;
        }

        .detail-table tbody td {
            padding: 8px;
            border-bottom: 1px solid #edf1ff;
        }

        .no-data {
            color: var(--muted);
            font-size: 14px;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
<div class="page">
    <div class="card">
        <h3 class="title">考勤管理</h3>
        <p class="hint">单击人员行展示其每日打卡明细。</p>
        <div class="filters">
            <div class="filter-field">
                <label for="name-filter">姓名</label>
                <input type="text" id="name-filter" placeholder="输入姓名" />
            </div>
            <div class="filter-field">
                <label for="month-filter">月份</label>
                <input type="month" id="month-filter" />
            </div>
            <div class="filter-actions">
                <button class="filter-button filter-apply" id="filter-apply" type="button">筛选</button>
                <button class="filter-button filter-reset" id="filter-reset" type="button">重置</button>
            </div>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                <tr>
                    <th>姓名</th>
                    <th>月份</th>
                    <th>出勤日</th>
                    <th>欠勤日</th>
                    <th>剩余年休</th>
                    <th>状态</th>
                </tr>
                </thead>
                <tbody id="summary-body">
                </tbody>
            </table>
            <div id="no-data" class="no-data" style="display: none;">暂无考勤数据</div>
        </div>
    </div>
</div>
<script>
    let attendanceData = [];

    const statusMap = {
        normal: { label: "正常", className: "status-normal" },
        alert: { label: "关注", className: "status-alert" },
        warning: { label: "异常", className: "status-warning" }
    };

    const summaryBody = document.getElementById("summary-body");
    const noData = document.getElementById("no-data");
    const nameFilter = document.getElementById("name-filter");
    const monthFilter = document.getElementById("month-filter");
    const applyBtn = document.getElementById("filter-apply");
    const resetBtn = document.getElementById("filter-reset");
    const filters = { name: "", month: "" };

    function renderSummary() {
        summaryBody.innerHTML = "";

        if (!attendanceData.length) {
            noData.style.display = "block";
            return;
        }

        noData.style.display = "none";

        attendanceData.forEach((person, index) => {
            const summaryRow = document.createElement("tr");
            summaryRow.className = "summary-row";
            summaryRow.dataset.index = index;
            summaryRow.dataset.employeeId = person.employee_id;
            summaryRow.innerHTML = `
                <td>${person.name}</td>
                <td>${person.month}</td>
                <td>${person.attendance_days}</td>
                <td>${person.absence_days}</td>
                <td>${person.annual_leave}</td>
                <td>
                    <span class="status-badge ${statusMap[person.status]?.className || ""}">
                        ${statusMap[person.status]?.label || "未知"}
                    </span>
                </td>
            `;

            const detailRow = document.createElement("tr");
            detailRow.className = "detail-row";
            detailRow.style.display = "none";
            detailRow.innerHTML = `
                <td colspan="6">
                    <div class="detail-wrapper">
                        <div class="detail-header">${person.name} 的每日考勤</div>
                        ${renderDetailTable([])}
                    </div>
                </td>
            `;

            summaryBody.appendChild(summaryRow);
            summaryBody.appendChild(detailRow);
        });

        attachRowEvents();
    }

    function renderDetailTable(details = []) {
        if (!details.length) {
            return `<div class="no-data">暂未录入该员工的考勤明细</div>`;
        }

        const rows = details.map(
            item => `
                <tr>
                    <td>${item.date}</td>
                    <td>${item.day}</td>
                    <td>${item.clock_in}</td>
                    <td>${item.clock_out}</td>
                    <td>${item.note || "-"}</td>
                </tr>
            `
        ).join("");

        return `
            <table class="detail-table">
                <thead>
                    <tr>
                        <th>日期</th>
                        <th>星期</th>
                        <th>上班打卡</th>
                        <th>下班打卡</th>
                        <th>备注</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        `;
    }

    async function handleRowToggle(event) {
        const row = event.currentTarget;
        const index = row.dataset.index;
        const detailRow = row.nextElementSibling;

        const isActive = row.classList.contains("active");
        document.querySelectorAll(".summary-row").forEach(r => r.classList.remove("active"));
        document.querySelectorAll(".detail-row").forEach(r => r.style.display = "none");

        if (!isActive) {
            row.classList.add("active");
            detailRow.style.display = "table-row";
            await loadDetail(row.dataset.employeeId, detailRow, index);
        }
    }

    async function loadDetail(employeeId, detailRow, index) {
        const params = new URLSearchParams();
        if (filters.month) {
            params.set("month", filters.month);
        }

        const url = params.toString()
            ? `/api/attendance/${employeeId}/detail?${params.toString()}`
            : `/api/attendance/${employeeId}/detail`;

        const wrapper = detailRow.querySelector(".detail-wrapper");
        if (!wrapper) {
            return;
        }

        wrapper.innerHTML = `
            <div class="detail-header">加载中...</div>
            <div class="no-data">正在获取考勤明细</div>
        `;

        try {
            const response = await fetch(url, { credentials: "same-origin" });
            const data = await response.json();
            if (!response.ok) {
                wrapper.innerHTML = `
                    <div class="detail-header">明细加载失败</div>
                    <div class="no-data">${data.error || "请稍后重试"}</div>
                `;
                return;
            }

            const name = data.employee?.name || attendanceData[index]?.name || "";
            const details = data.details || [];
            wrapper.innerHTML = `
                <div class="detail-header">${name} 的每日考勤</div>
                ${renderDetailTable(details)}
            `;
        } catch (error) {
            wrapper.innerHTML = `
                <div class="detail-header">明细加载失败</div>
                <div class="no-data">请稍后重试</div>
            `;
        }
    }

    function attachRowEvents() {
        summaryBody.querySelectorAll(".summary-row").forEach(row => {
            row.addEventListener("click", handleRowToggle);
        });
    }

    function handleFilterApply() {
        filters.name = nameFilter.value;
        filters.month = monthFilter.value;
        loadAttendance();
    }

    function resetFilters() {
        filters.name = "";
        filters.month = getCurrentMonth();
        nameFilter.value = "";
        monthFilter.value = filters.month;
        loadAttendance();
    }

    function getCurrentMonth() {
        const today = new Date();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        return `${today.getFullYear()}-${month}`;
    }

    function setNoData(message) {
        noData.textContent = message || "暂无考勤数据";
        noData.style.display = "block";
    }

    async function loadAttendance() {
        const params = new URLSearchParams();
        if (filters.name) {
            params.set("name", filters.name);
        }
        if (filters.month) {
            params.set("month", filters.month);
        }

        const url = params.toString()
            ? `/api/attendance/summary?${params.toString()}`
            : "/api/attendance/summary";

        summaryBody.innerHTML = "";
        setNoData("正在加载考勤数据...");

        try {
            const response = await fetch(url, { credentials: "same-origin" });
            const data = await response.json();
            if (!response.ok) {
                attendanceData = [];
                setNoData(data.error || "加载考勤数据失败");
                return;
            }

            attendanceData = data.employees || [];
            if (!filters.month && data.month) {
                monthFilter.value = data.month;
            }
            renderSummary();
        } catch (error) {
            attendanceData = [];
            setNoData("加载考勤数据失败");
        }
    }

    filters.month = getCurrentMonth();
    monthFilter.value = filters.month;
    loadAttendance();

    applyBtn.addEventListener("click", handleFilterApply);
    resetBtn.addEventListener("click", resetFilters);
</script>
</body>
</html>
