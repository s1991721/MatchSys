<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="/favicon-32.png" type="image/png" sizes="32x32">
    <link rel="stylesheet" href="common.css">
    <link rel="stylesheet" href="components.css">
    <title data-i18n="attendance.title">考勤管理</title>
</head>
<body class="c-form-page">
<div class="page">
    <section class="c-card">
        <div class="filters c-filter-panel">
            <div class="filter-grid c-filter-grid-wide">
                <label>
                    <span data-i18n="attendance.filter.name">姓名</span>
                    <input type="search" id="name-filter" placeholder="输入姓名" data-i18n-placeholder="attendance.filter.name_placeholder" />
                </label>
                <label>
                    <span data-i18n="attendance.filter.month">月份</span>
                    <input type="month" id="month-filter" />
                </label>
            </div>
            <div class="filter-actions c-filter-actions-bar">
                <div class="filter-actions-left c-filter-actions-left"></div>
                <div class="filter-actions-right c-filter-actions-right c-filter-actions-group">
                    <button class="c-btn c-btn-primary" id="filter-apply" type="button" data-i18n="common.search">搜索</button>
                    <button class="c-btn c-btn-warn" id="filter-reset" type="button" data-i18n="common.reset">重置</button>
                </div>
            </div>
        </div>
        <div class="table-wrapper c-table-wrapper">
            <table class="c-table c-table-hover c-table-center">
                <thead>
                <tr>
                    <th data-i18n="attendance.table.name">姓名</th>
                    <th data-i18n="attendance.table.month">月份</th>
                    <th data-i18n="attendance.table.attendance_days">出勤日</th>
                    <th data-i18n="attendance.table.absence_days">缺勤日</th>
                    <th data-i18n="attendance.table.annual_leave">剩余年休</th>
                    <th data-i18n="attendance.table.status">状态</th>
                </tr>
                </thead>
                <tbody id="summary-body">
                </tbody>
            </table>
            <div id="no-data" class="c-empty hidden" data-i18n="attendance.empty">暂无考勤数据</div>
        </div>
        <div class="pagination c-pagination" id="attendance-pagination">
            <div class="pagination-summary">
                <span id="attendance-page-summary">共 0 条 · 第 1/1 页</span>
            </div>
            <div class="pagination-pages" id="attendance-pagination-pages"></div>
        </div>
    </section>
</div>
<script src="i18n.js"></script>
<script src="common.js"></script>
<script>
    const i18n = window.I18N;
    if (i18n) {
        i18n.init();
        i18n.apply();
    }
    const t = (key) => (i18n ? i18n.t(key) : key);
    const format = (key, vars) => (i18n ? i18n.format(key, vars) : key);

    let attendanceData = [];
    let currentPage = 1;
    let totalPages = 1;
    let totalCount = 0;
    const pageSize = 10;

    const statusMap = {
        normal: { label: t("attendance.status.normal"), className: "c-pill c-pill-success" },
        alert: { label: t("attendance.status.alert"), className: "c-pill c-pill-warn" },
        warning: { label: t("attendance.status.warning"), className: "c-pill c-pill-danger" }
    };
    const summaryBody = document.getElementById("summary-body");
    const noData = document.getElementById("no-data");
    const nameFilter = document.getElementById("name-filter");
    const monthFilter = document.getElementById("month-filter");
    const applyBtn = document.getElementById("filter-apply");
    const resetBtn = document.getElementById("filter-reset");
    const pagination = document.getElementById("attendance-pagination");
    const paginationPages = document.getElementById("attendance-pagination-pages");
    const pageSummary = document.getElementById("attendance-page-summary");
    const filters = { name: "", month: "" };

    const setDetailContent = (wrapper, title, content) => {
        wrapper.innerHTML = `
            <div class="c-panel-title">${title}</div>
            ${content}
        `;
    };

    const setDetailMessage = (wrapper, title, message) => {
        setDetailContent(wrapper, title, `<div class="c-empty">${message}</div>`);
    };

    const renderSummary = () => {
        summaryBody.innerHTML = "";

        if (!attendanceData.length) {
            setNoData(t("attendance.empty"));
            if (pagination) {
                pagination.classList.add("hidden");
            }
            return;
        }

        hideNoData();
        if (pagination) {
            pagination.classList.remove("hidden");
        }

        attendanceData.forEach((person) => {
            const summaryRow = document.createElement("tr");
            summaryRow.className = "summary-row";
            summaryRow.dataset.employeeId = person.employee_id;
            summaryRow.dataset.name = person.name;
            summaryRow.innerHTML = `
                <td>${person.name}</td>
                <td>${person.month}</td>
                <td>${person.attendance_days}</td>
                <td>${person.absence_days}</td>
                <td>${person.annual_leave}</td>
                <td>
                    <span class="${statusMap[person.status]?.className || "c-pill"}">
                        ${statusMap[person.status]?.label || t("attendance.status.unknown")}
                    </span>
                </td>
            `;

            const detailRow = document.createElement("tr");
            detailRow.className = "detail-row";
            detailRow.style.display = "none";
            detailRow.innerHTML = `
                <td colspan="6">
                    <div class="c-card-compact" data-detail-wrapper>
                        <div class="c-panel-title">${format("attendance.detail.title", { name: person.name })}</div>
                        ${renderDetailTable([])}
                    </div>
                </td>
            `;

            summaryBody.appendChild(summaryRow);
            summaryBody.appendChild(detailRow);
        });

        attachRowEvents();
    }

    const updatePagination = (meta = {}) => {
        totalCount = Number.isFinite(meta.total) ? meta.total : attendanceData.length;
        totalPages = Number.isFinite(meta.total_pages) ? meta.total_pages : 1;
        currentPage = Number.isFinite(meta.page) ? meta.page : currentPage;
        if (pageSummary) {
            pageSummary.textContent = format("attendance.page_summary", {
                count: totalCount,
                page: currentPage,
                total: totalPages
            });
        }
        window.renderPagination(pagination, paginationPages, currentPage, totalPages);
    };

    const renderDetailTable = (details = []) => {
        if (!details.length) {
            return `<div class="c-empty">${t("attendance.detail.empty")}</div>`;
        }

        const rows = details.map(
            item => `
                <tr>
                    <td>${item.date}</td>
                    <td>${item.day}</td>
                    <td>${item.clock_in}</td>
                    <td>${item.clock_out}</td>
                    <td>${item.note || "-"}</td>
                </tr>
            `
        ).join("");

        return `
            <table class="c-table c-table-compact c-table-center">
                <thead>
                    <tr>
                        <th>${t("attendance.detail.date")}</th>
                        <th>${t("attendance.detail.weekday")}</th>
                        <th>${t("attendance.detail.clock_in")}</th>
                        <th>${t("attendance.detail.clock_out")}</th>
                        <th>${t("attendance.detail.note")}</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        `;
    }

    const handleRowToggle = async (event) => {
        const row = event.currentTarget;
        const detailRow = row.nextElementSibling;

        const isActive = row.classList.contains("active");
        document.querySelectorAll(".summary-row").forEach(r => r.classList.remove("active"));
        document.querySelectorAll(".detail-row").forEach(r => r.style.display = "none");

        if (!isActive) {
            row.classList.add("active");
            detailRow.style.display = "table-row";
            await loadDetail(row.dataset.employeeId, detailRow);
        }
    }

    const loadDetail = async (employeeId, detailRow) => {
        const params = createParams([
            ["month", filters.month]
        ]);
        const url = buildUrl(`/api/attendance/${employeeId}/detail`, params);
        const wrapper = detailRow.querySelector("[data-detail-wrapper]");
        if (!wrapper) {
            return;
        }

        setDetailMessage(wrapper, t("common.loading"), t("attendance.detail.loading"));

        try {
            const response = await fetchWithAuth(url, { method: "GET" });
            const data = await response.json();
            const payload = normalizeApiResponse(data);
            if (!response.ok || !payload.success) {
                setDetailMessage(wrapper, t("attendance.detail.failed"), payload.message || t("attendance.detail.retry"));
                return;
            }

            const result = payload.data || {};
            const name = result.employee?.name || detailRow.previousElementSibling?.dataset.name || "";
            const details = result.details || [];
            setDetailContent(wrapper, format("attendance.detail.title", { name }), renderDetailTable(details));
        } catch (error) {
            setDetailMessage(wrapper, t("attendance.detail.failed"), t("attendance.detail.retry"));
        }
    }

    const attachRowEvents = () => {
        summaryBody.querySelectorAll(".summary-row").forEach(row => {
            row.addEventListener("click", handleRowToggle);
        });
    }

    const handleFilterApply = () => {
        filters.name = nameFilter.value;
        filters.month = monthFilter.value;
        currentPage = 1;
        loadAttendance();
    }

    const resetFilters = () => {
        filters.name = "";
        filters.month = getCurrentMonth();
        nameFilter.value = "";
        monthFilter.value = filters.month;
        currentPage = 1;
        loadAttendance();
    }

    const setNoData = (message) => {
        noData.textContent = message || t("attendance.empty");
        noData.classList.remove("hidden");
    }

    const hideNoData = () => {
        noData.classList.add("hidden");
    }

    const loadAttendance = async () => {
        const params = createParams([
            ["name", filters.name],
            ["month", filters.month],
            ["page", String(currentPage)],
            ["page_size", String(pageSize)]
        ]);
        const url = buildUrl("/api/attendance/summary", params);
        summaryBody.innerHTML = "";
        setNoData(t("attendance.loading"));
        if (pagination) {
            pagination.classList.add("hidden");
        }

        try {
            const response = await fetchWithAuth(url, { method: "GET" });
            const data = await response.json();
            const payload = normalizeApiResponse(data);
            if (!response.ok || !payload.success) {
                attendanceData = [];
                setNoData(payload.message || t("attendance.failed"));
                return;
            }

            const result = payload.data || {};
            attendanceData = result.employees || [];
            const resolvedMonth = result.month;
            if (!filters.month && resolvedMonth) {
                monthFilter.value = resolvedMonth;
            }
            updatePagination(result);
            renderSummary();
        } catch (error) {
            attendanceData = [];
            setNoData(t("attendance.failed"));
        }
    }

    filters.month = getCurrentMonth();
    monthFilter.value = filters.month;
    loadAttendance();

    applyBtn.addEventListener("click", handleFilterApply);
    resetBtn.addEventListener("click", resetFilters);

    window.bindPagination(pagination, (value) => {
        if (!value) return;
        let nextPage = currentPage;
        if (value === "prev") {
            nextPage = Math.max(1, currentPage - 1);
        } else if (value === "next") {
            nextPage = Math.min(totalPages, currentPage + 1);
        } else {
            const parsed = parseInt(value, 10);
            if (Number.isFinite(parsed)) {
                nextPage = parsed;
            }
        }
        if (nextPage === currentPage) {
            return;
        }
        currentPage = nextPage;
        loadAttendance();
    });
</script>
</body>
</html>
