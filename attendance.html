<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="common.css">
    <link rel="stylesheet" href="components.css">
    <title>考勤管理</title>
</head>
<body class="c-form-page">
<div class="page">
    <section class="c-card">
        <div class="filters c-filter-panel">
            <div class="filter-grid c-filter-grid-wide">
                <label>
                    姓名
                    <input type="search" id="name-filter" placeholder="输入姓名" />
                </label>
                <label>
                    月份
                    <input type="month" id="month-filter" />
                </label>
            </div>
            <div class="filter-actions c-filter-actions-bar">
                <div class="filter-actions-left c-filter-actions-left"></div>
                <div class="filter-actions-right c-filter-actions-right c-filter-actions-group">
                    <button class="c-btn c-btn-primary" id="filter-apply" type="button">搜索</button>
                    <button class="c-btn c-btn-warn" id="filter-reset" type="button">重置</button>
                </div>
            </div>
        </div>
        <div class="table-wrapper c-table-wrapper">
            <table class="c-table c-table-hover c-table-center">
                <thead>
                <tr>
                    <th>姓名</th>
                    <th>月份</th>
                    <th>出勤日</th>
                    <th>缺勤日</th>
                    <th>剩余年休</th>
                    <th>状态</th>
                </tr>
                </thead>
                <tbody id="summary-body">
                </tbody>
            </table>
            <div id="no-data" class="c-empty hidden">暂无考勤数据</div>
        </div>
    </section>
</div>
<script src="common.js"></script>
<script>
    let attendanceData = [];

    const statusMap = {
        normal: { label: "正常", className: "c-pill c-pill-success" },
        alert: { label: "关注", className: "c-pill c-pill-warn" },
        warning: { label: "异常", className: "c-pill c-pill-danger" }
    };
    const summaryBody = document.getElementById("summary-body");
    const noData = document.getElementById("no-data");
    const nameFilter = document.getElementById("name-filter");
    const monthFilter = document.getElementById("month-filter");
    const applyBtn = document.getElementById("filter-apply");
    const resetBtn = document.getElementById("filter-reset");
    const filters = { name: "", month: "" };

    const createParams = (entries = []) => {
        const params = new URLSearchParams();
        entries.forEach(([key, value]) => {
            if (value) {
                params.set(key, value);
            }
        });
        return params;
    };

    const setDetailContent = (wrapper, title, content) => {
        wrapper.innerHTML = `
            <div class="c-panel-title">${title}</div>
            ${content}
        `;
    };

    const setDetailMessage = (wrapper, title, message) => {
        setDetailContent(wrapper, title, `<div class="c-empty">${message}</div>`);
    };

    const renderSummary = () => {
        summaryBody.innerHTML = "";

        if (!attendanceData.length) {
            setNoData("暂无考勤数据");
            return;
        }

        hideNoData();

        attendanceData.forEach((person) => {
            const summaryRow = document.createElement("tr");
            summaryRow.className = "summary-row";
            summaryRow.dataset.employeeId = person.employee_id;
            summaryRow.dataset.name = person.name;
            summaryRow.innerHTML = `
                <td>${person.name}</td>
                <td>${person.month}</td>
                <td>${person.attendance_days}</td>
                <td>${person.absence_days}</td>
                <td>${person.annual_leave}</td>
                <td>
                    <span class="${statusMap[person.status]?.className || "c-pill"}">
                        ${statusMap[person.status]?.label || "未知"}
                    </span>
                </td>
            `;

            const detailRow = document.createElement("tr");
            detailRow.className = "detail-row";
            detailRow.style.display = "none";
            detailRow.innerHTML = `
                <td colspan="6">
                    <div class="c-card-compact" data-detail-wrapper>
                        <div class="c-panel-title">${person.name} 的每日考勤</div>
                        ${renderDetailTable([])}
                    </div>
                </td>
            `;

            summaryBody.appendChild(summaryRow);
            summaryBody.appendChild(detailRow);
        });

        attachRowEvents();
    }

    const renderDetailTable = (details = []) => {
        if (!details.length) {
            return `<div class="c-empty">暂未录入该员工的考勤明细</div>`;
        }

        const rows = details.map(
            item => `
                <tr>
                    <td>${item.date}</td>
                    <td>${item.day}</td>
                    <td>${item.clock_in}</td>
                    <td>${item.clock_out}</td>
                    <td>${item.note || "-"}</td>
                </tr>
            `
        ).join("");

        return `
            <table class="c-table c-table-compact c-table-center">
                <thead>
                    <tr>
                        <th>日期</th>
                        <th>星期</th>
                        <th>上班打卡</th>
                        <th>下班打卡</th>
                        <th>备注</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        `;
    }

    const handleRowToggle = async (event) => {
        const row = event.currentTarget;
        const detailRow = row.nextElementSibling;

        const isActive = row.classList.contains("active");
        document.querySelectorAll(".summary-row").forEach(r => r.classList.remove("active"));
        document.querySelectorAll(".detail-row").forEach(r => r.style.display = "none");

        if (!isActive) {
            row.classList.add("active");
            detailRow.style.display = "table-row";
            await loadDetail(row.dataset.employeeId, detailRow);
        }
    }

    const loadDetail = async (employeeId, detailRow) => {
        const params = createParams([
            ["month", filters.month]
        ]);
        const url = buildUrl(`/api/attendance/${employeeId}/detail`, params);
        const wrapper = detailRow.querySelector("[data-detail-wrapper]");
        if (!wrapper) {
            return;
        }

        setDetailMessage(wrapper, "加载中...", "正在获取考勤明细");

        try {
            const response = await fetchWithAuth(url, { method: "GET" });
            const data = await response.json();
            const payload = normalizeApiResponse(data);
            if (!response.ok || !payload.success) {
                setDetailMessage(wrapper, "明细加载失败", payload.message || "请稍后重试");
                return;
            }

            const result = payload.data || {};
            const name = result.employee?.name || detailRow.previousElementSibling?.dataset.name || "";
            const details = result.details || [];
            setDetailContent(wrapper, `${name} 的每日考勤`, renderDetailTable(details));
        } catch (error) {
            setDetailMessage(wrapper, "明细加载失败", "请稍后重试");
        }
    }

    const attachRowEvents = () => {
        summaryBody.querySelectorAll(".summary-row").forEach(row => {
            row.addEventListener("click", handleRowToggle);
        });
    }

    const handleFilterApply = () => {
        filters.name = nameFilter.value;
        filters.month = monthFilter.value;
        loadAttendance();
    }

    const resetFilters = () => {
        filters.name = "";
        filters.month = getCurrentMonth();
        nameFilter.value = "";
        monthFilter.value = filters.month;
        loadAttendance();
    }

    const getCurrentMonth = () => {
        const today = new Date();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        return `${today.getFullYear()}-${month}`;
    }

    const setNoData = (message) => {
        noData.textContent = message || "暂无考勤数据";
        noData.classList.remove("hidden");
    }

    const hideNoData = () => {
        noData.classList.add("hidden");
    }

    const loadAttendance = async () => {
        const params = createParams([
            ["name", filters.name],
            ["month", filters.month]
        ]);
        const url = buildUrl("/api/attendance/summary", params);
        summaryBody.innerHTML = "";
        setNoData("正在加载考勤数据...");

        try {
            const response = await fetchWithAuth(url, { method: "GET" });
            const data = await response.json();
            const payload = normalizeApiResponse(data);
            if (!response.ok || !payload.success) {
                attendanceData = [];
                setNoData(payload.message || "加载考勤数据失败");
                return;
            }

            const result = payload.data || {};
            attendanceData = result.employees || [];
            const resolvedMonth = result.month;
            if (!filters.month && resolvedMonth) {
                monthFilter.value = resolvedMonth;
            }
            renderSummary();
        } catch (error) {
            attendanceData = [];
            setNoData("加载考勤数据失败");
        }
    }

    filters.month = getCurrentMonth();
    monthFilter.value = filters.month;
    loadAttendance();

    applyBtn.addEventListener("click", handleFilterApply);
    resetBtn.addEventListener("click", resetFilters);
</script>
</body>
</html>
