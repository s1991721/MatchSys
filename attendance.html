<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="common.css">
  <link rel="stylesheet" href="components.css">
  <title>考勤管理</title>
    <style>
* {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "PingFang SC", -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .page {
            padding: 24px;
        }
        .hint {
            margin: 0 0 18px;
            color: var(--muted);
            font-size: 14px;
        }

tbody tr.summary-row {
            cursor: pointer;
        }

        tbody tr.summary-row:hover {
            background: var(--accent);
        }

        tbody tr.summary-row.active {
            background: rgba(36, 107, 253, 0.12);
        }

        .status-badge {
            display: inline-flex;
            min-width: 62px;
            justify-content: center;
            font-size: 12px;
            border-radius: 999px;
            padding: 2px 10px;
            color: #fff;
        }

        .status-normal {
            background: #00c48c;
        }

        .status-alert {
            background: #ff9f43;
        }

        .status-warning {
            background: #ff5f5f;
        }

        .detail-row {
            background: #f9faff;
        }

        .detail-wrapper {
            padding: 8px 0 16px 0;
        }

        .detail-header {
            font-weight: 600;
            margin: 6px 0 12px;
        }

        .detail-
.detail-table
.detail-table
.no-data {
            color: var(--muted);
            font-size: 14px;
            text-align: center;
            padding: 20px;
        }
  </style>
</head>
<body>
<div class="page">
    <div class="c-card">
        <h3 class="title c-title-bar c-title-bar-lg">考勤管理</h3>
        <p class="hint">单击人员行展示其每日打卡明细。</p>
        <div class="filters c-filter-row">
            <div class="filter-field c-filter-field">
                <label for="name-filter">姓名</label>
                <input type="text" id="name-filter" placeholder="输入姓名" />
            </div>
            <div class="filter-field c-filter-field">
                <label for="month-filter">月份</label>
                <input type="month" id="month-filter" />
            </div>
            <div class="filter-actions c-filter-actions">
                <button class="c-btn c-btn-primary" id="filter-apply" type="button">筛选</button>
                <button class="c-btn c-btn-ghost" id="filter-reset" type="button">重置</button>
            </div>
        </div>
        <div class="table-wrapper">
            <table class="c-table">
                <thead>
                <tr>
                    <th>姓名</th>
                    <th>月份</th>
                    <th>出勤日</th>
                    <th>欠勤日</th>
                    <th>剩余年休</th>
                    <th>状态</th>
                </tr>
                </thead>
                <tbody id="summary-body">
                </tbody>
            </table>
            <div id="no-data" class="no-data" style="display: none;">暂无考勤数据</div>
        </div>
    </div>
</div>
<script src="common.js"></script>
<script>
    let attendanceData = [];

    const statusMap = {
        normal: { label: "正常", className: "status-normal" },
        alert: { label: "关注", className: "status-alert" },
        warning: { label: "异常", className: "status-warning" }
    };
    const summaryBody = document.getElementById("summary-body");
    const noData = document.getElementById("no-data");
    const nameFilter = document.getElementById("name-filter");
    const monthFilter = document.getElementById("month-filter");
    const applyBtn = document.getElementById("filter-apply");
    const resetBtn = document.getElementById("filter-reset");
    const filters = { name: "", month: "" };

    function renderSummary() {
        summaryBody.innerHTML = "";

        if (!attendanceData.length) {
            noData.style.display = "block";
            return;
        }

        noData.style.display = "none";

        attendanceData.forEach((person, index) => {
            const summaryRow = document.createElement("tr");
            summaryRow.className = "summary-row";
            summaryRow.dataset.index = index;
            summaryRow.dataset.employeeId = person.employee_id;
            summaryRow.innerHTML = `
                <td>${person.name}</td>
                <td>${person.month}</td>
                <td>${person.attendance_days}</td>
                <td>${person.absence_days}</td>
                <td>${person.annual_leave}</td>
                <td>
                    <span class="status-badge ${statusMap[person.status]?.className ||""}">
                        ${statusMap[person.status]?.label || "未知"}
                    </span>
                </td>
            `;

            const detailRow = document.createElement("tr");
            detailRow.className = "detail-row";
            detailRow.style.display = "none";
            detailRow.innerHTML = `
                <td colspan="6">
                    <div class="detail-wrapper">
                        <div class="detail-header">${person.name} 的每日考勤</div>
                        ${renderDetailTable([])}
                    </div>
                </td>
            `;

            summaryBody.appendChild(summaryRow);
            summaryBody.appendChild(detailRow);
        });

        attachRowEvents();
    }

    function renderDetailTable(details = []) {
        if (!details.length) {
            return `<div class="no-data">暂未录入该员工的考勤明细</div>`;
        }

        const rows = details.map(
            item => `
                <tr>
                    <td>${item.date}</td>
                    <td>${item.day}</td>
                    <td>${item.clock_in}</td>
                    <td>${item.clock_out}</td>
                    <td>${item.note || "-"}</td>
                </tr>
            `
        ).join("");

        return `
            <table class="detail-table c-table">
                <thead>
                    <tr>
                        <th>日期</th>
                        <th>星期</th>
                        <th>上班打卡</th>
                        <th>下班打卡</th>
                        <th>备注</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        `;
    }

    async function handleRowToggle(event) {
        const row = event.currentTarget;
        const index = row.dataset.index;
        const detailRow = row.nextElementSibling;

        const isActive = row.classList.contains("active");
        document.querySelectorAll(".summary-row").forEach(r => r.classList.remove("active"));
        document.querySelectorAll(".detail-row").forEach(r => r.style.display = "none");

        if (!isActive) {
            row.classList.add("active");
            detailRow.style.display = "table-row";
            await loadDetail(row.dataset.employeeId, detailRow, index);
        }
    }

    async function loadDetail(employeeId, detailRow, index) {
        const params = new URLSearchParams();
        if (filters.month) {
            params.set("month", filters.month);
        }

        const url = params.toString()
            ? `/api/attendance/${employeeId}/detail?${params.toString()}`
            : `/api/attendance/${employeeId}/detail`;

        const wrapper = detailRow.querySelector(".detail-wrapper");
        if (!wrapper) {
            return;
        }

        wrapper.innerHTML = `
            <div class="detail-header">加载中...</div>
            <div class="no-data">正在获取考勤明细</div>
        `;

        try {
            const response = await fetch(url, { credentials: "same-origin" });
            const data = await response.json();
            const payload = normalizeApiResponse(data);
            if (!response.ok || !payload.success) {
                wrapper.innerHTML = `
                    <div class="detail-header">明细加载失败</div>
                    <div class="no-data">${payload.message || "请稍后重试"}</div>
                `;
                return;
            }

            const result = payload.data || {};
            const name = result.employee?.name || attendanceData[index]?.name || "";
            const details = result.details || [];
            wrapper.innerHTML = `
                <div class="detail-header">${name} 的每日考勤</div>
                ${renderDetailTable(details)}
            `;
        } catch (error) {
            wrapper.innerHTML = `
                <div class="detail-header">明细加载失败</div>
                <div class="no-data">请稍后重试</div>
            `;
        }
    }

    function attachRowEvents() {
        summaryBody.querySelectorAll(".summary-row").forEach(row => {
            row.addEventListener("click", handleRowToggle);
        });
    }

    function handleFilterApply() {
        filters.name = nameFilter.value;
        filters.month = monthFilter.value;
        loadAttendance();
    }

    function resetFilters() {
        filters.name = "";
        filters.month = getCurrentMonth();
        nameFilter.value = "";
        monthFilter.value = filters.month;
        loadAttendance();
    }

    function getCurrentMonth() {
        const today = new Date();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        return `${today.getFullYear()}-${month}`;
    }

    function setNoData(message) {
        noData.textContent = message || "暂无考勤数据";
        noData.style.display = "block";
    }

    async function loadAttendance() {
        const params = new URLSearchParams();
        if (filters.name) {
            params.set("name", filters.name);
        }
        if (filters.month) {
            params.set("month", filters.month);
        }

        const url = params.toString()
            ? `/api/attendance/summary?${params.toString()}`
            : "/api/attendance/summary";

        summaryBody.innerHTML = "";
        setNoData("正在加载考勤数据...");

        try {
            const response = await fetch(url, { credentials: "same-origin" });
            const data = await response.json();
            const payload = normalizeApiResponse(data);
            if (!response.ok || !payload.success) {
                attendanceData = [];
                setNoData(payload.message || "加载考勤数据失败");
                return;
            }

            const result = payload.data || {};
            attendanceData = result.employees || [];
            const resolvedMonth = result.month;
            if (!filters.month && resolvedMonth) {
                monthFilter.value = resolvedMonth;
            }
            renderSummary();
        } catch (error) {
            attendanceData = [];
            setNoData("加载考勤数据失败");
        }
    }

    filters.month = getCurrentMonth();
    monthFilter.value = filters.month;
    loadAttendance();

    applyBtn.addEventListener("click", handleFilterApply);
    resetBtn.addEventListener("click", resetFilters);
</script>
</body>
</html>
