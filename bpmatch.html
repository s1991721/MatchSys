<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="/favicon-32.png" type="image/png" sizes="32x32">
    <link rel="stylesheet" href="common.css">
    <link rel="stylesheet" href="components.css">
    <title data-i18n="match.title">Match</title>
</head>
<body>
<div class="page page-wide c-stack match-page">
    <!-- 上半部分：列表 -->
    <div class="c-split-grid-wide">
        <div class="panel-left c-card c-card-pad">
            <div class="panel-title c-panel-title" data-i18n="match.jobs">案件列表</div>
            <div class="filters c-filter-grid">
                <div class="filter-group c-filter-group">
                    <span class="filter-label c-filter-label" data-i18n="match.time">时间</span>
                    <div class="chip-row c-chip-row">
                        <button class="chip c-chip" data-range="all" type="button" data-i18n="match.range.all">全部
                        </button>
                        <button class="chip c-chip" data-range="yesterday" type="button"
                                data-i18n="match.range.yesterday">昨天
                        </button>
                        <button class="chip c-chip active" data-range="today" type="button"
                                data-i18n="match.range.today">今天
                        </button>
                    </div>
                </div>
                <div class="filter-group c-filter-group sender-group">
                    <span class="filter-label c-filter-label" data-i18n="match.sender">发件人</span>
                    <div class="search-row">
                        <input id="job-sender" class="input c-input search-input" type="search" placeholder="搜索发件人"
                               data-i18n-placeholder="match.sender_placeholder">
                        <button class="c-btn c-btn-primary" type="button" id="job-search-btn" data-i18n="common.search">
                            搜索
                        </button>
                    </div>
                </div>
            </div>
            <ul class="list c-list c-list-spaced match-list jobs" id="job-list">
            </ul>
            <div class="pagination c-pagination" id="job-pagination">
                <div class="pagination-summary">
                    <span id="page-summary">第 1 页</span>
                </div>
                <div class="pagination-pages" id="job-pagination-pages"></div>
            </div>
        </div>

        <div class="panel-right c-card c-card-pad">
            <div class="panel-title c-panel-title">
                <span data-i18n="match.people">技术者列表</span>
            </div>
            <ul class="list c-list c-list-spaced match-list persons" id="person-list">
            </ul>
        </div>
    </div>

    <!-- 下半部分：详情 -->
    <div class="c-split-grid-wide">
        <div class="panel-left c-card c-card-pad">
            <div class="panel-title" data-i18n="match.job_detail">求人详情</div>
            <div class="detail detail-text" id="job-detail">
                这是求人1的详细说明……ABCDEFG1234567890不想超出屏幕想自动换行。
            </div>
            <div class="detail-actions-left">
                <button class="c-btn c-btn-secondary" type="button" id="time-save-btn">测试</button>
            </div>
        </div>

        <div class="panel-right c-card c-card-pad">
            <div class="panel-title" data-i18n="match.person_detail">技术者详情</div>
            <div class="detail detail-text" id="person-detail">
                这是技术者A的详细信息……ABCDEFG1234567890不想超出屏幕想自动换行。
            </div>
            <div class="detail-actions">
                <button class="c-btn c-btn-primary" type="button" id="send-btn" data-i18n="match.send">
                    送信
                </button>
            </div>
        </div>
    </div>
</div>

<script src="i18n.js"></script>
<script src="common.js"></script>
<script>
    const i18n = window.I18N;
    if (i18n) {
        i18n.init();
        i18n.apply();
    }
    const t = (key) => (i18n ? i18n.t(key) : key);
    const format = (key, vars) => (i18n ? i18n.format(key, vars) : key);

    const sanitize = (str = '') =>
        str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');

    const escapeRegExp = (str = '') => str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

    const stripCssNoise = (text = '') => {
        if (!text) return '';
        const firstGap = text.indexOf('\n\n');
        const hasBraces = text.slice(0, Math.max(firstGap, 120)).includes('{');
        if (firstGap >= 0 && hasBraces) {
            return text.slice(firstGap + 2);
        }
        return text;
    };

    const renderDetail = (target, text = '', highlights = []) => {
        if (!target) return;
        const cleaned = stripCssNoise(text || '');
        const masked = cleaned;
        const normalized = masked
            .replace(/\r\n/g, '\n')
            .replace(/\n{3,}/g, '\n\n')
            .trim();
        const escapedHighlights = (Array.isArray(highlights) ? highlights : [])
            .filter(Boolean)
            .map(v => sanitize(String(v)))
            .map(escapeRegExp);
        const highlightRegex = escapedHighlights.length
            ? new RegExp(`(${escapedHighlights.join('|')})`, 'gi')
            : null;
        const applyHighlight = (val) =>
            highlightRegex ? val.replace(highlightRegex, '<mark class="skill-highlight">$1</mark>') : val;

        const html = sanitize(normalized)
            .split(/\n{2,}/)
            .filter(Boolean)
            .map(block => `<p>${applyHighlight(block.replace(/\n/g, '<br>'))}</p>`)
            .join('');
        target.innerHTML = html || `<p style="color:#9aa4b5">${t("match.empty")}</p>`;
    }

    const jobList = document.getElementById('job-list');
    const jobDetail = document.getElementById('job-detail');
    const personDetail = document.getElementById('person-detail');
    const personList = document.getElementById('person-list');
    const jobSender = document.getElementById('job-sender');
    const jobSearchBtn = document.getElementById('job-search-btn');
    const timeSaveBtn = document.getElementById('time-save-btn');
    const dateButtons = Array.from(document.querySelectorAll('.chip[data-range]'));
    const pagination = document.getElementById('job-pagination');
    const paginationPages = document.getElementById('job-pagination-pages');
    const pageSummary = document.getElementById('page-summary');
    const sendBtn = document.getElementById('send-btn');

    let activeJobDetail = '';
    let activeMatchedSkills = [];

    let currentPage = 1;
    let hasNextPage = false;
    let totalPages = 1;
    let totalCount = 0;

    const filters = {
        range: 'today'
    };

    // 公共函数：给列表加点击事件
    const bindListClick = (listId, detailId, onSelect) => {
        const list = document.getElementById(listId);
        const detail = document.getElementById(detailId);

        if (!list || !detail) return;

        list.addEventListener('click', function (e) {
            const item = e.target.closest('.item');
            if (!item) return;

            list.querySelectorAll('.item').forEach(li => li.classList.remove('active'));
            item.classList.add('active');

            const text = item.getAttribute('data-detail') || '';
            const highlights = readMatchedSkills(item);
            renderDetail(detail, text, highlights);

            if (typeof onSelect === 'function') {
                try {
                    onSelect(item, highlights);
                } catch (err) {
                    console.error('handleSelect failed', err);
                }
            }
        });
    }

    const readMatchedSkills = (item) => {
        const raw = item?.dataset?.matchedSkills;
        if (!raw) return [];
        try {
            const parsed = JSON.parse(raw);
            return Array.isArray(parsed) ? parsed.map((v) => String(v)) : [];
        } catch {
            return [];
        }
    };

    const renderJobList = (items) => {
        jobList.innerHTML = '';
        activeMatchedSkills = [];

        if (!items.length) {
            const empty = document.createElement('li');
            empty.className = 'empty';
            empty.textContent = t("match.empty_jobs");
            jobList.appendChild(empty);
            renderDetail(jobDetail, t("match.empty_job_detail"));
            activeJobDetail = '';
            return;
        }

        items.forEach((item) => {
            const li = document.createElement('li');
            li.className = 'item';
            const detail = item.detail || '';
            const id = item.id || '';
            li.dataset.detail = detail;
            li.dataset.id = id;
            li.dataset.item = JSON.stringify({...item, detail, id});

            const main = document.createElement('div');
            main.className = 'item-main';

            const title = document.createElement('div');
            title.className = 'item-title';
            title.textContent = item.title;

            const desc = document.createElement('div');
            desc.className = 'item-desc';
            desc.textContent = item.desc;

            const time = document.createElement('div');
            time.className = 'item-time';
            time.textContent = formatDisplayDate(item.date);

            main.appendChild(title);
            main.appendChild(desc);
            li.appendChild(main);
            li.appendChild(time);
            jobList.appendChild(li);
        });

        activeJobDetail = '';
        renderDetail(jobDetail, t("match.empty_job_detail"));
    }

    const renderPersonList = (items) => {
        if (!personList) return;
        personList.innerHTML = '';
        activeMatchedSkills = [];

        if (!items.length) {
            const empty = document.createElement('li');
            empty.className = 'empty';
            empty.textContent = t("match.empty_people");
            personList.appendChild(empty);
            renderDetail(personDetail, t("match.empty_person_detail"));
            renderDetail(jobDetail, activeJobDetail, activeMatchedSkills);
            return;
        }

        items.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'item' + (index === 0 ? ' active' : '');
            const detail = item.body || '';
            li.dataset.detail = detail;
            li.dataset.id = item.id || '';
            li.dataset.matchedSkills = JSON.stringify(item.matched_skills || []);
            li.dataset.item = JSON.stringify({...item, detail});

            const header = document.createElement('div');
            header.className = 'person-header';

            const name = document.createElement('span');
            name.className = 'person-name';
            name.textContent = item.title || t("match.untitled");

            const meta = document.createElement('div');
            meta.className = 'person-meta';

            const belong = document.createElement('span');
            belong.className = 'person-belong';
            belong.textContent = item.belong || item.from || '';

            const time = document.createElement('span');
            time.className = 'person-time';
            time.textContent = formatDisplayDate(item.date);

            meta.appendChild(belong);
            meta.appendChild(time);

            header.appendChild(name);
            header.appendChild(meta);
            li.appendChild(header);
            personList.appendChild(li);
        });

        const first = personList.querySelector('.item');
        if (first) {
            const firstDetail = first.dataset.detail || '';
            const initialHighlights = readMatchedSkills(first);
            activeMatchedSkills = initialHighlights;
            renderDetail(personDetail, firstDetail, initialHighlights);
            renderDetail(jobDetail, activeJobDetail, initialHighlights);
        }
    }

    const formatDisplayDate = (raw) => {
        const d = raw ? new Date(raw) : null;
        if (!d || Number.isNaN(d.getTime())) return raw || '';
        const pad = (n) => String(n).padStart(2, '0');
        return `${d.getMonth() + 1}月${d.getDate()}日 ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    const currentFilterDate = () => {
        const today = formatDate(new Date());
        const yesterdayDate = new Date();
        yesterdayDate.setDate(yesterdayDate.getDate() - 1);
        const yesterday = formatDate(yesterdayDate);

        return filters.range === 'today'
            ? today
            : filters.range === 'yesterday'
                ? yesterday
                : '';
    }

    const updatePaginationUI = () => {
        if (pageSummary) {
            pageSummary.textContent = format("match.page_summary", {
                count: totalCount,
                page: currentPage,
                total: totalPages
            });
        }
        if (pagination && window.renderPagination) {
            window.renderPagination(pagination, paginationPages, currentPage, totalPages);
        }
    }

    const showLoading = (message = t("match.loading")) => {
        jobList.innerHTML = '';
        const loading = document.createElement('li');
        loading.className = 'empty';
        loading.textContent = message;
        jobList.appendChild(loading);
        hasNextPage = false;
        updatePaginationUI();
    }

    const fetchJobs = async (page = 1) => {
        currentPage = page;
        const params = new URLSearchParams();
        const sender = jobSender ? jobSender.value.trim() : '';
        const targetDate = currentFilterDate();

        if (sender) params.set('sender', sender);
        if (targetDate) params.set('date', targetDate);
        params.set('page', String(currentPage));
        params.set('page_size', String(50));

        const url = `/api/mail-projects${params.toString() ? `?${params}` : ''}`;
        showLoading(t("match.loading_jobs"));

        try {
            const res = await fetchWithAuth(url, {method: 'GET'});
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }
            const data = await res.json();
            const payload = normalizeApiResponse(data);
            if (!payload.success) {
                throw new Error(payload.message || t("match.failed"));
            }
            const result = payload.data || {};
            const meta = payload.meta || {};
            currentPage = Number.isFinite(meta.page) ? meta.page : currentPage;
            totalCount = Number.isFinite(meta.total) ? meta.total : totalCount;
            totalPages = Number.isFinite(meta.total_pages) ? meta.total_pages : totalPages;
            hasNextPage = currentPage < totalPages;
            renderJobList(result.items || []);
            updatePaginationUI();
        } catch (err) {
            jobList.innerHTML = '';
            const errorLi = document.createElement('li');
            errorLi.className = 'empty';
            errorLi.textContent = `${t("match.failed")}：${err.message}`;
            jobList.appendChild(errorLi);
            jobDetail.textContent = t("match.empty_job_detail");
            hasNextPage = false;
            totalPages = currentPage;
            updatePaginationUI();
        }
    }

    const setPersonLoading = (message = t("match.loading_match")) => {
        if (!personList) return;
        personList.innerHTML = '';
        const loading = document.createElement('li');
        loading.className = 'empty';
        loading.innerHTML = `<span class="loading-row"><span class="spinner" aria-hidden="true"></span>${sanitize(message)}</span>`;
        personList.appendChild(loading);
    }

    dateButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            dateButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            filters.range = btn.dataset.range;
            fetchJobs(1);
        });
    });

    jobSearchBtn.addEventListener('click', () => {
        fetchJobs(1);
    });


    window.bindPagination(pagination, (value) => {
        if (value === 'prev') {
            if (currentPage > 1) fetchJobs(currentPage - 1);
            return;
        }
        if (value === 'next') {
            if (hasNextPage) fetchJobs(currentPage + 1);
            return;
        }
        const page = Number(value);
        if (Number.isFinite(page) && page >= 1 && page !== currentPage) {
            fetchJobs(page);
        }
    });


    timeSaveBtn.addEventListener('click', async () => {
        try {
            const res = await fetchWithAuth('/api/time-to-save');
            const data = await res.json();
            const payload = normalizeApiResponse(data);
            if (!payload.success) {
                throw new Error(payload.message || t("match.failed"));
            }
            alert('已触发');
        } catch (err) {
            alert(`${t("match.failed")}：${err.message}`);
        }
    });


    // 先把静态文案按新格式渲染，再绑定事件和拉取接口
    renderDetail(jobDetail, jobDetail.textContent.trim());
    renderDetail(personDetail, personDetail.textContent.trim());

    fetchJobs(1);
    bindListClick('job-list', 'job-detail', async (item) => {
        activeJobDetail = item.getAttribute('data-detail') || '';
        activeMatchedSkills = [];
        renderDetail(jobDetail, activeJobDetail, activeMatchedSkills);
        const raw = item?.dataset?.item || '{}';
        let payload;
        try {
            payload = JSON.parse(raw);
        } catch {
            payload = {};
        }
        setPersonLoading(t("match.loading_match"));
        try {
            const projectId = payload?.id || '';
            const url = `/api/mail-projects/match?id=${encodeURIComponent(projectId)}`;
            const res = await fetchWithAuth(url, {method: 'GET'});
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }
            const data = await res.json();
            const responsePayload = normalizeApiResponse(data);
            if (!responsePayload.success) {
                throw new Error(responsePayload.message || t("match.match_failed"));
            }
            const result = responsePayload.data || {};
            const rawMatches = (result && result.matches) || [];
            const matchItems = Array.isArray(rawMatches)
                ? rawMatches
                : typeof rawMatches === 'object' && rawMatches !== null
                    ? Object.values(rawMatches)
                    : [];

            renderPersonList(matchItems);
        } catch (err) {
            console.error('上报点击事件失败', err);
            if (personList) {
                personList.innerHTML = '';
                const errorLi = document.createElement('li');
                errorLi.className = 'empty';
                errorLi.textContent = `${t("match.match_failed")}：${err.message}`;
                personList.appendChild(errorLi);
                renderDetail(personDetail, t("match.empty_person_detail"));
            }
        }
    });
    bindListClick('person-list', 'person-detail', (item, highlights) => {
        activeMatchedSkills = highlights || [];
        renderDetail(jobDetail, activeJobDetail, activeMatchedSkills);
    });

    // 将当前选中的求人与人员信息存入本地并跳转到送信页

    sendBtn.addEventListener('click', () => {
        const activeJob = jobList?.querySelector('.item.active');
        const activePerson = personList?.querySelector('.item.active');

        if (!activeJob || !activePerson) {
            alert(t("match.send_tip"));
            return;
        }

        const parseDatasetJSON = (el, key) => {
            if (!el || !el.dataset) return null;
            const raw = el.dataset[key];
            if (!raw) return null;
            try {
                return JSON.parse(raw);
            } catch {
                return null;
            }
        };

        const jobData = parseDatasetJSON(activeJob, 'item') || {};
        const personData = parseDatasetJSON(activePerson, 'item') || {};

        const jobPayload = {
            id: jobData.id || activeJob.dataset.id || '',
            title: jobData.title || activeJob.querySelector('.item-title')?.textContent.trim() || '',
            desc: jobData.desc || activeJob.querySelector('.item-desc')?.textContent.trim() || '',
            detail: jobData.detail || activeJob.dataset.detail || '',
            time: jobData.date || activeJob.querySelector('.item-time')?.textContent.trim() || ''
        };

        const personPayload = {
            id: personData.id || activePerson.dataset.id || '',
            name: personData.title || activePerson.querySelector('.person-name')?.textContent.trim() || '',
            belong: personData.from || activePerson.querySelector('.person-belong')?.textContent.trim() || '',
            detail: personData.body || activePerson.dataset.detail || '',
            time: personData.date || activePerson.querySelector('.person-time')?.textContent.trim() || ''
        };

        const payload = {
            job: jobPayload,
            person: personPayload,
            mail_type: 0,
            updatedAt: Date.now()
        };

        try {
            localStorage.setItem('matchSelection', JSON.stringify(payload));
        } catch (err) {
            console.error(t("match.cache_failed"), err);
        }

        window.location.href = 'songxin.html?from=match';
    });

</script>
</body>
</html>
