<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/favicon-32.png" type="image/png" sizes="32x32">
  <link rel="stylesheet" href="common.css">
  <link rel="stylesheet" href="components.css">
  <title data-i18n="app.title">ITè¥ä¸šç®¡ç†ç³»ç»Ÿ</title>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <div class="brand-left">
          <div class="logo">
            <img src="/favicon.png" alt="ç³»ç»Ÿå›¾æ ‡" class="logo-img">
          </div>
          <div class="brand-text">
            <h1 data-i18n="app.title">ITè¥ä¸šç®¡ç†ç³»ç»Ÿ</h1>
            <small>BMS</small>
          </div>
        </div>
      </div>

      <ul class="nav" id="nav">
        <li class="nav-item">
          <a class="active" href="#home.html" data-src="home.html" data-title="ä¸»é¡µ" title="ä¸»é¡µ" data-i18n-title="nav.home">
            <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M12 3 3 10.2V21h6v-6h6v6h6V10.2L12 3zm7 16h-2v-6H7v6H5v-8.1l7-5.4 7 5.4V19z"/>
            </svg>
            <span class="nav-label" data-i18n="nav.home">ä¸»é¡µ</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="#match.html" data-src="match.html" data-title="BP Match" title="BP Match" data-i18n-title="nav.match">
            <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M7 4h10a2 2 0 0 1 2 2v3H5V6a2 2 0 0 1 2-2zm-2 7h14v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7zm4 2v2h6v-2H9z"/>
            </svg>
            <span class="nav-label" data-i18n="nav.match">BP Match</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="#qiuanjian.html" data-src="qiuanjian.html" data-title="ç¤¾å†…match" title="ç¤¾å†…match" data-i18n-title="nav.internal_match">
            <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M5 5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v5h-2V5H7v14h10v-5h2v5a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5zm5 6h7v2h-7v-2zm0 4h7v2h-7v-2zM5 9h6v2H5V9z"/>
            </svg>
            <span class="nav-label" data-i18n="nav.internal_match">ç¤¾å†… Match</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="#songxinhistory.html" data-src="songxinhistory.html" data-title="é€ä¿¡å†å²" title="é€ä¿¡å†å²" data-i18n-title="nav.send_history">
            <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M12 8a1 1 0 0 1 1 1v3.6l2.4 1.4a1 1 0 1 1-1 1.7l-3-1.8A1 1 0 0 1 11 13V9a1 1 0 0 1 1-1zm0-6a10 10 0 1 1-7.1 17.1 1 1 0 1 1 1.4-1.4A8 8 0 1 0 12 4a7.9 7.9 0 0 0-5.4 2.1H9a1 1 0 0 1 0 2H3V2a1 1 0 1 1 2 0v2.6A9.9 9.9 0 0 1 12 2z"/>
            </svg>
            <span class="nav-label" data-i18n="nav.send_history">é€ä¿¡å†å²</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="#people.html" data-src="people.html" data-title="æŠ€æœ¯è€…ç®¡ç†" title="æŠ€æœ¯è€…ç®¡ç†" data-i18n-title="nav.people">
            <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4zm0 2c-4.4 0-8 2.2-8 5v1h16v-1c0-2.8-3.6-5-8-5z"/>
            </svg>
            <span class="nav-label" data-i18n="nav.people">æŠ€æœ¯è€…ç®¡ç†</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="#personnel.html" data-src="personnel.html" data-title="ç¤¾å†…äººå‘˜ç®¡ç†" title="ç¤¾å†…äººå‘˜ç®¡ç†" data-i18n-title="nav.personnel">
            <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M16 11c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h10v-2.5C14 14.17 9.33 13 8 13zm8 0c-.29 0-.62.02-.97.06 1.16.83 1.97 1.96 1.97 3.44V19h6v-1.5c0-2.33-4.67-3.5-7-3.5z"/>
            </svg>
            <span class="nav-label" data-i18n="nav.personnel">ç¤¾å†…äººå‘˜ç®¡ç†</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="#attendance.html" data-src="attendance.html" data-title="è€ƒå‹¤ç®¡ç†" title="è€ƒå‹¤ç®¡ç†" data-i18n-title="nav.attendance">
            <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1a3 3 0 0 1 3 3v13a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3h1V3a1 1 0 0 1 1-1zm14 8H3v10a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1V10zM5 6a1 1 0 0 0-1 1v1h16V7a1 1 0 0 0-1-1H5zm6 6h2v2h-2v-2zm-4 0h2v2H7v-2zm8 0h2v2h-2v-2z"/>
            </svg>
            <span class="nav-label" data-i18n="nav.attendance">è€ƒå‹¤ç®¡ç†</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="#myattendance.html" data-src="myattendance.html" data-title="æˆ‘çš„è€ƒå‹¤" title="æˆ‘çš„è€ƒå‹¤" data-i18n-title="nav.my_attendance">
            <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1a3 3 0 0 1 3 3v6h-2V9H4v11a1 1 0 0 0 1 1h7v2H5a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3h1V3a1 1 0 0 1 1-1zm14 11.5l-4.2 4.2-2.3-2.3 1.4-1.4.9.9 2.8-2.8 1.4 1.4z"/>
            </svg>
            <span class="nav-label" data-i18n="nav.my_attendance">æˆ‘çš„è€ƒå‹¤</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="#notification.html" data-src="notification.html" data-title="é€šçŸ¥ç®¡ç†" title="é€šçŸ¥ç®¡ç†" data-i18n-title="nav.notification">
            <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M12 22a2.5 2.5 0 0 0 2.5-2.5h-5A2.5 2.5 0 0 0 12 22zm7-5.5H5c-.6 0-1-.4-1-1 0-.4.2-.7.5-.9l1.5-1V10a6 6 0 0 1 5-5.9V3a1 1 0 1 1 2 0v1.1A6 6 0 0 1 18 10v3.6l1.5 1c.3.2.5.5.5.9 0 .6-.4 1-1 1z"/>
            </svg>
            <span class="nav-label" data-i18n="nav.notification">é€šçŸ¥ç®¡ç†</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="#order.html" data-src="order.html" data-title="æ³¨æ–‡ä¹¦ç®¡ç†" title="æ³¨æ–‡ä¹¦ç®¡ç†" data-i18n-title="nav.order">
            <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M6 2h8l4 4v16a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm7 1.5V7h3.5L13 3.5zM8 11h8v2H8v-2zm0 4h8v2H8v-2z"/>
            </svg>
            <span class="nav-label" data-i18n="nav.order">æ³¨æ–‡ä¹¦ç®¡ç†</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="#pay_request.html" data-src="pay_request.html" data-title="è¯·æ±‚ä¹¦ç®¡ç†" title="è¯·æ±‚ä¹¦ç®¡ç†" data-i18n-title="nav.pay_request">
            <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M9 2h6a2 2 0 0 1 2 2h2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4h2a2 2 0 0 1 2-2zm0 4h6V4H9v2zm-1 6h8v2H8v-2zm0 4h6v2H8v-2z"/>
            </svg>
            <span class="nav-label" data-i18n="nav.pay_request">è¯·æ±‚ä¹¦ç®¡ç†</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="#permission.html" data-src="permission.html" data-title="æƒé™ç®¡ç†" title="æƒé™ç®¡ç†" data-i18n-title="nav.permission">
            <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M12 2 4 5v6c0 5 3.4 9.6 8 11 4.6-1.4 8-6 8-11V5l-8-3zm0 17.9c-3.1-1.2-5.5-4.8-5.5-8.9V6.7L12 4.5l5.5 2.2v4.3c0 4.1-2.4 7.7-5.5 8.9z"/>
            </svg>
            <span class="nav-label" data-i18n="nav.permission">æƒé™ç®¡ç†</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="#customer.html" data-src="customer.html" data-title="å®¢æˆ·ç®¡ç†" title="å®¢æˆ·ç®¡ç†" data-i18n-title="nav.customer">
            <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M12 3a5 5 0 0 1 5 5c0 2.1-1.3 3.9-3.1 4.6 3.2.7 5.6 2.8 5.6 5.4V20a1 1 0 0 1-2 0v-1.6c0-2.1-2.6-3.9-5.5-3.9S6.5 16.3 6.5 18.4V20a1 1 0 1 1-2 0v-1.6c0-2.6 2.4-4.7 5.6-5.4A5 5 0 0 1 7 8a5 5 0 0 1 5-5zm0 2a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/>
            </svg>
            <span class="nav-label" data-i18n="nav.customer">å®¢æˆ·ç®¡ç†</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="#analysis.html" data-src="analysis.html" data-title="æ•°æ®åˆ†æ" title="æ•°æ®åˆ†æ" data-i18n-title="nav.analysis">
            <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M4 19h16v2H2V3h2v16zm4-6h2v6H8v-6zm4-4h2v10h-2V9zm4-3h2v13h-2V6z"/>
            </svg>
            <span class="nav-label" data-i18n="nav.analysis">æ•°æ®åˆ†æ</span>
          </a>
        </li>
      </ul>

      <div class="footer">
        <span>v1.0</span>
        <span>Â© Jef</span>
      </div>

      <button class="sidebar-handle" type="button" id="collapseBtn" aria-expanded="true" title="æ”¶èµ·/å±•å¼€">
        <svg class="handle-icon" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M14 7l-5 5 5 5"></path>
        </svg>
      </button>
    </aside>

    <!-- Main -->
    <main class="main">
      <header class="topbar">
        <div class="title">
          <span data-i18n="welcome">æ¬¢è¿å›æ¥ï¼Œ</span>{{ request.session.employee_name }}!
          <span id="pageSubtitle">Â· ä¸»é¡µ</span>
        </div>
        <div class="topbar-mid" aria-label="æ—¥æœŸ" data-i18n-aria="topbar.date">
          <span id="topDate"></span>
        </div>

        <div class="top-actions">
          <div class="c-switcher-group lang-switch" role="group" aria-label="è¯­è¨€åˆ‡æ¢">
            <button class="c-toggle" type="button" data-lang="zh-CN" aria-pressed="true">ä¸­æ–‡</button>
            <button class="c-toggle" type="button" data-lang="ja" aria-pressed="false">æ—¥æœ¬èª</button>
          </div>
          <button class="icon-btn c-btn c-btn-icon c-btn-ghost" id="noticeBtn" aria-label="é€šçŸ¥" data-i18n-aria="topbar.notice">
            ğŸ””
            <span class="badge">2</span>
          </button>

          <a class="avatar" href="#profile.html" data-src="profile.html" title="ä¸ªäººä¿¡æ¯" aria-label="ä¸ªäººä¿¡æ¯" data-i18n-title="topbar.profile" data-i18n-aria="topbar.profile">
            <div class="pic"></div>
            <div>
              <strong>{{ request.session.employee_name }}</strong>
              <small>{{ request.session.employee_position_name }}</small>
            </div>
          </a>
        </div>
      </header>

      <div class="main-body">
        <div class="frame-card c-card c-card-pad">
          <iframe class="main-frame" id="mainFrame" src="home.html" title="ä¸»é¡µ"></iframe>
        </div>
      </div>
    </main>
  </div>

  <dialog class="c-modal" id="noticeDialog" aria-labelledby="noticeTitle">
    <h3 id="noticeTitle" data-i18n="notice.title">é€šçŸ¥</h3>
    <p data-i18n="notice.body">åŠŸèƒ½å¼€å‘ä¸­</p>
    <div class="c-modal-actions">
      <button class="c-btn c-btn-primary" type="button" id="noticeClose" data-i18n="notice.confirm">çŸ¥é“äº†</button>
    </div>
  </dialog>

  <script src="i18n.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById("collapseBtn");
      const nav = document.getElementById("nav");
      const frame = document.getElementById("mainFrame");
      const topDate = document.getElementById("topDate");
      const noticeBtn = document.getElementById("noticeBtn");
      const noticeDialog = document.getElementById("noticeDialog");
      const noticeClose = document.getElementById("noticeClose");
      const pageSubtitle = document.getElementById("pageSubtitle");
      const KEY = "chat_sidebar_collapsed";
      const LANG_KEY = "app_lang";
      const MENU_KEY = "app_menu_list";
      const langButtons = Array.from(document.querySelectorAll(".lang-switch [data-lang]"));
      const i18n = window.I18N;

      const setCollapsed = (collapsed) => {
        document.body.classList.toggle("sidebar-collapsed", collapsed);
        if (btn) btn.setAttribute("aria-expanded", String(!collapsed));
        try { localStorage.setItem(KEY, collapsed ? "1" : "0"); } catch (e) {}
      };

      const formatTopDate = (lang) => {
        const d = new Date();
        if (lang === "ja") {
          const jp = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
          return `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥ï¼ˆ${jp[d.getDay()]}ï¼‰`;
        }
        const zh = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
        return `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥ï¼ˆå‘¨${zh[d.getDay()]}ï¼‰`;
      };

      const syncFrameLang = (lang) => {
        if (!frame) return;
        try {
          if (frame.contentWindow && frame.contentWindow.I18N) {
            frame.contentWindow.I18N.setLang(lang);
            frame.contentWindow.I18N.apply();
          }
        } catch (e) {}
        if (frame.contentWindow) {
          try {
            frame.contentWindow.postMessage({ type: "i18n:change", lang }, "*");
          } catch (e) {}
        }
      };

      const applyLang = (lang) => {
        const safeLang = i18n ? i18n.setLang(lang) : lang;
        langButtons.forEach((button) => {
          const isActive = button.dataset.lang === safeLang;
          button.classList.toggle("is-active", isActive);
          button.setAttribute("aria-pressed", String(isActive));
        });
        if (i18n && typeof i18n.apply === "function") {
          i18n.apply();
        }
        if (topDate) topDate.textContent = formatTopDate(safeLang);
        setSubtitle(resolveFromHash() || "home.html");
        syncFrameLang(safeLang);
      };

      const initLang = () => {
        const urlParams = new URLSearchParams(window.location.search || "");
        const urlLang = urlParams.get("lang");
        const current = i18n ? i18n.init() : "zh-CN";
        if (urlLang) {
          applyLang(urlLang);
          urlParams.delete("lang");
          const cleanUrl = `${window.location.pathname}${urlParams.toString() ? `?${urlParams}` : ""}${window.location.hash || ""}`;
          window.history.replaceState(null, "", cleanUrl);
          return;
        }
        applyLang(current);
      };

      langButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const lang = button.dataset.lang || "zh-CN";
          try { localStorage.setItem(LANG_KEY, lang); } catch (e) {}
          applyLang(lang);
        });
      });

      const openNoticeDialog = () => {
        if (!noticeDialog) return;
        if (typeof noticeDialog.showModal === "function") {
          noticeDialog.showModal();
        } else {
          noticeDialog.setAttribute("open", "open");
        }
      };

      const closeNoticeDialog = () => {
        if (!noticeDialog) return;
        if (typeof noticeDialog.close === "function") {
          noticeDialog.close();
        } else {
          noticeDialog.removeAttribute("open");
        }
      };

      const readCollapsed = () => {
        try { return localStorage.getItem(KEY) === "1"; } catch (e) { return false; }
      };

      if (btn) {
        setCollapsed(readCollapsed());
        btn.addEventListener("click", () => {
          setCollapsed(!document.body.classList.contains("sidebar-collapsed"));
        });
      }


      if (noticeBtn) {
        noticeBtn.addEventListener("click", openNoticeDialog);
      }
      if (noticeClose) {
        noticeClose.addEventListener("click", closeNoticeDialog);
      }
      if (noticeDialog) {
        noticeDialog.addEventListener("click", (event) => {
          if (event.target === noticeDialog) {
            closeNoticeDialog();
          }
        });
      }

      const links = nav ? Array.from(nav.querySelectorAll("a[data-src]")) : [];
      const normalizeMenuItem = (value) => (value || "")
        .replace(/^#/, "")
        .replace(/^\//, "")
        .trim();
      const readMenuList = () => {
        let raw = "";
        try {
          raw = localStorage.getItem(MENU_KEY) || "";
        } catch (e) {
          raw = "";
        }
        if (!raw) return null;
        if (raw === "*") return "*";
        try {
          const parsed = JSON.parse(raw);
          if (parsed === "*") return "*";
          if (Array.isArray(parsed)) return parsed;
          if (typeof parsed === "string") {
            const nested = parsed.trim();
            if (nested === "*") return "*";
            if (nested.startsWith("[") && nested.endsWith("]")) {
              try {
                const nestedParsed = JSON.parse(nested);
                if (Array.isArray(nestedParsed)) return nestedParsed;
              } catch (e) {}
            }
            return nested ? [nested] : [];
          }
        } catch (e) {}
        const trimmed = raw.trim();
        if (trimmed.startsWith("[") && trimmed.endsWith("]")) {
          try {
            const parsed = JSON.parse(trimmed);
            if (Array.isArray(parsed)) return parsed;
          } catch (e) {}
        }
        return trimmed ? [trimmed] : [];
      };
      const buildAllowedMenuSet = () => {
        const menuList = readMenuList();
        if (!menuList || menuList === "*") return null;
        return new Set(menuList.map(normalizeMenuItem).filter(Boolean));
      };
      const allowedMenuSet = buildAllowedMenuSet();
      const isAllowedRoute = (src) => {
        if (!allowedMenuSet) return true;
        const normalized = normalizeMenuItem(src);
        if (normalized === "home.html") return true;
        return allowedMenuSet.has(normalized);
      };
      const applyMenuFilter = () => {
        if (!allowedMenuSet) return;
        links.forEach((link) => {
          const src = normalizeMenuItem(link.getAttribute("data-src"));
          const isHome = src === "home.html";
          const allowed = isHome || allowedMenuSet.has(src);
          const item = link.closest("li");
          if (item) {
            item.style.display = allowed ? "" : "none";
          }
          link.setAttribute("aria-hidden", String(!allowed));
        });
      };

      const setActive = (src) => {
        for (const a of links) {
          a.classList.toggle("active", (a.getAttribute("data-src") || "") === src);
        }
      };

      const setSubtitle = (src) => {
        if (!pageSubtitle) return;
        const match = links.find((a) => (a.getAttribute("data-src") || "") === src);
        const label = match
          ? (match.getAttribute("data-title") || match.getAttribute("title") || match.textContent).trim()
          : (i18n ? i18n.t("nav.home") : "ä¸»é¡µ");
        pageSubtitle.textContent = `Â· ${label}`;
        return label;
      };

      const broadcastLang = () => {
        const lang = i18n ? i18n.getLang() : "zh-CN";
        syncFrameLang(lang);
      };

      const applyRoute = (src) => {
        if (!src) return;
        setActive(src);
        const label = setSubtitle(src);
        if (frame.src !== src) {
          frame.src = src;
          frame.setAttribute("title", label || src);
        }
      };

      const resolveFromHash = () => {
        const raw = (location.hash || "").replace(/^#/, "").trim();
        if (!raw) return null;
        const src = raw.split("?")[0].split("#")[0];
        return src || null;
      };

      const syncFromHash = () => {
        let src = resolveFromHash() || "home.html";
        if (!isAllowedRoute(src)) {
          src = "home.html";
          if (location.hash !== "#" + src) {
            location.hash = src;
            return;
          }
        }
        applyRoute(src);
      };

      const handleRouteClick = (event) => {
        if (!nav) return;
        const target = event.target && event.target.closest ? event.target.closest("a[data-src]") : null;
        if (!target) return;
        if (!(nav.contains(target) || target.classList.contains("avatar"))) return;
        event.preventDefault();
        const src = target.getAttribute("data-src");
        if (!src) return;
        if (location.hash !== "#" + src) {
          location.hash = src;
        } else {
          applyRoute(src);
        }
      };

      initLang();
      applyMenuFilter();

      if (nav) {
        nav.addEventListener("click", handleRouteClick);
      }
      document.addEventListener("click", handleRouteClick);
      window.addEventListener("hashchange", syncFromHash);
      if (frame) {
        syncFromHash();
        frame.addEventListener("load", broadcastLang);
      }
    });
  </script>
</body>
</html>
