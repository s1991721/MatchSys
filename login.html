<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/favicon-32.png" type="image/png" sizes="32x32">
    <link rel="stylesheet" href="common.css">
  <link rel="stylesheet" href="components.css">
  <title data-i18n="login.title">系统登录 - IT营业管理系统</title>
</head>
<body class="c-form-page c-center-page">
<div class="login-card c-card c-card-pad c-auth-card">
    <div class="login-lang">
        <div class="c-switcher-group lang-switch" role="group" aria-label="语言切换">
            <button class="c-toggle" type="button" data-lang="zh-CN" aria-pressed="true">中文</button>
            <button class="c-toggle" type="button" data-lang="ja" aria-pressed="false">日本語</button>
        </div>
    </div>
    <div>
        <h1 class="brand-title c-brand-title" data-i18n="brand.title">IT营业管理系统</h1>
        <p class="brand-subtitle c-brand-subtitle" data-i18n="brand.subtitle">IT Business Management System</p>
    </div>

    <form id="loginForm" method="post" action="javascript:void(0);">
        <div id="errorBox" class="error-box hidden"></div>
        <div class="form-grid form-grid-single">
            <div class="form-field">
                <label data-i18n="login.username">账号</label>
                <input id="userName" type="text" name="user_name" placeholder="admin" required>
            </div>
            <div class="form-field">
                <label data-i18n="login.password">密码</label>
                <input id="password" type="password" name="password" placeholder="••••••••" required>
            </div>
        </div>
        <div class="form-actions">
            <button id="submitBtn" type="submit" class="c-btn c-btn-primary c-btn-block">
                登 录
            </button>
        </div>
    </form>
</div>
<script src="/i18n.js"></script>
<script src="/common.js"></script>
<script>
    const API_BASE = "";
    const LOGIN_ENDPOINT = `${API_BASE}/api/login`;
    const LANG_KEY = "app_lang";
    const ROLE_KEY = "app_role_id";
    const MENU_KEY = "app_menu_list";

    const getI18n = () => window.I18N || null;
    const t = (key) => {
        const i18n = getI18n();
        return i18n ? i18n.t(key) : key;
    };

    const start = () => {
        const langButtons = Array.from(document.querySelectorAll(".lang-switch [data-lang]"));
        const form = document.getElementById("loginForm");
        const errorBox = document.getElementById("errorBox");
        const submitBtn = document.getElementById("submitBtn");

        const storeLang = (lang) => {
            try { localStorage.setItem(LANG_KEY, lang); } catch (e) {}
        };

        const applyLang = (lang) => {
            const i18n = getI18n();
            const safeLang = i18n ? i18n.setLang(lang) : lang;
            storeLang(safeLang);
            langButtons.forEach((button) => {
                const isActive = button.dataset.lang === safeLang;
                button.classList.toggle("is-active", isActive);
                button.setAttribute("aria-pressed", String(isActive));
            });
            if (i18n && typeof i18n.apply === "function") {
                i18n.apply();
            }
        };

        const initLang = () => {
            const i18n = getI18n();
            const current = i18n ? i18n.init() : "zh-CN";
            applyLang(current);
        };

        langButtons.forEach((button) => {
            button.addEventListener("click", () => {
                const lang = button.dataset.lang || "zh-CN";
                applyLang(lang);
            });
        });

        const updateSubmitText = (key) => {
            if (!submitBtn) return;
            submitBtn.textContent = t(key);
        };

        if (form) {
            form.addEventListener("submit", async (event) => {
                event.preventDefault();
                if (errorBox) {
                    errorBox.classList.add("hidden");
                    errorBox.textContent = "";
                }
                if (submitBtn) submitBtn.disabled = true;
                updateSubmitText("login.submitting");

                try {
                    const res = await fetch(LOGIN_ENDPOINT, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        credentials: "include",
                        body: JSON.stringify({
                            user_name: document.getElementById("userName").value.trim(),
                            password: document.getElementById("password").value,
                        }),
                    });
                    const data = await res.json();
                    const payload = normalizeApiResponse(data);
                    if (!res.ok || !payload.success) {
                        throw new Error(payload.message || t("login.failed"));
                    }
                    const loginData = payload.data || {};
                    const roleId = loginData.role_id ?? loginData.roleId ?? "";
                    const menuList = loginData.menu_list ?? loginData.menuList ?? "";
                    try {
                        if (roleId !== "" && roleId !== null && roleId !== undefined) {
                            localStorage.setItem(ROLE_KEY, String(roleId));
                        } else {
                            localStorage.removeItem(ROLE_KEY);
                        }
                        if (menuList !== "" && menuList !== null && menuList !== undefined) {
                            if (Array.isArray(menuList)) {
                                localStorage.setItem(MENU_KEY, JSON.stringify(menuList));
                            } else {
                                localStorage.setItem(MENU_KEY, String(menuList));
                            }
                        } else {
                            localStorage.removeItem(MENU_KEY);
                        }
                    } catch (e) {}
                    const target = "index.html".replace(/^\//, "");
                    const next = new URL(target, window.location.href);
                    let currentLang = "zh-CN";
                    try {
                        currentLang = localStorage.getItem(LANG_KEY) || currentLang;
                    } catch (e) {}
                    const i18n = getI18n();
                    if (i18n && i18n.getLang) {
                        currentLang = i18n.getLang() || currentLang;
                    }
                    if (currentLang) {
                        next.searchParams.set("lang", currentLang);
                    }
                    window.location.href = next.toString();
                } catch (err) {
                    if (errorBox) {
                        errorBox.textContent = err.message || t("login.failed");
                        errorBox.classList.remove("hidden");
                    }
                } finally {
                    if (submitBtn) submitBtn.disabled = false;
                    updateSubmitText("login.submit");
                }
            });
        }

        initLang();
        updateSubmitText("login.submit");
    };

    start();
</script>
</body>
</html>
