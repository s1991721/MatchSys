<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <!-- <link rel="icon" href="favicon.png" type="image/png"> -->
    <title>Match</title>
    <style>
        :root {
      --bg: #f4f6fb;
      --card: #ffffff;
      --card-soft: #f6f8ff;
      --text: #1f2a3d;
      --muted: #6b7686;
      --border: #e5e9f2;
      --line: #e5e9f2;
      --primary: #1c7bff;
      --primary-strong: #1b6fe8;
      --brand: #1c7bff;
      --brand2: #2e7bff;
      --accent: rgba(28, 123, 255, 0.08);
      --blue: #2f6fec;
      --purple: #7c3aed;
      --green: #16a34a;
      --orange: #f59e0b;
      --red: #ef4444;
      --danger: #ef4444;
      --warning: #f59e0b;
      --warn: #f59e0b;
      --success: #10b981;
      --shadow: 0 12px 28px rgba(31, 53, 90, 0.08);
      --shadowSoft: 0 10px 24px rgba(31, 53, 90, 0.07);
      --radius: 14px;
      --sidebar-w: 260px;
      --sidebar-w-collapsed: 68px;
    }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .page {
            width: min(98vw, 1680px);
            margin: 20px auto 32px;
            padding: 0 12px 24px;
        }

        .row {
            display: flex;
            gap: 14px;
            width: 100%;
            min-width: 0;
        }

        .row + .row {
            margin-top: 16px;
        }

        .panel {
            background: var(--card);
            border-radius: 12px;
            border: 1px solid var(--line);
            box-shadow: 0 10px 24px rgba(31, 53, 90, 0.07);
            padding: 14px 16px 16px;
            display: flex;
            flex-direction: column;
            min-height: 240px;
            min-width: 0;
        }

        .panel-left {
            flex: 1.2;
            min-width: 0;
        }

        .panel-right {
            flex: 1;
            min-width: 0;
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .panel-title::before {
            content: "";
            width: 4px;
            height: 18px;
            border-radius: 12px;
            background: var(--primary);
            box-shadow: 0 0 0 6px rgba(28, 123, 255, 0.12);
        }

        .panel-refresh {
            margin-left: auto;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #5a6c86;
            font-size: 12px;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
        }

        .panel-refresh svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        ul {
            list-style: none;
        }

        .list {
            margin-top: 4px;
            overflow-y: auto;
            border: 1px solid var(--line);
            border-radius: 10px;
        }

        .list.jobs {
            max-height: 420px;
        }

        .list.persons {
            max-height: 620px;
        }

        .filters {
            display: grid;
            grid-template-columns: 2fr 3fr;
            gap: 12px;
            margin: 0 0 12px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-size: 12px;
            color: var(--muted);
        }

        .chip-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .chip {
            padding: 8px 12px;
            border: 1px solid #d7deea;
            background: #f6f8fd;
            border-radius: 12px;
            color: #3b4a60;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.12s ease, border-color 0.12s ease, color 0.12s ease;
        }

        .chip.active {
            background: rgba(28, 123, 255, 0.12);
            border-color: #5e90ff;
            color: #1f60d8;
            box-shadow: 0 0 0 4px rgba(28, 123, 255, 0.12);
        }

        .input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #d7deea;
            background: #fdfdff;
            font-size: 14px;
            outline: none;
            transition: border-color 0.12s ease, box-shadow 0.12s ease;
        }

        .input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(28, 123, 255, 0.12);
            background: #ffffff;
        }

        .date-input {
            max-width: 160px;
            padding-left: 10px;
        }

        .date-input.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(28, 123, 255, 0.12);
        }

        .search-input {
            width: 100%;
        }

        .item {
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--line);
            cursor: pointer;
            transition: background 0.12s ease;
        }

        .item:last-child {
            border-bottom: none;
        }

        .item:hover {
            background: #edf3ff;
        }

        .item.active {
            background: #dbe7ff;
        }

        .item-main {
            flex: 1;
        }

        .empty {
            padding: 16px 12px;
            color: var(--muted);
            font-size: 13px;
            text-align: center;
        }

        .item-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
            word-break: break-word;
            overflow-wrap: anywhere;
        }

        .item-desc {
            font-size: 13px;
            color: var(--muted);
            word-break: break-word;
            overflow-wrap: anywhere;
        }

        .item-time {
            color: var(--muted);
            font-size: 12px;
            white-space: nowrap;
        }

        .person-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            font-size: 13px;
        }

        .person-name {
            font-weight: 600;
            flex: 1;
            min-width: 0;
            font-size: 14px;
            word-break: break-word;
            overflow-wrap: anywhere;
        }

        .person-meta {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            white-space: nowrap;
            text-align: center;
        }

        .person-belong {
            font-size: 12px;
            color: var(--muted);
        }

        .person-time {
            color: var(--muted);
            font-size: 12px;
            white-space: nowrap;
        }

        .detail-text {
            margin-top: 4px;
            font-size: 14px;
            line-height: 1.75;
            word-break: break-word;
            white-space: pre-line;
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 14px 16px;
            background: #fafbfe;
            min-height: 180px;
            color: #435065;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .skill-highlight {
            background: #ffe59e;
            color: #8a4b00;
            padding: 0 4px;
            border-radius: 6px;
            box-shadow: 0 0 0 1px #f3c763 inset;
        }

        .detail-text p {
            margin: 0 0 10px;
        }

        .detail-text p:last-child {
            margin-bottom: 0;
        }

        .detail-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 12px;
        }

        .primary-btn {
            padding: 10px 16px;
            border-radius: 10px;
            border: 1px solid var(--primary);
            background: var(--primary);
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 10px 24px rgba(28, 123, 255, 0.2);
            transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
        }

        .primary-btn:hover {
            background: #1669d8;
            transform: translateY(-1px);
            box-shadow: 0 12px 28px rgba(28, 123, 255, 0.3);
        }

        .primary-btn:active {
            transform: translateY(0);
            box-shadow: 0 8px 18px rgba(28, 123, 255, 0.2);
        }

        .pagination {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 10px 2px 0;
        }

        .pager-btn {
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid var(--line);
            background: #f6f8fd;
            color: #2f3d52;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.12s ease, border-color 0.12s ease, color 0.12s ease, box-shadow 0.12s ease;
        }

        .pager-btn:hover:not(:disabled) {
            background: #edf3ff;
            border-color: #c6d2ea;
        }

        .pager-btn:disabled {
            cursor: not-allowed;
            color: #b0b8c5;
            background: #f1f3f7;
        }

        .loading-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #c9d5ea;
            border-top-color: var(--primary);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .page-info {
            font-size: 13px;
            color: var(--muted);
        }

        @media (max-width: 1100px) {
            .row {
                flex-direction: column;
            }

            .list.jobs,
            .list.persons {
                max-height: 320px;
            }

            .filters {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="page">
    <!-- 上半部分：列表 -->
    <div class="row">
        <div class="panel panel-left">
            <div class="panel-title">求人列表</div>
            <div class="filters">
                <div class="filter-group">
                    <span class="filter-label">时间</span>
                    <div class="chip-row">
                        <button class="chip active" data-range="all" type="button">全部</button>
                        <button class="chip" data-range="today" type="button">今天</button>
                        <button class="chip" data-range="yesterday" type="button">昨天</button>
                        <input id="job-date" class="input date-input" type="date" aria-label="选择日期">
                    </div>
                </div>
                <div class="filter-group">
                    <span class="filter-label">关键字</span>
                    <input id="job-keyword" class="input search-input" type="search" placeholder="搜索案件标题、描述或细节">
                </div>
            </div>
            <ul class="list jobs" id="job-list">
            </ul>
            <div class="pagination" id="job-pagination">
                <button class="pager-btn" id="prev-page" type="button">上一页</button>
                <div class="page-info" id="page-info">第 1 页</div>
                <button class="pager-btn" id="next-page" type="button">下一页</button>
            </div>
        </div>

        <div class="panel panel-right">
            <div class="panel-title">
                <span>人员列表</span>
                <span class="panel-refresh" aria-label="刷新时间">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M12 2.5a1 1 0 0 1 1 1v2.836l1.768-1.768a1 1 0 1 1 1.414 1.414l-3.535 3.536a1 1 0 0 1-1.414 0L7.698 5.982A1 1 0 0 1 9.112 4.568L10.5 5.957V3.5a1 1 0 0 1 1-1Zm-7 11a7 7 0 0 1 12.195-4.949 1 1 0 1 0 1.41-1.418A9 9 0 1 0 12 21.5a9.01 9.01 0 0 0 8.352-5.512 1 1 0 1 0-1.85-.77A7 7 0 0 1 5 13.5Z"/>
                    </svg>
                    <span class="panel-refresh-time">10:24 刷新</span>
                </span>
            </div>
            <ul class="list persons" id="person-list">
                <!-- 使用 data-detail 存放技术者详细信息 -->
                <li class="item active"
                    data-detail="这是技术者A的详细信息……ABCDEFG1234567890不想超出屏幕想自动换行。">
                    <div class="person-header">
                        <span class="person-name">技术者A</span>
                        <div class="person-meta">
                            <span class="person-belong">所属1</span>
                            <span class="person-time">12月9日 09:04:36</span>
                        </div>
                    </div>
                </li>
                <li class="item"
                    data-detail="这是技术者B的详细信息……ABCDEFG1234567890不想超出屏幕想自动换行。">
                    <div class="person-header">
                        <span class="person-name">技术者B</span>
                        <div class="person-meta">
                            <span class="person-belong">所属2</span>
                            <span class="person-time"></span>
                        </div>
                    </div>
                </li>
                <li class="item"
                    data-detail="这是技术者C的详细信息……ABCDEFG1234567890不想超出屏幕想自动换行。">
                    <div class="person-header">
                        <span class="person-name">技术者C</span>
                        <div class="person-meta">
                            <span class="person-belong">所属3</span>
                            <span class="person-time"></span>
                        </div>
                    </div>
                </li>
                <li class="item"
                    data-detail="这是技术者C的详细信息……ABCDEFG1234567890不想超出屏幕想自动换行。">
                    <div class="person-header">
                        <span class="person-name">技术者C</span>
                        <div class="person-meta">
                            <span class="person-belong">所属3</span>
                            <span class="person-time"></span>
                        </div>
                    </div>
                </li>
                <!-- 其余列表项由接口填充 -->
            </ul>
        </div>
    </div>

    <!-- 下半部分：详情 -->
    <div class="row">
        <div class="panel panel-left detail">
            <div class="panel-title">求人详情</div>
            <div class="detail-text" id="job-detail">
                这是求人1的详细说明……ABCDEFG1234567890不想超出屏幕想自动换行。
            </div>
        </div>

        <div class="panel panel-right detail">
            <div class="panel-title">技术者详情</div>
            <div class="detail-text" id="person-detail">
                这是技术者A的详细信息……ABCDEFG1234567890不想超出屏幕想自动换行。
            </div>
            <div class="detail-actions">
                <button class="primary-btn" type="button" id="send-btn">
                    送信
                </button>
            </div>
        </div>
    </div>
</div>

<script src="common.js"></script>
<script>
    const sanitize = (str = '') =>
        str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');

    const escapeRegExp = (str = '') => str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

    const SENSITIVE_WORDS = ['OrientalKingdomGroup', 'Oriental', 'Kingdom', 'Group', '邱'];
    const maskSensitive = (text = '') => {
        if (!text) return '';
        const patterns = SENSITIVE_WORDS.map(escapeRegExp);
        if (!patterns.length) return text;
        const regex = new RegExp(`(${patterns.join('|')})`, 'gi');
        return text.replace(regex, '***');
    };

    const stripCssNoise = (text = '') => {
        if (!text) return '';
        const firstGap = text.indexOf('\n\n');
        const hasBraces = text.slice(0, Math.max(firstGap, 120)).includes('{');
        if (firstGap >= 0 && hasBraces) {
            return text.slice(firstGap + 2);
        }
        return text;
    };

    function renderDetail(target, text = '', highlights = []) {
        if (!target) return;
        const cleaned = stripCssNoise(text || '');
        const masked = cleaned;
        const normalized = masked
            .replace(/\r\n/g, '\n')
            .replace(/\n{3,}/g, '\n\n')
            .trim();
        const escapedHighlights = (Array.isArray(highlights) ? highlights : [])
            .filter(Boolean)
            .map(v => sanitize(String(v)))
            .map(escapeRegExp);
        const highlightRegex = escapedHighlights.length
            ? new RegExp(`(${escapedHighlights.join('|')})`, 'gi')
            : null;
        const applyHighlight = (val) =>
            highlightRegex ? val.replace(highlightRegex, '<mark class="skill-highlight">$1</mark>') : val;

        const html = sanitize(normalized)
            .split(/\n{2,}/)
            .filter(Boolean)
            .map(block => `<p>${applyHighlight(block.replace(/\n/g, '<br>'))}</p>`)
            .join('');
        target.innerHTML = html || '<p style="color:#9aa4b5">暂无内容</p>';
    }

    const API_BASE = '';
    const fetchWithAuth = async (url, options = {}) => {
        const res = await fetch(url, options);
        if (res.status === 401) {
            window.location.href = '/login.html';
            throw new Error('Unauthorized');
        }
        return res;
    };
    const JOB_CLICK_ENDPOINT = `${API_BASE}/job-click`;
    const jobList = document.getElementById('job-list');
    const jobDetail = document.getElementById('job-detail');
    const personDetail = document.getElementById('person-detail');
    const personList = document.getElementById('person-list');
    const personRefresh = document.querySelector('.panel-refresh');
    const personRefreshTime = document.querySelector('.panel-refresh-time');
    const jobKeyword = document.getElementById('job-keyword');
    const jobDate = document.getElementById('job-date');
    const dateButtons = Array.from(document.querySelectorAll('.chip[data-range]'));
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const pageInfo = document.getElementById('page-info');
    const sendBtn = document.getElementById('send-btn');

    let activeJobDetail = '';
    let activeMatchedSkills = [];

    const PAGE_SIZE = 50;
    let currentPage = 1;
    let hasNextPage = false;

    const filters = {
        range: 'all',
        customDate: ''
    };

    // 公共函数：给列表加点击事件
    function bindListClick(listId, detailId, onSelect) {
        const list = document.getElementById(listId);
        const detail = document.getElementById(detailId);

        if (!list || !detail) return;

        list.addEventListener('click', function (e) {
            const item = e.target.closest('.item');
            if (!item) return;

            list.querySelectorAll('.item').forEach(li => li.classList.remove('active'));
            item.classList.add('active');

            const text = item.getAttribute('data-detail') || '';
            const highlights = readMatchedSkills(item);
            renderDetail(detail, text, highlights);

            if (typeof onSelect === 'function') {
                try {
                    onSelect(item, highlights);
                } catch (err) {
                    console.error('handleSelect failed', err);
                }
            }
        });
    }

    const readMatchedSkills = (item) => {
        const raw = item?.dataset?.matchedSkills;
        if (!raw) return [];
        try {
            const parsed = JSON.parse(raw);
            return Array.isArray(parsed) ? parsed.map((v) => String(v)) : [];
        } catch {
            return [];
        }
    };

    const formatDate = (date) => {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    };

    function renderJobList(items) {
        jobList.innerHTML = '';
        activeMatchedSkills = [];

        if (!items.length) {
            const empty = document.createElement('li');
            empty.className = 'empty';
            empty.textContent = '暂无匹配的求人';
            jobList.appendChild(empty);
            renderDetail(jobDetail, '暂无可显示的求人');
            activeJobDetail = '';
            return;
        }

        items.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'item' + (index === 0 ? ' active' : '');
            const detail = item.detail || '';
            const id = item.id || '';
            li.dataset.detail = detail;
            li.dataset.id = id;
            li.dataset.item = JSON.stringify({ ...item, detail, id });

            const main = document.createElement('div');
            main.className = 'item-main';

            const title = document.createElement('div');
            title.className = 'item-title';
            title.textContent = item.title;

            const desc = document.createElement('div');
            desc.className = 'item-desc';
            desc.textContent = item.desc;

            const time = document.createElement('div');
            time.className = 'item-time';
            time.textContent = formatDisplayDate(item.date);

            main.appendChild(title);
            main.appendChild(desc);
            li.appendChild(main);
            li.appendChild(time);
            jobList.appendChild(li);
        });

        const first = jobList.querySelector('.item');
        if (first) {
            activeJobDetail = first.dataset.detail || '';
            renderDetail(jobDetail, activeJobDetail, activeMatchedSkills);
        }
    }

    function renderPersonList(items) {
        if (!personList) return;
        personList.innerHTML = '';
        activeMatchedSkills = [];

        if (!items.length) {
            const empty = document.createElement('li');
            empty.className = 'empty';
            empty.textContent = '暂无技术者';
            personList.appendChild(empty);
            renderDetail(personDetail, '暂无可显示的技术者');
            renderDetail(jobDetail, activeJobDetail, activeMatchedSkills);
            return;
        }

        items.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'item' + (index === 0 ? ' active' : '');
            const detail = item.detail || item.body || item.desc || '';
            li.dataset.detail = detail;
            li.dataset.id = item.id || '';
            li.dataset.matchedSkills = JSON.stringify(item.matched_skills || []);
            li.dataset.item = JSON.stringify({ ...item, detail });

            const header = document.createElement('div');
            header.className = 'person-header';

            const name = document.createElement('span');
            name.className = 'person-name';
            name.textContent = item.name || item.title || item.subject || '(无标题)';

            const meta = document.createElement('div');
            meta.className = 'person-meta';

            const belong = document.createElement('span');
            belong.className = 'person-belong';
            belong.textContent = item.belong || item.from || '';

            const time = document.createElement('span');
            time.className = 'person-time';
            time.textContent = formatDisplayDate(item.date);

            meta.appendChild(belong);
            meta.appendChild(time);

            header.appendChild(name);
            header.appendChild(meta);
            li.appendChild(header);
            personList.appendChild(li);
        });

        const first = personList.querySelector('.item');
        if (first) {
            const initialHighlights = readMatchedSkills(first);
            activeMatchedSkills = initialHighlights;
            const firstDetail = first.dataset.detail || '';
            renderDetail(personDetail, firstDetail, initialHighlights);
            renderDetail(jobDetail, activeJobDetail, initialHighlights);
        }
    }

    function formatDisplayDate(raw) {
        const d = raw ? new Date(raw) : null;
        if (!d || Number.isNaN(d.getTime())) return raw || '';
        const pad = (n) => String(n).padStart(2, '0');
        return `${d.getMonth() + 1}月${d.getDate()}日 ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function formatRefreshTime(raw) {
        const d = raw ? new Date(raw) : null;
        if (!d || Number.isNaN(d.getTime())) return '未刷新';
        const pad = (n) => String(n).padStart(2, '0');
        return `${d.getFullYear()}/${pad(d.getMonth() + 1)}/${pad(d.getDate())} 刷新`;
    }

    function currentFilterDate() {
        const today = formatDate(new Date());
        const yesterdayDate = new Date();
        yesterdayDate.setDate(yesterdayDate.getDate() - 1);
        const yesterday = formatDate(yesterdayDate);

        return filters.range === 'today'
            ? today
            : filters.range === 'yesterday'
                ? yesterday
                : filters.range === 'custom'
                    ? filters.customDate
                    : '';
    }

    function updatePaginationUI() {
        if (pageInfo) {
            pageInfo.textContent = `第 ${currentPage} 页`;
        }
        if (prevPageBtn) {
            prevPageBtn.disabled = currentPage <= 1;
        }
        if (nextPageBtn) {
            nextPageBtn.disabled = !hasNextPage;
        }
    }

    function showLoading(message = '加载中...') {
        jobList.innerHTML = '';
        const loading = document.createElement('li');
        loading.className = 'empty';
        loading.textContent = message;
        jobList.appendChild(loading);
        hasNextPage = false;
        updatePaginationUI();
    }

    async function fetchJobs(page = 1) {
        currentPage = page;
        const params = new URLSearchParams();
        const keyword = jobKeyword.value.trim();
        const targetDate = currentFilterDate();

        if (keyword) params.set('keyword', keyword);
        if (targetDate) params.set('date', targetDate);
        params.set('page', String(currentPage));
        params.set('page_size', String(PAGE_SIZE));

        const url = `${API_BASE}/messages${params.toString() ? `?${params}` : ''}`;
        showLoading('正在加载求人...');

        try {
            const res = await fetchWithAuth(url, { credentials: 'include' });
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }
            const data = await res.json();
            const payload = normalizeApiResponse(data);
            if (!payload.success) {
                throw new Error(payload.message || '加载失败');
            }
            const result = payload.data || {};
            currentPage = result.page || currentPage;
            hasNextPage = Boolean(result.has_next);
            renderJobList(result.items || []);
            updatePaginationUI();
        } catch (err) {
            jobList.innerHTML = '';
            const errorLi = document.createElement('li');
            errorLi.className = 'empty';
            errorLi.textContent = `加载失败：${err.message}`;
            jobList.appendChild(errorLi);
            jobDetail.textContent = '暂无可显示的求人';
            hasNextPage = false;
            updatePaginationUI();
        }
    }

    function setPersonLoading(message = '正在匹配技术者...') {
        if (!personList) return;
        personList.innerHTML = '';
        const loading = document.createElement('li');
        loading.className = 'empty';
        loading.innerHTML = `<span class="loading-row"><span class="spinner" aria-hidden="true"></span>${sanitize(message)}</span>`;
        personList.appendChild(loading);
    }

    async function fetchPersons(refresh = false) {
        if (personRefreshTime) {
            personRefreshTime.textContent = '刷新中...';
        }
        setPersonLoading('正在加载技术者...');

        try {
            const url = `${API_BASE}/persons${refresh ? '?refresh=1' : ''}`;
            const res = await fetchWithAuth(url, { credentials: 'include' });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            const payload = normalizeApiResponse(data);
            if (!payload.success) {
                throw new Error(payload.message || '加载失败');
            }
            const result = payload.data || {};
            renderPersonList(result.items || []);
            if (personRefreshTime) {
                personRefreshTime.textContent = formatRefreshTime(result.update_time);
            }
        } catch (err) {
            if (personList) {
                personList.innerHTML = '';
                const errorLi = document.createElement('li');
                errorLi.className = 'empty';
                errorLi.textContent = `加载失败：${err.message}`;
                personList.appendChild(errorLi);
            }
            if (personRefreshTime) {
                personRefreshTime.textContent = '刷新失败';
            }
        }
    }

    dateButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            dateButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            filters.range = btn.dataset.range;
            filters.customDate = '';
            jobDate.value = '';
            jobDate.classList.remove('active');
            fetchJobs(1);
        });
    });

    jobDate.addEventListener('change', () => {
        if (jobDate.value) {
            filters.range = 'custom';
            filters.customDate = jobDate.value;
            dateButtons.forEach(b => b.classList.remove('active'));
            jobDate.classList.add('active');
        } else {
            filters.range = 'all';
            filters.customDate = '';
            dateButtons.forEach(b => {
                b.classList.toggle('active', b.dataset.range === 'all');
            });
            jobDate.classList.remove('active');
        }
        fetchJobs(1);
    });

    jobKeyword.addEventListener('input', () => {
        fetchJobs(1);
    });

    if (prevPageBtn) {
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                fetchJobs(currentPage - 1);
            }
        });
    }

    if (nextPageBtn) {
        nextPageBtn.addEventListener('click', () => {
            if (hasNextPage) {
                fetchJobs(currentPage + 1);
            }
        });
    }

    if (personRefresh) {
        personRefresh.addEventListener('click', () => {
            fetchPersons(true);
        });
    }

    // 先把静态文案按新格式渲染，再绑定事件和拉取接口
    renderDetail(jobDetail, jobDetail.textContent.trim());
    renderDetail(personDetail, personDetail.textContent.trim());

    fetchJobs(1);
    bindListClick('job-list', 'job-detail', async (item) => {
        activeJobDetail = item.getAttribute('data-detail') || '';
        activeMatchedSkills = [];
        renderDetail(jobDetail, activeJobDetail, activeMatchedSkills);
        const raw = item?.dataset?.item || '{}';
        let payload;
        try {
            payload = JSON.parse(raw);
        } catch {
            payload = {};
        }
        setPersonLoading('正在匹配技术者...');
        if (personRefreshTime) {
            personRefreshTime.textContent = '匹配中...';
        }
        try {
            const res = await fetchWithAuth(JOB_CLICK_ENDPOINT, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify(payload),
            });
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }
            const data = await res.json();
            const payload = normalizeApiResponse(data);
            if (!payload.success) {
                throw new Error(payload.message || '匹配失败');
            }
            const result = payload.data || {};
            const rawMatches =
                (result && result.matches) ||
                (result && result.match && result.match.matches) ||
                [];
            const matchItems = Array.isArray(rawMatches)
                ? rawMatches
                : typeof rawMatches === 'object' && rawMatches !== null
                    ? Object.values(rawMatches)
                    : [];

            if (personRefreshTime) {
                personRefreshTime.textContent = '匹配结果（刚刚）';
            }
            renderPersonList(matchItems);
        } catch (err) {
            console.error('上报点击事件失败', err);
            if (personList) {
                personList.innerHTML = '';
                const errorLi = document.createElement('li');
                errorLi.className = 'empty';
                errorLi.textContent = `匹配失败：${err.message}`;
                personList.appendChild(errorLi);
                renderDetail(personDetail, '暂无可显示的技术者');
            }
            if (personRefreshTime) {
                personRefreshTime.textContent = '匹配失败';
            }
        }
    });
    bindListClick('person-list', 'person-detail', (item, highlights) => {
        activeMatchedSkills = highlights || [];
        renderDetail(jobDetail, activeJobDetail, activeMatchedSkills);
    });
    fetchPersons(false);

    // 将当前选中的求人与人员信息存入本地并跳转到送信页
    if (sendBtn) {
        sendBtn.addEventListener('click', () => {
            const activeJob = jobList?.querySelector('.item.active');
            const activePerson = personList?.querySelector('.item.active');

            if (!activeJob || !activePerson) {
                alert('请先在求人列表与人员列表中各选择一条再送信。');
                return;
            }

            const parseDatasetJSON = (el, key) => {
                if (!el || !el.dataset) return null;
                const raw = el.dataset[key];
                if (!raw) return null;
                try {
                    return JSON.parse(raw);
                } catch {
                    return null;
                }
            };

            const jobData = parseDatasetJSON(activeJob, 'item') || {};
            const personData = parseDatasetJSON(activePerson, 'item') || {};

            const jobPayload = {
                id: jobData.id || activeJob.dataset.id || '',
                title: jobData.title || jobData.subject || activeJob.querySelector('.item-title')?.textContent.trim() || '',
                desc: jobData.desc || jobData.from || activeJob.querySelector('.item-desc')?.textContent.trim() || '',
                detail: jobData.detail || jobData.body || activeJob.dataset.detail || '',
                time: jobData.date || jobData.time || activeJob.querySelector('.item-time')?.textContent.trim() || '',
                thread_id: jobData.thread_id || '',
                message_id_header: jobData.message_id_header || '',
                references_header: jobData.references_header || ''
            };

            const personPayload = {
                id: personData.id || activePerson.dataset.id || '',
                name: personData.name || personData.title || activePerson.querySelector('.person-name')?.textContent.trim() || '',
                belong: personData.belong || personData.from || activePerson.querySelector('.person-belong')?.textContent.trim() || '',
                detail: personData.detail || personData.body || activePerson.dataset.detail || '',
                time: personData.date || personData.time || activePerson.querySelector('.person-time')?.textContent.trim() || '',
                thread_id: personData.thread_id || '',
                message_id_header: personData.message_id_header || '',
                references_header: personData.references_header || ''
            };

            const payload = {
                job: jobPayload,
                person: personPayload,
                updatedAt: Date.now()
            };

            try {
                localStorage.setItem('matchSelection', JSON.stringify(payload));
            } catch (err) {
                console.error('无法缓存选中内容', err);
            }

            window.location.href = 'songxin.html?from=match';
        });
    }
</script>
</body>
</html>
