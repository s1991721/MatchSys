<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" href="/favicon-32.png" type="image/png" sizes="32x32">
    <link rel="stylesheet" href="common.css">
    <link rel="stylesheet" href="components.css">
    <title data-i18n="order.title">注文书管理</title>
</head>
<body>
<div class="container page-wide c-stack">
    <div class="c-page-head-grid">
        <div class="c-page-head-spacer" aria-hidden="true"></div>
        <div class="c-switch-wrap">
            <div class="c-switcher-group" role="tablist" aria-label="视角切换" data-i18n-aria="order.filter.title">
                <button class="c-toggle is-active" type="button" data-view="issue" role="tab" aria-selected="true" data-i18n="order.tabs.issue">
                    发注
                </button>
                <button class="c-toggle" type="button" data-view="accept" role="tab" aria-selected="false" data-i18n="order.tabs.accept">受注</button>
            </div>
        </div>
    </div>

    <section class="c-card c-card-pad">
        <div class="c-inline-filters">
            <div class="c-inline-filters-grid-3">
                <div class="c-inline-field">
                    <span data-i18n="order.filter.order_no">注文书号</span>
                    <input id="filter-order-no" type="text" placeholder="PO-XXXX"/>
                </div>
                <div class="c-inline-field">
                    <span data-i18n="order.filter.project">案件名</span>
                    <input id="filter-project" type="text" placeholder="SES 案件名" data-i18n-placeholder="order.placeholder.project_filter"/>
                </div>
                <div class="c-inline-field">
                    <span data-issue="取引先（下请公司）" data-accept="取引先（客户公司）"
                          data-i18n-issue="order.filter.customer_issue"
                          data-i18n-accept="order.filter.customer_accept">取引先（下请公司）</span>
                    <input id="filter-customer" type="text" placeholder="下请公司"
                           data-issue-placeholder="下请公司"
                           data-accept-placeholder="客户公司"
                           data-i18n-issue-placeholder="order.filter.customer_issue_placeholder"
                           data-i18n-accept-placeholder="order.filter.customer_accept_placeholder"
                           list="filter-customer-list"/>
                    <input id="filter-customer-id" type="hidden"/>
                </div>
                <datalist id="filter-customer-list"></datalist>
                <div class="c-inline-field">
                    <span data-i18n="order.filter.technician">技术者</span>
                    <input id="filter-technician" type="text" placeholder="姓名" data-i18n-placeholder="order.placeholder.name"/>
                </div>
                <div class="c-inline-field">
                    <span data-i18n="order.filter.status">状态</span>
                    <select id="statusFilter"
                            data-issue-options="承认中,已受注,拒绝,已取消"
                            data-accept-options="已受注,拒绝,已取消"
                            data-default-option="全部">
                        <option>全部</option>
                    </select>
                </div>
                <div class="c-inline-field">
                    <span data-i18n="order.filter.period">创建期间</span>
                    <div class="c-inline-field-range">
                        <input id="filter-start" type="date"/>
                        <span>~</span>
                        <input id="filter-end" type="date"/>
                    </div>
                </div>
            </div>
            <div class="c-inline-filters-extra">
                <label class="c-inline-filter-check" for="filter-only-self">
                    <input id="filter-only-self" type="checkbox"/>
                    <span class="c-inline-filter-label" data-i18n="order.filter.only_self">仅自己</span>
                </label>
            </div>
            <div class="c-filter-actions-bar">
                <div class="c-filter-actions-left">
                    <button class="c-btn c-btn-primary c-btn-lg c-btn-strong" id="createBtn" type="button"
                            data-issue="新建注文书" data-accept="新建受注"
                            data-i18n-issue="order.action.create_issue"
                            data-i18n-accept="order.action.create_accept">＋ 新建注文书
                    </button>
                </div>
                <div class="c-filter-actions-right c-filter-actions-group">
                    <button class="c-btn c-btn-primary" id="searchBtn" type="button" data-i18n="common.search">搜索</button>
                    <button class="c-btn c-btn-warn" id="resetBtn" type="button" data-i18n="common.reset">重置</button>
                </div>
            </div>
        </div>

        <div class="c-table-info" id="table-info">共 0 条 当前显示第 1 页</div>
        <div class="table-wrap c-table-wrapper">
            <table class="c-table">
                <thead>
                <tr>
                    <th data-i18n="order.table.order_no">注文No</th>
                    <th data-issue="案件名 / 取引先（下请）" data-accept="案件名 / 取引先（客户）"
                        data-i18n-issue="order.table.project_customer_issue"
                        data-i18n-accept="order.table.project_customer_accept">案件名 / 取引先（下请）
                    </th>
                    <th data-i18n="order.table.technician">技术者</th>
                    <th data-i18n="order.table.price">契约单价</th>
                    <th data-i18n="order.table.hours">契约工时</th>
                    <th data-i18n="order.table.period">契约期间</th>
                    <th data-i18n="order.table.created_at">创建时间</th>
                    <th data-i18n="order.table.created_by">创建人</th>
                    <th data-i18n="order.table.owner">负责人</th>
                    <th data-i18n="order.table.updated_at">修改时间</th>
                    <th data-i18n="order.table.updated_by">修改人</th>
                    <th data-i18n="order.table.status">状态</th>
                    <th data-i18n="order.table.actions">操作</th>
                </tr>
                </thead>
                <tbody id="order-body"></tbody>
            </table>
            <div class="c-pager">
                <div class="pagination c-pagination" id="order-pagination">
                    <div class="pagination-summary">
                        <span id="page-summary">共 0 条 · 第 1/1 页</span>
                    </div>
                    <div class="pagination-pages" id="order-pagination-pages"></div>
                </div>
                <select id="page-size">
                    <option value="10" data-i18n="order.page_size_10">10 条/页</option>
                    <option value="20" data-i18n="order.page_size_20">20 条/页</option>
                    <option value="50" data-i18n="order.page_size_50">50 条/页</option>
                </select>
            </div>
        </div>
    </section>
</div>

<dialog class="c-modal" id="createDialogIssue" aria-labelledby="createTitleIssue">
    <h3 id="createTitleIssue" data-i18n="order.dialog.issue.title">新建注文书</h3>
    <p data-i18n="order.dialog.issue.subtitle">请根据注文书字段填写基础信息。</p>
    <div class="c-modal-form">
        <div class="c-modal-grid">
            <label class="c-inline-field">
                <span data-i18n="order.field.order_no">注文No</span>
                <input id="issue-order-no" type="text" placeholder="PO-2024-XXX"/>
            </label>
            <label class="c-inline-field">
                <span data-i18n="order.field.project">案件名</span>
                <input id="issue-project-name" type="text" placeholder="案件名称" data-i18n-placeholder="order.placeholder.project"/>
            </label>
            <label class="c-inline-field c-inline-field-full">
                <span data-i18n="order.field.customer">取引先（下请公司）</span>
                <input id="issue-customer-name" type="text" placeholder="下请公司"
                       data-i18n-placeholder="order.filter.customer_issue_placeholder"
                       list="issue-customer-list"/>
            </label>
            <datalist id="issue-customer-list"></datalist>
            <input id="issue-customer-id" type="hidden"/>
            <label class="c-inline-field">
                <span data-i18n="order.field.technician">技术者</span>
                <input id="issue-technician-name" type="text" placeholder="姓名" data-i18n-placeholder="order.placeholder.name"/>
            </label>
            <label class="c-inline-field">
                <span data-i18n="order.field.status">状态</span>
                <select id="issue-status">
                    <option value="请选择状态" data-i18n="order.filter.status_select">请选择状态</option>
                    <option value="承认中" selected data-i18n="order.status.approving">承认中</option>
                    <option value="已受注" data-i18n="order.status.accepted">已受注</option>
                    <option value="拒绝" data-i18n="order.status.rejected">拒绝</option>
                    <option value="已取消" data-i18n="order.status.canceled">已取消</option>
                </select>
            </label>
            <label class="c-inline-field">
                <span data-i18n="order.field.price">契约单价</span>
                <input id="issue-price" type="text" placeholder="¥ 0"/>
            </label>
            <label class="c-inline-field">
                <span data-i18n="order.field.hours">契约工时</span>
                <input id="issue-hours" type="text" placeholder="160h"/>
            </label>
            <label class="c-inline-field c-inline-field-full">
                <span data-i18n="order.field.period">契约期间</span>
                <div class="c-inline-field-range">
                    <input id="issue-start" type="date"/>
                    <span>~</span>
                    <input id="issue-end" type="date"/>
                </div>
            </label>
            <label class="c-inline-field">
                <span data-i18n="order.field.owner">负责人</span>
                <input id="issue-owner" type="text" placeholder="姓名" data-i18n-placeholder="order.placeholder.name" list="issue-owner-list"/>
            </label>
            <datalist id="issue-owner-list"></datalist>
        </div>
    </div>
    <div class="c-modal-actions">
        <button class="c-btn c-btn-secondary" type="button" data-dialog-close data-i18n="common.cancel">取消</button>
        <button class="c-btn c-btn-primary" type="button" id="issue-create-submit" data-i18n="common.create">开始创建</button>
    </div>
</dialog>

<dialog class="c-modal" id="createDialogAccept" aria-labelledby="createTitleAccept">
    <h3 id="createTitleAccept" data-i18n="order.dialog.accept.title">新建受注</h3>
    <p data-i18n="order.dialog.accept.subtitle">请根据受注字段填写基础信息。</p>
    <div class="c-modal-form">
        <div class="c-modal-grid">
            <label class="c-inline-field">
                <span data-i18n="order.field.order_no">注文No</span>
                <input id="accept-order-no" type="text" placeholder="PO-2024-XXX"/>
            </label>
            <label class="c-inline-field">
                <span data-i18n="order.field.project">案件名</span>
                <input id="accept-project-name" type="text" placeholder="案件名称" data-i18n-placeholder="order.placeholder.project"/>
            </label>
            <label class="c-inline-field">
                <span data-i18n="order.field.purchase_id">对应发注ID</span>
                <input id="accept-purchase-id" type="number" placeholder="发注ID" data-i18n-placeholder="order.placeholder.purchase_id"/>
            </label>
            <label class="c-inline-field c-inline-field-full">
                <span data-i18n="order.field.customer_accept">取引先（客户公司）</span>
                <input id="accept-customer-name" type="text" placeholder="客户公司"
                       data-i18n-placeholder="order.filter.customer_accept_placeholder"
                       list="accept-customer-list"/>
            </label>
            <datalist id="accept-customer-list"></datalist>
            <input id="accept-customer-id" type="hidden"/>
            <label class="c-inline-field">
                <span data-i18n="order.field.technician">技术者</span>
                <input id="accept-technician-name" type="text" placeholder="姓名" data-i18n-placeholder="order.placeholder.name" list="accept-technician-list"/>
            </label>
            <datalist id="accept-technician-list"></datalist>
            <input id="accept-technician-id" type="hidden"/>
            <label class="c-inline-field">
                <span data-i18n="order.field.status">状态</span>
                <select id="accept-status">
                    <option value="请选择状态" data-i18n="order.filter.status_select">请选择状态</option>
                    <option value="已受注" selected data-i18n="order.status.accepted">已受注</option>
                    <option value="拒绝" data-i18n="order.status.rejected">拒绝</option>
                    <option value="已取消" data-i18n="order.status.canceled">已取消</option>
                </select>
            </label>
            <label class="c-inline-field">
                <span data-i18n="order.field.price">契约单价</span>
                <input id="accept-price" type="text" placeholder="¥ 0"/>
            </label>
            <label class="c-inline-field">
                <span data-i18n="order.field.hours">契约工时</span>
                <input id="accept-hours" type="text" placeholder="160h"/>
            </label>
            <label class="c-inline-field c-inline-field-full">
                <span data-i18n="order.field.period">契约期间</span>
                <div class="c-inline-field-range">
                    <input id="accept-start" type="date"/>
                    <span>~</span>
                    <input id="accept-end" type="date"/>
                </div>
            </label>
            <label class="c-inline-field">
                <span data-i18n="order.field.owner">负责人</span>
                <input id="accept-owner" type="text" placeholder="姓名" data-i18n-placeholder="order.placeholder.name" list="accept-owner-list"/>
            </label>
            <datalist id="accept-owner-list"></datalist>
        </div>
    </div>
    <div class="c-modal-actions">
        <button class="c-btn c-btn-secondary" type="button" data-dialog-close data-i18n="common.cancel">取消</button>
        <button class="c-btn c-btn-primary" type="button" id="accept-create-submit" data-i18n="common.create">开始创建</button>
    </div>
</dialog>

<dialog class="c-modal" id="detailDialog" aria-labelledby="detailTitle">
    <h3 id="detailTitle" data-i18n="order.dialog.detail.title">查看注文书</h3>
    <p id="detailSubtitle" data-i18n="order.dialog.detail.subtitle_view">查看订单详情</p>
    <div class="c-modal-form">
        <div class="c-modal-grid">
            <label class="c-inline-field">
                <span data-i18n="order.field.order_no">注文No</span>
                <input type="text" data-field="orderNo"/>
            </label>
            <label class="c-inline-field">
                <span data-i18n="order.field.project">案件名</span>
                <input type="text" data-field="project"/>
            </label>
            <label class="c-inline-field">
                <span data-i18n="order.field.customer_id">客户ID</span>
                <input type="number" data-field="customerId"/>
            </label>
            <label class="c-inline-field" data-accept-only>
                <span data-i18n="order.field.purchase_id">对应发注ID</span>
                <input type="number" data-field="purchaseId"/>
            </label>
            <label class="c-inline-field c-inline-field-full">
                <span data-issue="取引先（下请公司）" data-accept="取引先（客户公司）"
                      data-i18n-issue="order.filter.customer_issue"
                      data-i18n-accept="order.filter.customer_accept">取引先（下请公司）</span>
                <input type="text" data-field="client"/>
            </label>
            <label class="c-inline-field">
                <span data-i18n="order.field.technician">技术者</span>
                <input type="text" data-field="engineer"/>
            </label>
            <label class="c-inline-field" data-accept-only>
                <span data-i18n="order.field.technician_id">技术人员ID</span>
                <input type="number" data-field="technicianId"/>
            </label>
            <label class="c-inline-field">
                <span data-i18n="order.field.status">状态</span>
                <select data-field="status"
                        data-issue-options="承认中,已受注,拒绝,已取消"
                        data-accept-options="已受注,拒绝,已取消"
                        data-default-option="请选择状态">
                </select>
            </label>
            <label class="c-inline-field">
                <span data-i18n="order.field.price">契约单价</span>
                <input type="text" data-field="price"/>
            </label>
            <label class="c-inline-field">
                <span data-i18n="order.field.hours">契约工时</span>
                <input type="text" data-field="hours"/>
            </label>
            <label class="c-inline-field c-inline-field-full">
                <span data-i18n="order.field.period">契约期间</span>
                <div class="c-inline-field-range">
                    <input type="date" data-field="start"/>
                    <span>~</span>
                    <input type="date" data-field="end"/>
                </div>
            </label>
            <label class="c-inline-field">
                <span data-i18n="order.field.created_at">创建时间</span>
                <input type="date" data-field="createdAt"/>
            </label>
            <label class="c-inline-field">
                <span data-i18n="order.field.created_by">创建人</span>
                <input type="text" data-field="creator"/>
            </label>
            <label class="c-inline-field">
                <span data-i18n="order.field.owner">负责人</span>
                <input type="text" data-field="owner"/>
            </label>
            <label class="c-inline-field">
                <span data-i18n="order.field.updated_at">修改时间</span>
                <input type="date" data-field="updatedAt"/>
            </label>
            <label class="c-inline-field">
                <span data-i18n="order.field.updated_by">修改人</span>
                <input type="text" data-field="updater"/>
            </label>
        </div>
    </div>
    <div class="c-modal-actions">
        <button class="c-btn c-btn-secondary" type="button" data-dialog-close data-i18n="common.close">关闭</button>
        <button class="c-btn c-btn-primary" type="button" data-dialog-close id="detailSave" data-i18n="common.save">保存</button>
    </div>
</dialog>
<script src="i18n.js"></script>
<script src="common.js"></script>
<script>
    (function () {
        const i18n = window.I18N;
        if (i18n) {
            i18n.init();
            i18n.apply();
        }
        const t = (key) => (i18n ? i18n.t(key) : key);
        const format = (key, vars) => (i18n ? i18n.format(key, vars) : key);
        const switches = Array.from(document.querySelectorAll(".c-switcher-group .c-toggle"));
        const swapNodes = Array.from(document.querySelectorAll("[data-issue][data-accept]"));
        const swapPlaceholders = Array.from(document.querySelectorAll("[data-issue-placeholder][data-accept-placeholder]"));
        const acceptOnlyFields = Array.from(document.querySelectorAll("[data-accept-only]"));
        const statusFilter = document.getElementById("statusFilter");
        const createBtn = document.getElementById("createBtn");
        const createDialogIssue = document.getElementById("createDialogIssue");
        const createDialogAccept = document.getElementById("createDialogAccept");
        const issueCreateSubmit = document.getElementById("issue-create-submit");
        const acceptCreateSubmit = document.getElementById("accept-create-submit");
        const detailDialog = document.getElementById("detailDialog");
        const detailTitle = document.getElementById("detailTitle");
        const detailSubtitle = document.getElementById("detailSubtitle");
        const detailSave = document.getElementById("detailSave");
        const dialogCloseButtons = Array.from(document.querySelectorAll("[data-dialog-close]"));
        const tableBody = document.getElementById("order-body");
        const tableInfo = document.getElementById("table-info");
        const searchBtn = document.getElementById("searchBtn");
        const resetBtn = document.getElementById("resetBtn");
        const pagination = document.getElementById("order-pagination");
        const paginationPages = document.getElementById("order-pagination-pages");
        const pageSummary = document.getElementById("page-summary");
        const pageSizeSelect = document.getElementById("page-size");
        const filters = {
            orderNo: document.getElementById("filter-order-no"),
            project: document.getElementById("filter-project"),
            customer: document.getElementById("filter-customer"),
            customerId: document.getElementById("filter-customer-id"),
            customerList: document.getElementById("filter-customer-list"),
            technician: document.getElementById("filter-technician"),
            status: statusFilter,
            onlySelf: document.getElementById("filter-only-self"),
            start: document.getElementById("filter-start"),
            end: document.getElementById("filter-end"),
        };

        const issueForm = {
            orderNo: document.getElementById("issue-order-no"),
            projectName: document.getElementById("issue-project-name"),
            customerName: document.getElementById("issue-customer-name"),
            customerId: document.getElementById("issue-customer-id"),
            customerList: document.getElementById("issue-customer-list"),
            technicianName: document.getElementById("issue-technician-name"),
            status: document.getElementById("issue-status"),
            price: document.getElementById("issue-price"),
            hours: document.getElementById("issue-hours"),
            start: document.getElementById("issue-start"),
            end: document.getElementById("issue-end"),
            owner: document.getElementById("issue-owner"),
            ownerList: document.getElementById("issue-owner-list"),
        };

        const acceptForm = {
            orderNo: document.getElementById("accept-order-no"),
            projectName: document.getElementById("accept-project-name"),
            purchaseId: document.getElementById("accept-purchase-id"),
            customerName: document.getElementById("accept-customer-name"),
            customerId: document.getElementById("accept-customer-id"),
            customerList: document.getElementById("accept-customer-list"),
            technicianName: document.getElementById("accept-technician-name"),
            technicianId: document.getElementById("accept-technician-id"),
            technicianList: document.getElementById("accept-technician-list"),
            status: document.getElementById("accept-status"),
            price: document.getElementById("accept-price"),
            hours: document.getElementById("accept-hours"),
            start: document.getElementById("accept-start"),
            end: document.getElementById("accept-end"),
            owner: document.getElementById("accept-owner"),
            ownerList: document.getElementById("accept-owner-list"),
        };

        const detailFields = {
            orderNo: document.querySelector('[data-field="orderNo"]'),
            project: document.querySelector('[data-field="project"]'),
            customerId: document.querySelector('[data-field="customerId"]'),
            purchaseId: document.querySelector('[data-field="purchaseId"]'),
            client: document.querySelector('[data-field="client"]'),
            engineer: document.querySelector('[data-field="engineer"]'),
            technicianId: document.querySelector('[data-field="technicianId"]'),
            status: document.querySelector('[data-field="status"]'),
            price: document.querySelector('[data-field="price"]'),
            hours: document.querySelector('[data-field="hours"]'),
            start: document.querySelector('[data-field="start"]'),
            end: document.querySelector('[data-field="end"]'),
            createdAt: document.querySelector('[data-field="createdAt"]'),
            creator: document.querySelector('[data-field="creator"]'),
            owner: document.querySelector('[data-field="owner"]'),
            updatedAt: document.querySelector('[data-field="updatedAt"]'),
            updater: document.querySelector('[data-field="updater"]'),
        };

        if (tableInfo) {
            tableInfo.textContent = format("order.table.info", { count: 0, page: 1 });
        }
        if (pageSummary) {
            pageSummary.textContent = format("order.table.summary", { count: 0, page: 1, total: 1 });
        }

        const statusClass = {
            "草稿": "c-tag-neutral",
            "承认中": "c-tag-warn",
            "已送付": "c-tag-info",
            "已受注": "c-tag-success",
            "已取消": "c-tag-danger",
            "拒绝": "c-tag-danger"
        };
        const statusLabelMap = {
            "草稿": "order.status.draft",
            "承认中": "order.status.approving",
            "已送付": "order.status.sent",
            "已受注": "order.status.accepted",
            "已取消": "order.status.canceled",
            "拒绝": "order.status.rejected"
        };

        let currentView = "issue";
        let currentPage = 1;
        let pageSize = 10;
        let totalPages = 1;
        let lastTotalCount = 0;
        let lastTotalPages = 1;
        let currentItems = [];
        let currentDetailId = null;
        let detailMode = "view";
        const issueCustomerMap = new Map();
        const acceptCustomerMap = new Map();
        const filterCustomerMap = new Map();
        const acceptTechnicianMap = new Map();

        const renderActions = (container) => {
            container.innerHTML = "";
            [
                { key: "order.action.edit", action: "edit", primary: false },
                { key: "order.action.view", action: "view", primary: true }
            ].forEach((item) => {
                const btn = document.createElement("button");
                btn.className = item.primary
                    ? "c-btn c-btn-lite c-btn-sm"
                    : "c-btn c-btn-ghost c-btn-sm";
                btn.type = "button";
                btn.textContent = t(item.key);
                btn.dataset.action = item.action;
                container.appendChild(btn);
            });
        }

        const fillStatusOptions = (select, view) => {
            if (!select) return;
            const options = (view === "accept"
                ? select.dataset.acceptOptions
                : select.dataset.issueOptions) || "";
            const values = options.split(",").map((v) => v.trim()).filter(Boolean);
            const defaultOption = select.dataset.defaultOption || "";
            select.innerHTML = "";
            if (defaultOption) {
                const opt = document.createElement("option");
                opt.value = defaultOption;
                if (defaultOption === "全部") {
                    opt.textContent = t("order.filter.status_all");
                    opt.dataset.i18n = "order.filter.status_all";
                } else if (defaultOption === "请选择状态") {
                    opt.textContent = t("order.filter.status_select");
                    opt.dataset.i18n = "order.filter.status_select";
                } else {
                    opt.textContent = defaultOption;
                }
                select.appendChild(opt);
            }
            values.forEach((value) => {
                const opt = document.createElement("option");
                opt.value = value;
                const labelKey = statusLabelMap[value];
                opt.textContent = t(labelKey || value);
                if (labelKey) {
                    opt.dataset.i18n = labelKey;
                }
                select.appendChild(opt);
            });
        }

        const applyViewLabels = (view) => {
            switches.forEach((btn) => {
                const active = btn.dataset.view === view;
                btn.classList.toggle("is-active", active);
                btn.setAttribute("aria-selected", active ? "true" : "false");
            });
            swapNodes.forEach((node) => {
                node.textContent = view === "accept" ? node.dataset.accept : node.dataset.issue;
            });
            swapPlaceholders.forEach((node) => {
                node.setAttribute(
                    "placeholder",
                    view === "accept" ? node.dataset.acceptPlaceholder : node.dataset.issuePlaceholder
                );
            });
            acceptOnlyFields.forEach((node) => {
                node.style.display = view === "accept" ? "" : "none";
            });
            if (createBtn) {
                const label = view === "accept" ? createBtn.dataset.accept : createBtn.dataset.issue;
                createBtn.textContent = `＋ ${label}`;
            }
            fillStatusOptions(statusFilter, view);
        };

        const setView = (view) => {
            currentView = view;
            currentPage = 1;
            applyViewLabels(view);
            fetchOrders();
        };

        const setDialogMode = (mode) => {
            const isView = mode === "view";
            detailMode = mode;
            if (detailTitle) {
                detailTitle.textContent = isView ? t("order.dialog.detail.view") : t("order.dialog.detail.edit");
            }
            if (detailSubtitle) {
                detailSubtitle.textContent = isView
                    ? t("order.dialog.detail.subtitle_view")
                    : t("order.dialog.detail.subtitle_edit");
            }
            if (detailSave) detailSave.style.display = isView ? "none" : "";
            Object.values(detailFields).forEach((field) => {
                if (!field) return;
                if (field.tagName === "SELECT") {
                    field.disabled = isView;
                    return;
                }
                if (field.type === "date") {
                    field.disabled = isView;
                } else {
                    field.readOnly = isView;
                }
            });
            if (detailFields.createdAt) detailFields.createdAt.readOnly = true;
            if (detailFields.updatedAt) detailFields.updatedAt.readOnly = true;
            if (detailFields.creator) detailFields.creator.readOnly = true;
            if (detailFields.updater) detailFields.updater.readOnly = true;
        }

        const formatPrice = (value) => {
            if (value === null || value === undefined || value === "") return "-";
            return String(value);
        }

        const formatHours = (value) => {
            if (value === null || value === undefined || value === "") return "-";
            return String(value);
        }

        const renderRows = (items, totalCount, page, totalPageCount) => {
            const count = Number.isFinite(totalCount) ? totalCount : items.length;
            totalPages = Number.isFinite(totalPageCount) ? totalPageCount : 1;
            lastTotalCount = count;
            lastTotalPages = totalPages;
            currentPage = Number.isFinite(page) ? page : 1;
            window.renderPagination(pagination, paginationPages, currentPage, totalPages);
            if (pageSummary) {
                pageSummary.textContent = format("order.table.summary", {
                    count,
                    page: currentPage,
                    total: totalPages
                });
            }
            if (!items.length) {
                tableBody.innerHTML = `<tr><td colspan="13" class="empty c-empty">${t("order.table.no_data")}</td></tr>`;
                tableInfo.textContent = format("order.table.info", {
                    count,
                    page: currentPage
                });
                return;
            }
            tableBody.innerHTML = items.map((item) => {
                const status = item.status || "草稿";
                const statusLabel = t(statusLabelMap[status] || status);
                const periodStart = item.period_start || "-";
                const periodEnd = item.period_end || "-";
                return `
            <tr data-id="${item.id}">
              <td>${item.order_no || "-"}</td>
              <td>
                <div class="c-truncate" title="${item.project_name || ""}">${item.project_name || "-"}</div>
                <div class="c-truncate" title="${item.customer_name || ""}">${item.customer_name || "-"}</div>
              </td>
              <td>${item.technician_name || "-"}</td>
              <td>${formatPrice(item.price)}</td>
              <td>${formatHours(item.working_hours)}</td>
              <td>
                <div>${periodStart}</div>
                <div>${periodEnd}</div>
              </td>
              <td>${item.created_at || "-"}</td>
              <td>${item.created_by || "-"}</td>
              <td>${item.person_in_charge || "-"}</td>
              <td>${item.updated_at || "-"}</td>
              <td>${item.updated_by || "-"}</td>
              <td><span class="c-tag ${statusClass[status] || "c-tag-neutral"}">${statusLabel}</span></td>
              <td><div class="row-actions c-row-actions" data-row-actions></div></td>
            </tr>
          `;
            }).join("");
            tableInfo.textContent = format("order.table.info", {
                count,
                page: currentPage
            });
            Array.from(document.querySelectorAll("[data-row-actions]")).forEach(renderActions);
        }

        const fetchOrders = () => {
            const params = new URLSearchParams();
            if (filters.orderNo.value.trim()) params.append("order_no", filters.orderNo.value.trim());
            if (filters.project.value.trim()) params.append("project_name", filters.project.value.trim());
            if (filters.customerId.value.trim()) params.append("customer_id", filters.customerId.value.trim());
            if (filters.technician.value.trim()) params.append("technician_name", filters.technician.value.trim());
            if (filters.status.value && filters.status.value !== "全部") params.append("status", filters.status.value);
            if (filters.onlySelf && filters.onlySelf.checked) params.append("only_self", "1");
            if (filters.start.value) params.append("created_start", filters.start.value);
            if (filters.end.value) params.append("created_end", filters.end.value);
            params.append("page", String(currentPage));
            params.append("page_size", String(pageSize));
            const baseUrl = currentView === "accept" ? "/api/sales-orders" : "/api/purchase-orders";
            fetch(`${baseUrl}?${params.toString()}`)
                .then((response) => response.json())
                .then((data) => {
                    const payload = normalizeApiResponse(data);
                    if (!payload.success) {
                        currentItems = [];
                        renderRows([], 0, 1, 1);
                        return;
                    }
                    const result = payload.data || {};
                    currentItems = Array.isArray(result.items) ? result.items : [];
                    renderRows(
                        currentItems,
                        result.total ?? 0,
                        result.page ?? 1,
                        result.total_pages ?? 1
                    );
                })
                .catch(() => {
                    currentItems = [];
                    renderRows([], 0, 1, 1);
                });
        }

        const openDetailDialog = (mode, item) => {
            if (!detailDialog || !item) return;
            fillStatusOptions(detailFields.status, currentView);
            if (detailFields.orderNo) detailFields.orderNo.value = item.order_no || "";
            if (detailFields.project) detailFields.project.value = item.project_name || "";
            if (detailFields.customerId) detailFields.customerId.value = item.customer_id || "";
            if (detailFields.purchaseId) detailFields.purchaseId.value = item.purchase_id || "";
            if (detailFields.client) detailFields.client.value = item.customer_name || "";
            if (detailFields.engineer) detailFields.engineer.value = item.technician_name || "";
            if (detailFields.technicianId) detailFields.technicianId.value = item.technician_id || "";
            if (detailFields.status && item.status) detailFields.status.value = item.status;
            if (detailFields.price) detailFields.price.value = item.price || "";
            if (detailFields.hours) detailFields.hours.value = item.working_hours || "";
            if (detailFields.start) detailFields.start.value = item.period_start || "";
            if (detailFields.end) detailFields.end.value = item.period_end || "";
            if (detailFields.createdAt) detailFields.createdAt.value = item.created_at || "";
            if (detailFields.creator) detailFields.creator.value = item.created_by || "";
            if (detailFields.owner) detailFields.owner.value = item.person_in_charge || "";
            if (detailFields.updatedAt) detailFields.updatedAt.value = item.updated_at || "";
            if (detailFields.updater) detailFields.updater.value = item.updated_by || "";

            currentDetailId = item.id;
            setDialogMode(mode);
            detailDialog.showModal();
        }

        const buildIssuePayload = (fromDetail) => {
            return {
                order_no: fromDetail ? detailFields.orderNo.value.trim() : issueForm.orderNo.value.trim(),
                project_name: fromDetail ? detailFields.project.value.trim() : issueForm.projectName.value.trim(),
                customer_id: Number(fromDetail ? detailFields.customerId.value : issueForm.customerId.value) || 0,
                customer_name: fromDetail ? detailFields.client.value.trim() : issueForm.customerName.value.trim(),
                technician_name: fromDetail ? detailFields.engineer.value.trim() : issueForm.technicianName.value.trim(),
                status: fromDetail ? detailFields.status.value : issueForm.status.value,
                price: fromDetail ? detailFields.price.value.trim() : issueForm.price.value.trim(),
                working_hours: fromDetail ? detailFields.hours.value.trim() : issueForm.hours.value.trim(),
                period_start: fromDetail ? detailFields.start.value : issueForm.start.value,
                period_end: fromDetail ? detailFields.end.value : issueForm.end.value,
                person_in_charge: fromDetail ? detailFields.owner.value.trim() : issueForm.owner.value.trim(),
            };
        }

        const buildAcceptPayload = (fromDetail) => {
            return {
                order_no: fromDetail ? detailFields.orderNo.value.trim() : acceptForm.orderNo.value.trim(),
                project_name: fromDetail ? detailFields.project.value.trim() : acceptForm.projectName.value.trim(),
                purchase_id: Number(fromDetail ? detailFields.purchaseId.value : acceptForm.purchaseId.value) || 0,
                customer_id: Number(fromDetail ? detailFields.customerId.value : acceptForm.customerId.value) || 0,
                customer_name: fromDetail ? detailFields.client.value.trim() : acceptForm.customerName.value.trim(),
                technician_id: Number(fromDetail ? detailFields.technicianId.value : acceptForm.technicianId.value) || 0,
                technician_name: fromDetail ? detailFields.engineer.value.trim() : acceptForm.technicianName.value.trim(),
                status: fromDetail ? detailFields.status.value : acceptForm.status.value,
                price: fromDetail ? detailFields.price.value.trim() : acceptForm.price.value.trim(),
                working_hours: fromDetail ? detailFields.hours.value.trim() : acceptForm.hours.value.trim(),
                period_start: fromDetail ? detailFields.start.value : acceptForm.start.value,
                period_end: fromDetail ? detailFields.end.value : acceptForm.end.value,
                person_in_charge: fromDetail ? detailFields.owner.value.trim() : acceptForm.owner.value.trim(),
            };
        }

        const submitCreate = (view) => {
            const payload = view === "accept" ? buildAcceptPayload(false) : buildIssuePayload(false);
            const url = view === "accept" ? "/api/sales-orders" : "/api/purchase-orders";
            fetch(url, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload),
            })
                .then((response) => response.json())
                .then((data) => {
                    const responsePayload = normalizeApiResponse(data);
                    if (!responsePayload.success) {
                        alert(responsePayload.message || t("order.action.create_failed"));
                        return;
                    }
                    if (view === "accept" && createDialogAccept) createDialogAccept.close();
                    if (view === "issue" && createDialogIssue) createDialogIssue.close();
                    fetchOrders();
                })
                .catch(() => {
                    alert(t("order.action.create_failed_retry"));
                });
        }

        const submitUpdate = () => {
            if (!currentDetailId) return;
            const payload = currentView === "accept" ? buildAcceptPayload(true) : buildIssuePayload(true);
            const url = currentView === "accept"
                ? `/api/sales-orders/${currentDetailId}`
                : `/api/purchase-orders/${currentDetailId}`;
            fetch(url, {
                method: "PUT",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload),
            })
                .then((response) => response.json())
                .then((data) => {
                    const responsePayload = normalizeApiResponse(data);
                    if (!responsePayload.success) {
                        alert(responsePayload.message || t("order.action.save_failed"));
                        return;
                    }
                    if (detailDialog) detailDialog.close();
                    fetchOrders();
                })
                .catch(() => {
                    alert(t("order.action.save_failed_retry"));
                });
        }

        const renderCustomerOptions = (listEl, map, items) => {
            map.clear();
            listEl.innerHTML = "";
            items.forEach((item) => {
                if (!item || !item.company_name) return;
                map.set(item.company_name, item.id);
                const opt = document.createElement("option");
                opt.value = item.company_name;
                listEl.appendChild(opt);
            });
        }

        const fetchCustomerOptions = (inputEl, listEl, map) => {
            const keyword = inputEl.value.trim();
            if (!keyword) {
                listEl.innerHTML = "";
                map.clear();
                return;
            }
            const params = new URLSearchParams();
            params.append("company_name", keyword);
            params.append("page", "1");
            params.append("page_size", "10");
            fetch(`/api/customers?${params.toString()}`)
                .then((response) => response.json())
                .then((data) => {
                    const payload = normalizeApiResponse(data);
                    const result = payload.data || {};
                    const items = Array.isArray(result.items) ? result.items : [];
                    renderCustomerOptions(listEl, map, items);
                })
                .catch(() => {
                    listEl.innerHTML = "";
                    map.clear();
                });
        }

        const bindCustomerLookup = (inputEl, idEl, listEl, map) => {
            if (!inputEl || !idEl || !listEl) return;
            inputEl.addEventListener("input", () => {
                fetchCustomerOptions(inputEl, listEl, map);
                idEl.value = "";
            });
            inputEl.addEventListener("change", () => {
                const id = map.get(inputEl.value.trim());
                idEl.value = id ? String(id) : "";
            });
        }

        const fetchEmployeeOptions = (inputEl, listEl) => {
            const keyword = inputEl.value.trim();
            if (!keyword) {
                listEl.innerHTML = "";
                return;
            }
            const params = new URLSearchParams();
            params.append("keyword", keyword);
            fetch(`/api/employees?${params.toString()}`)
                .then((response) => response.json())
                .then((data) => {
                    const payload = normalizeApiResponse(data);
                    const result = payload.data || {};
                    const items = Array.isArray(result.items) ? result.items : [];
                    listEl.innerHTML = "";
                    items.forEach((item) => {
                        if (!item || !item.name) return;
                        const opt = document.createElement("option");
                        opt.value = item.name;
                        listEl.appendChild(opt);
                    });
                })
                .catch(() => {
                    listEl.innerHTML = "";
                });
        }

        const bindOwnerLookup = (form) => {
            if (!form.owner || !form.ownerList) return;
            form.owner.addEventListener("input", () => {
                fetchEmployeeOptions(form.owner, form.ownerList);
            });
        }

        const renderTechnicianOptions = (listEl, map, items) => {
            map.clear();
            listEl.innerHTML = "";
            items.forEach((item) => {
                if (!item || !item.name) return;
                map.set(item.name, item.employee_id);
                const opt = document.createElement("option");
                opt.value = item.name;
                listEl.appendChild(opt);
            });
        }

        const fetchTechnicianOptions = (inputEl, listEl, map) => {
            const keyword = inputEl.value.trim();
            if (!keyword) {
                listEl.innerHTML = "";
                map.clear();
                return;
            }
            const params = new URLSearchParams();
            params.append("keyword", keyword);
            fetch(`/api/technicians?${params.toString()}`)
                .then((response) => response.json())
                .then((data) => {
                    const payload = normalizeApiResponse(data);
                    const result = payload.data || {};
                    const items = Array.isArray(result.items) ? result.items : [];
                    renderTechnicianOptions(listEl, map, items);
                })
                .catch(() => {
                    listEl.innerHTML = "";
                    map.clear();
                });
        }

        const bindTechnicianLookup = (inputEl, idEl, listEl, map) => {
            if (!inputEl || !idEl || !listEl) return;
            inputEl.addEventListener("input", () => {
                fetchTechnicianOptions(inputEl, listEl, map);
                idEl.value = "";
            });
            inputEl.addEventListener("change", () => {
                const id = map.get(inputEl.value.trim());
                idEl.value = id ? String(id) : "";
            });
        }

        switches.forEach((btn) => {
            btn.addEventListener("click", () => setView(btn.dataset.view));
        });

        if (createBtn) {
            createBtn.addEventListener("click", () => {
                if (currentView === "accept") {
                    if (createDialogAccept) createDialogAccept.showModal();
                } else if (createDialogIssue) {
                    createDialogIssue.showModal();
                }
            });
        }

        if (issueCreateSubmit) {
            issueCreateSubmit.addEventListener("click", () => submitCreate("issue"));
        }
        if (acceptCreateSubmit) {
            acceptCreateSubmit.addEventListener("click", () => submitCreate("accept"));
        }

        if (searchBtn) {
            searchBtn.addEventListener("click", () => {
                currentPage = 1;
                fetchOrders();
            });
        }

        if (resetBtn) {
            resetBtn.addEventListener("click", () => {
                Object.values(filters).forEach((field) => {
                    if (!field) return;
                    if (field.type === "checkbox") {
                        field.checked = false;
                    } else if (field.tagName === "SELECT") {
                        field.value = "全部";
                    } else {
                        field.value = "";
                    }
                });
                filterCustomerMap.clear();
                currentPage = 1;
                fetchOrders();
            });
        }

        window.bindPagination(pagination, (value) => {
            if (value === "prev") {
                currentPage = Math.max(1, currentPage - 1);
            } else if (value === "next") {
                currentPage = Math.min(totalPages, currentPage + 1);
            } else {
                const targetPage = Number(value);
                if (!Number.isNaN(targetPage)) currentPage = targetPage;
            }
            fetchOrders();
        });
        if (pageSizeSelect) {
            pageSizeSelect.addEventListener("change", () => {
                const value = parseInt(pageSizeSelect.value, 10);
                pageSize = Number.isFinite(value) ? value : 10;
                currentPage = 1;
                fetchOrders();
            });
        }

        if (tableBody) {
            tableBody.addEventListener("click", (event) => {
                const btn = event.target.closest("button[data-action]");
                if (!btn) return;
                const row = btn.closest("tr");
                if (!row) return;
                const id = row.dataset.id;
                const item = currentItems.find((entry) => String(entry.id) === String(id));
                if (!item) return;
                openDetailDialog(btn.dataset.action, item);
            });
        }

        if (detailSave) {
            detailSave.addEventListener("click", () => {
                if (detailMode === "edit") {
                    submitUpdate();
                }
            });
        }

        dialogCloseButtons.forEach((button) => {
            button.addEventListener("click", () => {
                const dialog = button.closest("dialog");
                if (dialog) dialog.close();
            });
        });

        bindCustomerLookup(issueForm.customerName, issueForm.customerId, issueForm.customerList, issueCustomerMap);
        bindCustomerLookup(acceptForm.customerName, acceptForm.customerId, acceptForm.customerList, acceptCustomerMap);
        bindCustomerLookup(filters.customer, filters.customerId, filters.customerList, filterCustomerMap);
        bindOwnerLookup(issueForm);
        bindOwnerLookup(acceptForm);
        bindTechnicianLookup(acceptForm.technicianName, acceptForm.technicianId, acceptForm.technicianList, acceptTechnicianMap);

        const refreshI18n = () => {
            if (i18n) {
                i18n.init();
                i18n.apply();
            }
            applyViewLabels(currentView);
            if (detailFields.status) {
                fillStatusOptions(detailFields.status, currentView);
            }
            renderRows(currentItems, lastTotalCount, currentPage, lastTotalPages);
        };

        if (window && window.addEventListener) {
            window.addEventListener("storage", (event) => {
                if (!event || event.key !== "app_lang") return;
                refreshI18n();
            });
            window.addEventListener("i18n:change", refreshI18n);
        }

        setView("issue");
    })();
</script>
</body>
</html>
