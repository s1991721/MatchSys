<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/favicon-32.png" type="image/png" sizes="32x32">
    <link rel="stylesheet" href="common.css">
    <link rel="stylesheet" href="components.css">
    <title>权限管理</title>
    <style>
        body {
            background: transparent;
        }

        .permission-grid {
            display: grid;
            grid-template-columns: minmax(280px, 0.9fr) minmax(520px, 1.6fr);
            gap: 16px;
            align-items: start;
        }

        @media (max-width: 1100px) {
            .permission-grid {
                grid-template-columns: 1fr;
            }
        }

        .permission-subtitle {
            margin: 6px 0 0;
            color: var(--muted);
            font-size: 13px;
        }

        .role-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .menu-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .role-menu-checklist {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .role-menu-check {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            padding: 6px 8px;
            border-radius: 8px;
            background: #fff;
            border: 1px solid #e6ecf6;
        }

        .role-menu-check span {
            color: var(--muted);
            font-size: 12px;
        }

        .role-menu-check input {
            accent-color: var(--primary);
        }

        .role-dialog-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 6px 12px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 10px;
        }

        .role-dialog-count {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            cursor: pointer;
        }

        .role-dialog-count input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
        }

    </style>
</head>
<body>
<div class="page page-wide permission-page">
    <div class="permission-grid">
        <section class="c-card">
            <div class="c-card-header c-card-header-gradient">
                <div>
                    <h3 class="c-panel-title">角色管理</h3>
                    <p class="permission-subtitle">当前系统内置角色，仅展示，不支持新建。</p>
                </div>
                <span class="c-tag c-tag-neutral">只读</span>
            </div>
            <div class="c-table-wrapper">
                <table class="c-table c-table-hover c-table-center">
                    <thead>
                    <tr>
                        <th>角色</th>
                        <th>角色描述</th>
                        <th class="c-actions-col">操作</th>
                    </tr>
                    </thead>
                    <tbody id="role-body"></tbody>
                </table>
            </div>
        </section>

        <section class="c-card">
            <div class="c-card-header c-card-header-gradient">
                <div>
                    <h3 class="c-panel-title">菜单管理</h3>
                    <p class="permission-subtitle">index.html 中所有功能列表由此维护。</p>
                </div>
                <button class="c-btn c-btn-primary c-btn-strong" id="menu-add" type="button">+ 新增菜单</button>
            </div>
            <div class="c-table-wrapper">
                <table class="c-table c-table-hover c-table-center">
                    <thead>
                    <tr>
                        <th>菜单名</th>
                        <th>页面文件</th>
                        <th>排序</th>
                        <th class="c-actions-col">操作</th>
                    </tr>
                    </thead>
                    <tbody id="menu-body"></tbody>
                </table>
            </div>
        </section>
    </div>
</div>

<dialog class="c-dialog" id="menu-dialog">
    <div class="c-dialog-header">
        <h3 id="menu-dialog-title">新增菜单</h3>
        <button class="c-dialog-close" type="button" aria-label="关闭" data-dialog-close>×</button>
    </div>
    <div class="c-dialog-body">
        <form id="menu-form" class="form-grid">
            <label class="c-field">
                <span>菜单名</span>
                <input id="menu-name" type="text" required>
            </label>
            <label class="c-field">
                <span>页面文件</span>
                <input id="menu-page" type="text" placeholder="例如：customer.html" required>
            </label>
            <label class="c-field">
                <span>排序</span>
                <input id="menu-sort" type="number" min="1" step="1" placeholder="例如：10" required>
            </label>
        </form>
    </div>
    <div class="c-dialog-actions">
        <button class="c-btn c-btn-secondary" type="button" data-dialog-close>取消</button>
        <button class="c-btn c-btn-primary" id="menu-save" type="button">保存</button>
    </div>
</dialog>

<dialog class="c-dialog" id="role-dialog">
    <div class="c-dialog-header">
        <h3 id="role-dialog-title">角色详情</h3>
        <button class="c-dialog-close" type="button" aria-label="关闭" data-dialog-close>×</button>
    </div>
    <div class="c-dialog-body">
        <div class="role-dialog-toolbar">
            <label class="role-dialog-count">
                <input type="checkbox" id="role-master-check" aria-label="全选">
                <span>已选</span>
                <strong id="role-selected-count">0</strong>
                <span>项</span>
            </label>
        </div>
        <div id="role-dialog-body" class="c-card c-card-compact"></div>
    </div>
    <div class="c-dialog-actions">
        <button class="c-btn c-btn-secondary" type="button" data-dialog-close>取消</button>
        <button class="c-btn c-btn-primary" type="button" id="role-save">保存</button>
    </div>
</dialog>

<script src="common.js"></script>
<script>
  const menuDialog = document.getElementById("menu-dialog");
  const menuDialogTitle = document.getElementById("menu-dialog-title");
  const menuForm = document.getElementById("menu-form");
  const menuName = document.getElementById("menu-name");
  const menuPage = document.getElementById("menu-page");
  const menuSort = document.getElementById("menu-sort");
  const menuBody = document.getElementById("menu-body");
  const roleBody = document.getElementById("role-body");
  const addBtn = document.getElementById("menu-add");
  const saveBtn = document.getElementById("menu-save");
  const roleDialog = document.getElementById("role-dialog");
  const roleDialogTitle = document.getElementById("role-dialog-title");
  const roleDialogBody = document.getElementById("role-dialog-body");
  const roleSaveBtn = document.getElementById("role-save");
  const roleMasterCheck = document.getElementById("role-master-check");
  const roleSelectedCount = document.getElementById("role-selected-count");
  let activeRoleId = null;

  let cachedMenus = [];
  let cachedRoles = [];

  const requestJson = async (url, options = {}) => {
    const response = await window.fetchWithAuth(url, options);
    const raw = await response.json();
    return window.normalizeApiResponse(raw);
  };

  const getAllMenus = () => {
    return [...cachedMenus].sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));
  };

  const openMenuDialog = (mode, row) => {
    menuDialog.dataset.editing = "";
    menuDialog.dataset.menuId = "";
    if (mode === "edit" && row) {
      menuDialog.dataset.editing = "1";
      menuDialog.dataset.menuId = row.dataset.id || "";
      menuDialogTitle.textContent = "编辑菜单";
      menuName.value = row.dataset.name || "";
      menuPage.value = row.dataset.page || "";
      menuSort.value = row.dataset.sort || "";
    } else {
      menuDialogTitle.textContent = "新增菜单";
      menuForm.reset();
      menuSort.value = "";
    }
    menuDialog.showModal();
  };

  const renderMenus = (items) => {
    menuBody.innerHTML = "";
    items.forEach((menu) => {
      const row = document.createElement("tr");
      row.dataset.id = String(menu.id || "");
      row.dataset.name = menu.menu_name || "";
      row.dataset.page = menu.menu_html || "";
      row.dataset.sort = String(menu.sort_order ?? "");
      row.innerHTML = `
        <td>${menu.menu_name || ""}</td>
        <td>${menu.menu_html || ""}</td>
        <td>${menu.sort_order ?? ""}</td>
        <td class="menu-actions">
          <button class="c-btn c-btn-lite c-btn-sm" data-action="edit">编辑</button>
          <button class="c-btn c-btn-danger c-btn-sm" data-action="delete">删除</button>
        </td>
      `;
      menuBody.appendChild(row);
    });
  };

  const renderRoles = (items) => {
    roleBody.innerHTML = "";
    const roleClassMap = {
      "技术者": "c-pill-primary",
      "营业": "c-pill-info",
      "管理员": "c-pill-warn"
    };
    items.forEach((role) => {
      const pillClass = roleClassMap[role.role_name] || "c-pill-primary";
      const row = document.createElement("tr");
      row.dataset.id = String(role.id || "");
      row.innerHTML = `
        <td>
          <span class="role-badge">
            <span class="c-pill ${pillClass}">${role.role_name || ""}</span>
          </span>
        </td>
        <td>${role.description || ""}</td>
        <td class="menu-actions">
          <button class="c-btn c-btn-lite c-btn-sm" data-role-id="${role.id || ""}">详情</button>
        </td>
      `;
      roleBody.appendChild(row);
    });
  };

  const loadMenus = async () => {
    const res = await requestJson("/api/menus", { method: "GET" });
    if (!res.success) return;
    cachedMenus = res.data?.items || [];
    renderMenus(cachedMenus);
  };

  const loadRoles = async () => {
    const res = await requestJson("/api/roles", { method: "GET" });
    if (!res.success) return;
    cachedRoles = res.data?.items || [];
    renderRoles(cachedRoles);
  };

  addBtn.addEventListener("click", () => openMenuDialog("add"));

  menuBody.addEventListener("click", (event) => {
    const btn = event.target.closest("[data-action]");
    if (!btn) return;
    const row = btn.closest("tr");
    if (!row) return;
    if (btn.dataset.action === "edit") {
      openMenuDialog("edit", row);
      return;
    }
    if (btn.dataset.action === "delete") {
      const menuId = row.dataset.id;
      if (!menuId) return;
      if (!confirm(`确定删除菜单「${row.dataset.name || "未命名"}」吗？`)) return;
      requestJson(`/api/menus/${menuId}`, { method: "DELETE" })
        .then((res) => {
          if (res.success) {
            loadMenus();
          }
        });
    }
  });

  saveBtn.addEventListener("click", () => {
    if (!menuForm.reportValidity()) return;
    const name = menuName.value.trim();
    const page = menuPage.value.trim();
    const sort = menuSort.value.trim();
    if (menuDialog.dataset.editing) {
      const menuId = menuDialog.dataset.menuId;
      if (!menuId) return;
      requestJson(`/api/menus/${menuId}`, {
        method: "PUT",
        body: JSON.stringify({
          menu_name: name,
          menu_html: page,
          sort_order: sort
        })
      }).then((res) => {
        if (res.success) {
          menuDialog.close();
          loadMenus();
        }
      });
    } else {
      requestJson("/api/menus", {
        method: "POST",
        body: JSON.stringify({
          menu_name: name,
          menu_html: page,
          sort_order: sort
        })
      }).then((res) => {
        if (res.success) {
          menuDialog.close();
          loadMenus();
        }
      });
    }
  });

  roleBody.addEventListener("click", (event) => {
    const btn = event.target.closest("[data-role-id]");
    if (!btn) return;
    const roleId = Number(btn.dataset.roleId || 0);
    const role = cachedRoles.find((item) => item.id === roleId);
    if (!role) return;
    const hasAll = role.menu_list === "*";
    const menuSet = new Set(Array.isArray(role.menu_list) ? role.menu_list : []);
    const allMenus = getAllMenus();
    activeRoleId = roleId;
    roleDialogTitle.textContent = `${role.role_name || ""} - 角色详情`;
    roleDialogBody.innerHTML = allMenus.length
      ? `<div class="role-menu-checklist">${allMenus.map(item => `
          <label class="role-menu-check">
            <input type="checkbox" value="${item.menu_html}" ${(hasAll || menuSet.has(item.menu_html)) ? "checked" : ""}>
            <strong>${item.menu_name}</strong>
            <span>${item.menu_html}</span>
          </label>
        `).join("")}</div>`
      : "<p class=\"permission-subtitle\">暂无菜单</p>";
    updateRoleSelectedCount();
    roleDialog.showModal();
  });

  menuDialog.addEventListener("click", (event) => {
    if (event.target.matches("[data-dialog-close]")) {
      menuDialog.close();
    }
  });

  roleDialog.addEventListener("click", (event) => {
    if (event.target.matches("[data-dialog-close]")) {
      roleDialog.close();
    }
  });

  roleSaveBtn.addEventListener("click", () => {
    if (!activeRoleId) return;
    const selected = Array.from(roleDialogBody.querySelectorAll("input[type=\"checkbox\"]"))
      .filter((input) => input.checked)
      .map((input) => input.value)
      .filter((value) => value);
    const total = roleDialogBody.querySelectorAll("input[type=\"checkbox\"]").length;
    const payloadMenuList = total > 0 && selected.length === total ? "*" : selected;
    requestJson(`/api/roles/${activeRoleId}`, {
      method: "PUT",
      body: JSON.stringify({
        role_name: cachedRoles.find((item) => item.id === activeRoleId)?.role_name || "",
        description: cachedRoles.find((item) => item.id === activeRoleId)?.description || "",
        menu_list: payloadMenuList
      })
    }).then((res) => {
      if (res.success) {
        roleDialog.close();
        loadRoles();
      }
    });
  });

  const updateRoleSelectedCount = () => {
    const allChecks = roleDialogBody.querySelectorAll("input[type=\"checkbox\"]");
    const count = roleDialogBody.querySelectorAll("input[type=\"checkbox\"]:checked").length;
    const total = allChecks.length;
    if (roleSelectedCount) {
      roleSelectedCount.textContent = String(count);
    }
    if (roleMasterCheck) {
      if (total > 0 && count === total) {
        roleMasterCheck.indeterminate = false;
        roleMasterCheck.checked = true;
      } else {
        roleMasterCheck.checked = false;
        roleMasterCheck.indeterminate = total > 0;
      }
    }
  };

  roleDialogBody.addEventListener("change", (event) => {
    if (event.target.matches("input[type=\"checkbox\"]")) {
      updateRoleSelectedCount();
    }
  });

  roleMasterCheck.addEventListener("click", () => {
    roleDialogBody.querySelectorAll("input[type=\"checkbox\"]").forEach((input) => {
      input.checked = true;
    });
    updateRoleSelectedCount();
  });

  loadMenus();
  loadRoles();
</script>
</body>
</html>
