<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="/favicon-32.png" type="image/png" sizes="32x32">
    <link rel="stylesheet" href="common.css">
    <link rel="stylesheet" href="components.css">
    <title data-i18n="personnel.title">社内人员管理</title>
    <style>
        .permission-editor {
            display: grid;
            grid-template-columns: minmax(200px, 0.9fr) minmax(320px, 1.6fr);
            gap: 16px;
            align-items: start;
        }

        @media (max-width: 900px) {
            .permission-editor {
                grid-template-columns: 1fr;
            }
        }

        .permission-section {
            border: 1px solid #e4e9f4;
            border-radius: 18px;
            padding: 16px;
            background: #f6f8ff;
        }

        .permission-section-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 10px;
        }

        .permission-section-title {
            margin: 0;
            font-size: 16px;
            font-weight: 800;
        }

        .permission-section-note {
            color: var(--muted);
            font-size: 12px;
        }

        .permission-role-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }

        .permission-role-option {
            position: relative;
            border-radius: 16px;
            border: 1px solid #dfe6f5;
            background: #fff;
            padding: 22px 16px 16px;
            cursor: pointer;
        }

        .permission-role-option input {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        .permission-role-meta strong {
            display: block;
            font-size: 15px;
            font-weight: 700;
        }

        .permission-role-meta span {
            display: block;
            color: var(--muted);
            font-size: 12px;
            margin-top: 4px;
        }

        .permission-section .c-dialog-count {
            display: inline-flex !important;
            flex-direction: row !important;
            align-items: center !important;
            gap: 8px;
            white-space: nowrap;
            line-height: 1;
            flex-wrap: nowrap;
        }

        .permission-section .c-dialog-count span,
        .permission-section .c-dialog-count strong {
            display: inline-flex;
        }

        .permission-count-inline {
            display: inline-flex !important;
            flex-direction: row !important;
            align-items: center !important;
            gap: 8px;
        }

        .permission-section .c-dialog-count input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        .permission-section .c-card-compact {
            background: #fff;
        }

        .permission-section .role-menu-checklist {
            gap: 10px;
            max-height: 420px;
            overflow-y: auto;
            padding-right: 6px;
        }

        .permission-section .role-menu-check {
            display: grid;
            grid-template-columns: 18px 1fr;
            align-items: center;
            padding: 10px 12px;
            border-radius: 12px;
            min-height: 44px;
        }

        .permission-section .role-menu-text {
            display: flex;
            align-items: baseline;
            gap: 10px;
            min-width: 0;
            flex-wrap: wrap;
        }

        .permission-section .role-menu-text strong {
            font-size: 14px;
            font-weight: 700;
        }

        .permission-section .role-menu-text span {
            font-size: 12px;
            color: var(--muted);
        }

    </style>
</head>
<body class="c-form-page personnel-page">
<div class="page">
    <section class="c-card">
        <div class="filters c-filter-panel">
            <div class="filter-grid c-filter-grid-wide">
                <label>
                    <span data-i18n="personnel.filter.keyword">搜索（姓名 / 邮箱 / 手机 / 部门 / 职位）</span>
                    <input id="searchInput" type="search" placeholder="输入关键字" data-i18n-placeholder="personnel.filter.keyword_placeholder"/>
                </label>
                <label>
                    <span data-i18n="personnel.filter.department">部门</span>
                    <select id="deptSelect">
                        <option value="all">全部部门</option>
                    </select>
                </label>
            </div>
            <div class="filter-actions c-filter-actions-bar">
                <div class="filter-actions-left">
                    <button type="button" class="c-btn c-btn-primary c-btn-lg c-btn-strong" id="addBtn" data-i18n="personnel.action.add">＋ 新增人员
                    </button>
                </div>
                <div class="filter-actions-right c-filter-actions-group">
                    <button type="button" class="c-btn c-btn-primary" id="applyFilterBtn" data-i18n="common.search">搜索</button>
                    <button type="button" class="c-btn c-btn-warn" id="resetBtn" data-i18n="common.reset">重置</button>
                </div>
            </div>
        </div>

        <div class="table-actions c-table-actions">
        </div>

        <div class="table-wrapper c-table-wrapper">
            <table class="c-table c-table-hover c-table-center">
                <thead>
                <tr>
                    <th data-i18n="personnel.table.name">姓名</th>
                    <th data-i18n="personnel.table.department">部门</th>
                    <th data-i18n="personnel.table.position">职位</th>
                    <th data-i18n="personnel.table.phone">手机</th>
                    <th data-i18n="personnel.table.email">邮箱</th>
                    <th data-i18n="personnel.table.hire_date">入职日期</th>
                    <th class="c-actions-col" data-i18n="personnel.table.actions">操作</th>
                </tr>
                </thead>
                <tbody id="tableBody">
                <tr>
                    <td colspan="7" class="empty c-empty" data-i18n="common.loading">加载中…</td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="pagination c-pagination" id="pagination">
            <div class="pagination-summary">
                <span id="summaryText">共 0 人</span>
            </div>
            <div class="pagination-pages" id="paginationPages"></div>
        </div>
    </section>
</div>

<div class="modal" id="employeeModal" aria-hidden="true">
    <div class="modal-card c-card c-card-pad">
        <div class="modal-header">
            <h4 id="modalTitle">新增人员</h4>
            <button class="modal-close" id="modalClose" aria-label="关闭" data-i18n-aria="common.close">×</button>
        </div>
        <form id="employeeForm" class="modal-body">
            <div class="form-grid">
                <label>
                    <span data-i18n="personnel.field.name">姓名 *</span>
                    <input id="fieldName" type="text" required/>
                </label>
                <label>
                    <span data-i18n="personnel.field.gender">性别</span>
                    <select id="fieldGender">
                        <option value="" data-i18n="personnel.gender.unset">未设置</option>
                        <option value="1" data-i18n="personnel.gender.male">男</option>
                        <option value="2" data-i18n="personnel.gender.female">女</option>
                        <option value="0" data-i18n="personnel.gender.unknown">未知</option>
                    </select>
                </label>
                <label>
                    <span data-i18n="personnel.field.birthday">生日</span>
                    <input id="fieldBirthday" type="date"/>
                </label>
                <label>
                    <span data-i18n="personnel.field.department">部门</span>
                    <input id="fieldDepartment" type="text"/>
                </label>
                <label>
                    <span data-i18n="personnel.field.position">职位</span>
                    <input id="fieldPosition" type="text"/>
                </label>
                <label>
                    <span data-i18n="personnel.field.phone">手机</span>
                    <input id="fieldPhone" type="text"/>
                </label>
                <label>
                    <span data-i18n="personnel.field.email">邮箱</span>
                    <input id="fieldEmail" type="email"/>
                </label>
                <label>
                    <span data-i18n="personnel.field.address">住址</span>
                    <input id="fieldAddress" type="text"/>
                </label>
                <label>
                    <span data-i18n="personnel.field.emergency_name">紧急联系人姓名</span>
                    <input id="fieldEmergencyName" type="text"/>
                </label>
                <label>
                    <span data-i18n="personnel.field.emergency_phone">紧急联系人电话</span>
                    <input id="fieldEmergencyPhone" type="text"/>
                </label>
                <label>
                    <span data-i18n="personnel.field.emergency_relation">紧急联系人关系</span>
                    <input id="fieldEmergencyRelation" type="text"/>
                </label>
                <label>
                    <span data-i18n="personnel.field.hire_date">入职日期</span>
                    <input id="fieldHireDate" type="date"/>
                </label>
                <label>
                    <span data-i18n="personnel.field.leave_date">离职日期</span>
                    <input id="fieldLeaveDate" type="date"/>
                </label>
            </div>
            <div class="modal-actions">
                <button type="button" class="c-btn c-btn-secondary" id="cancelBtn" data-i18n="common.cancel">取消</button>
                <button type="button" class="c-btn c-btn-danger" id="deleteBtn" hidden data-i18n="common.delete">删除人员</button>
                <button type="submit" class="c-btn c-btn-primary" id="saveBtn" data-i18n="common.save">保存</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" id="permissionModal" aria-hidden="true">
    <div class="modal-card c-card c-card-pad">
        <div class="modal-header">
            <h4 data-i18n="personnel.permission.title">权限编辑</h4>
            <button class="modal-close" id="permissionClose" aria-label="关闭" data-i18n-aria="common.close">×</button>
        </div>
        <div class="modal-body">
            <div class="permission-editor">
                <section class="permission-section">
                    <div class="permission-section-head">
                        <h5 class="permission-section-title">角色</h5>
                        <span class="permission-section-note">选择角色后自动勾选菜单，可继续手动调整。</span>
                    </div>
                    <div class="permission-role-list" id="permissionRoleList"></div>
                </section>
                <section class="permission-section">
                    <div class="permission-section-head">
                        <h5 class="permission-section-title">菜单权限</h5>
                        <span class="permission-section-note">系统全部菜单</span>
                    </div>
                    <div class="c-dialog-toolbar">
                        <label class="c-dialog-count permission-count-inline">
                            <input type="checkbox" id="permissionMenuMasterCheck" aria-label="全选">
                            <span>已选</span>
                            <strong id="permissionMenuSelectedCount">0</strong>
                            <span>项</span>
                        </label>
                    </div>
                    <div class="c-card c-card-compact">
                        <div class="role-menu-checklist" id="permissionMenuList"></div>
                    </div>
                </section>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="c-btn c-btn-secondary" id="permissionCancelBtn" data-i18n="common.cancel">取消</button>
            <button type="button" class="c-btn c-btn-primary" id="permissionSaveBtn" data-i18n="common.save">保存</button>
        </div>
    </div>
</div>

<div class="modal" id="attendanceSettingModal" aria-hidden="true">
    <div class="modal-card c-card c-card-pad">
        <div class="modal-header">
            <h4 data-i18n="personnel.attendance.title">考勤设定</h4>
            <button class="modal-close" id="attendanceSettingClose" aria-label="关闭" data-i18n-aria="common.close">×</button>
        </div>
        <div class="modal-body">
            <div class="c-empty" data-i18n="notice.body">功能开发中</div>
        </div>
    </div>
</div>

<script src="i18n.js"></script>
<script src="common.js"></script>
<script>
    const i18n = window.I18N;
    if (i18n) {
        i18n.init();
        i18n.apply();
    }
    const t = (key) => (i18n ? i18n.t(key) : key);
    const format = (key, vars) => (i18n ? i18n.format(key, vars) : key);
    const tableBody = document.getElementById("tableBody");
    const searchInput = document.getElementById("searchInput");
    const deptSelect = document.getElementById("deptSelect");
    const applyFilterBtn = document.getElementById("applyFilterBtn");
    const resetBtn = document.getElementById("resetBtn");
    const addBtn = document.getElementById("addBtn");
    const summaryText = document.getElementById("summaryText");
    const pagination = document.getElementById("pagination");
    const paginationPages = document.getElementById("paginationPages");
    const employeeModal = document.getElementById("employeeModal");
    const permissionModal = document.getElementById("permissionModal");
    const attendanceSettingModal = document.getElementById("attendanceSettingModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalClose = document.getElementById("modalClose");
    const cancelBtn = document.getElementById("cancelBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const permissionClose = document.getElementById("permissionClose");
    const permissionRoleList = document.getElementById("permissionRoleList");
    const permissionMenuList = document.getElementById("permissionMenuList");
    const permissionMenuMasterCheck = document.getElementById("permissionMenuMasterCheck");
    const permissionMenuSelectedCount = document.getElementById("permissionMenuSelectedCount");
    const permissionCancelBtn = document.getElementById("permissionCancelBtn");
    const permissionSaveBtn = document.getElementById("permissionSaveBtn");
    const attendanceSettingClose = document.getElementById("attendanceSettingClose");
    const employeeForm = document.getElementById("employeeForm");
    const fieldName = document.getElementById("fieldName");
    const fieldGender = document.getElementById("fieldGender");
    const fieldBirthday = document.getElementById("fieldBirthday");
    const fieldDepartment = document.getElementById("fieldDepartment");
    const fieldPosition = document.getElementById("fieldPosition");
    const fieldPhone = document.getElementById("fieldPhone");
    const fieldEmail = document.getElementById("fieldEmail");
    const fieldAddress = document.getElementById("fieldAddress");
    const fieldEmergencyName = document.getElementById("fieldEmergencyName");
    const fieldEmergencyPhone = document.getElementById("fieldEmergencyPhone");
    const fieldEmergencyRelation = document.getElementById("fieldEmergencyRelation");
    const fieldHireDate = document.getElementById("fieldHireDate");
    const fieldLeaveDate = document.getElementById("fieldLeaveDate");
    const ROLE_KEY = "app_role_id";
    const sessionRoleId = "{{ request.session.role_id|default:'' }}";

    let allEmployees = [];
    let cachedDepartments = [];
    let editingId = null;
    let currentPage = 1;
    const pageSize = 10;
    let totalPages = 1;
    let totalCount = 0;
    let currentFilters = {keyword: "", department: "all"};
    let cachedRoles = [];
    let cachedMenus = [];
    let selectedRoleId = null;
    let selectedMenuSet = new Set();
    const readRoleId = () => {
        try {
            const stored = localStorage.getItem(ROLE_KEY);
            if (stored) return stored;
        } catch (err) {
        }
        if (sessionRoleId) {
            try { localStorage.setItem(ROLE_KEY, String(sessionRoleId)); } catch (err) {}
            return String(sessionRoleId);
        }
        return "";
    };
    const isAdminRole = () => String(readRoleId()) === "999";

    const ensureDepartments = (departments) => {
        cachedDepartments = Array.isArray(departments) ? departments : [];
        deptSelect.innerHTML = `<option value="all">${t("personnel.department_all")}</option>`;
        cachedDepartments.forEach(dep => {
            if (!dep) return;
            const opt = document.createElement("option");
            opt.value = dep;
            opt.textContent = dep;
            deptSelect.appendChild(opt);
        });
    }

    const renderTable = (list) => {
        if (!list.length) {
            tableBody.innerHTML = `<tr><td colspan="7" class="empty c-empty">${t("personnel.empty")}</td></tr>`;
            return;
        }
        const showPermission = isAdminRole();
        tableBody.innerHTML = list.map(item => (
            `<tr>
          <td data-label="${t("personnel.table.name")}">${item.name}</td>
          <td data-label="${t("personnel.table.department")}">${item.department_name}</td>
          <td data-label="${t("personnel.table.position")}">${item.position_name}</td>
          <td data-label="${t("personnel.table.phone")}">${item.phone}</td>
          <td data-label="${t("personnel.table.email")}">${item.email}</td>
          <td data-label="${t("personnel.table.hire_date")}">${formatDate(item.hire_date)}</td>
          <td data-label="${t("personnel.table.actions")}">
            <div class="row-actions c-row-actions c-row-actions-nowrap">
              <button class="c-btn c-btn-secondary c-btn-sm" data-action="edit" data-id="${item.id}">${t("personnel.action.edit")}</button>
              <button class="c-btn c-btn-success-lite c-btn-sm" data-action="tech-edit" data-id="${item.id}">${t("personnel.action.tech_edit")}</button>
              ${showPermission ? `<button class="c-btn c-btn-danger c-btn-sm" data-action="permission" data-id="${item.id}">${t("personnel.action.permission")}</button>` : ""}
              <button class="c-btn c-btn-warn-lite c-btn-sm" data-action="attendance-setting" data-id="${item.id}">${t("personnel.action.attendance")}</button>
            </div>
          </td>
        </tr>`
        )).join("");
    }

    const renderPagination = () => {
        window.renderPagination(pagination, paginationPages, currentPage, totalPages);
    }

    const renderPage = () => {
        renderTable(allEmployees);
        renderPagination();
        if (summaryText) {
            const safeTotalPages = Math.max(1, totalPages);
            summaryText.textContent = format("personnel.summary", {
                count: totalCount,
                page: currentPage,
                total: safeTotalPages
            });
        }
    }

    const buildPayload = () => {
        return {
            name: fieldName.value.trim(),
            gender: fieldGender.value === "" ? null : Number(fieldGender.value),
            phone: fieldPhone.value.trim(),
            email: fieldEmail.value.trim(),
            address: fieldAddress.value.trim(),
            department_name: fieldDepartment.value.trim(),
            position_name: fieldPosition.value.trim(),
            hire_date: fieldHireDate.value || "",
            leave_date: fieldLeaveDate.value || "",
            birthday: fieldBirthday.value || "",
            emergency_contact_name: fieldEmergencyName.value.trim(),
            emergency_contact_phone: fieldEmergencyPhone.value.trim(),
            emergency_contact_relationship: fieldEmergencyRelation.value.trim()
        };
    }

    const applyFilter = () => {
        currentFilters = {
            keyword: (searchInput.value || "").trim(),
            department: deptSelect.value
        };
        currentPage = 1;
        fetchEmployees();
    }

    const resetFilters = () => {
        searchInput.value = "";
        deptSelect.value = "all";
        applyFilter();
    }


    const handleAction = (e) => {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;
        const action = btn.getAttribute("data-action");
        const id = btn.getAttribute("data-id");
        if (action === "edit") {
            const target = allEmployees.find(item => String(item.id) === String(id));
            if (target) openModal("edit", target);
        } else if (action === "tech-edit") {
            try {
                localStorage.setItem("tech_edit_employee_id", String(id));
                if (window.parent && window.parent !== window) {
                    window.parent.location.hash = "people.html";
                    return;
                }
            } catch (err) {
            }
            window.location.href = "people.html";
        } else if (action === "permission") {
            openPermissionModal(id);
        } else if (action === "attendance-setting") {
            openAttendanceSettingModal(id);
        }
    }

    const openModal = (mode, data) => {
        editingId = mode === "edit" ? data?.id : null;
        modalTitle.textContent = mode === "edit" ? t("personnel.modal.edit") : t("personnel.modal.add");
        fieldName.value = data?.name || "";
        fieldGender.value = data?.gender ?? "";
        fieldBirthday.value = formatDate(data?.birthday || "");
        fieldDepartment.value = data?.department || "";
        fieldPosition.value = data?.position || "";
        fieldPhone.value = data?.phone || "";
        fieldEmail.value = data?.email || "";
        fieldAddress.value = data?.address || "";
        fieldEmergencyName.value = data?.emergency_contact_name || "";
        fieldEmergencyPhone.value = data?.emergency_contact_phone || "";
        fieldEmergencyRelation.value = data?.emergency_contact_relationship || "";
        fieldHireDate.value = formatDate(data?.hire_date || "");
        fieldLeaveDate.value = formatDate(data?.leave_date || "");
        if (deleteBtn) {
            const shouldShow = mode === "edit";
            deleteBtn.hidden = !shouldShow;
            deleteBtn.style.display = shouldShow ? "" : "none";
        }
        employeeModal.classList.add("show");
        employeeModal.setAttribute("aria-hidden", "false");
    }

    const closeModal = () => {
        employeeModal.classList.remove("show");
        employeeModal.setAttribute("aria-hidden", "true");
        employeeForm.reset();
        editingId = null;
        if (deleteBtn) {
            deleteBtn.hidden = true;
            deleteBtn.style.display = "none";
        }
    }

    const openPermissionModal = (id) => {
        try {
            permissionModal?.setAttribute("data-employee-id", id ? String(id) : "");
        } catch (err) {
        }
        permissionModal.classList.add("show");
        permissionModal.setAttribute("aria-hidden", "false");
        initPermissionEditor(id);
    }

    const closePermissionModal = () => {
        permissionModal.classList.remove("show");
        permissionModal.setAttribute("aria-hidden", "true");
    }

    const permissionStorageKey = (employeeId) => `personnel_permission_${employeeId || "unknown"}`;

    const requestPermissionJson = async (url, options = {}) => {
        const response = await fetchWithAuth(url, options);
        const data = await response.json();
        return normalizeApiResponse(data);
    };

    const fetchPermissionRoles = async () => {
        const res = await requestPermissionJson("/api/roles", {method: "GET"});
        if (res.success) {
            cachedRoles = Array.isArray(res.data?.items) ? res.data.items : [];
        } else {
            cachedRoles = [];
        }
    };

    const fetchPermissionMenus = async () => {
        const res = await requestPermissionJson("/api/menus", {method: "GET"});
        if (res.success) {
            cachedMenus = Array.isArray(res.data?.items) ? res.data.items : [];
        } else {
            cachedMenus = [];
        }
    };

    const getAllMenuHtmls = () => cachedMenus.map(item => item.menu_html).filter(Boolean);

    const normalizeRoleMenuList = (menuList) => {
        if (menuList === "*") return "*";
        if (Array.isArray(menuList)) return menuList;
        if (typeof menuList === "string") {
            try {
                const parsed = JSON.parse(menuList);
                if (Array.isArray(parsed)) return parsed;
            } catch (err) {
            }
        }
        return [];
    };

    const renderPermissionRoles = () => {
        if (!permissionRoleList) return;
        if (!cachedRoles.length) {
            permissionRoleList.innerHTML = `<div class="c-empty">暂无数据</div>`;
            return;
        }
        permissionRoleList.innerHTML = cachedRoles.map(role => {
            const roleId = role.id ?? "";
            const checked = String(selectedRoleId) === String(roleId);
            return `
                <label class="permission-role-option">
                    <input type="radio" name="permission-role" value="${roleId}" ${checked ? "checked" : ""}>
                    <span class="permission-role-meta">
                        <strong>${role.role_name || ""}</strong>
                        <span>${role.description || ""}</span>
                    </span>
                </label>
            `;
        }).join("");
    };

    const renderPermissionMenus = () => {
        if (!permissionMenuList) return;
        if (!cachedMenus.length) {
            permissionMenuList.innerHTML = `<div class="c-empty">暂无数据</div>`;
            updatePermissionSelectedCount();
            return;
        }
        permissionMenuList.innerHTML = cachedMenus.map(menu => {
            const value = menu.menu_html || "";
            const checked = selectedMenuSet.has(value);
            return `
                <label class="role-menu-check">
                    <input type="checkbox" value="${value}" ${checked ? "checked" : ""}>
                    <span class="role-menu-text">
                        <strong>${menu.menu_name || ""}</strong>
                        <span>${value}</span>
                    </span>
                </label>
            `;
        }).join("");
        updatePermissionSelectedCount();
    };

    const syncPermissionMenuChecks = () => {
        if (!permissionMenuList) return;
        permissionMenuList.querySelectorAll("input[type=\"checkbox\"]").forEach(input => {
            input.checked = selectedMenuSet.has(input.value);
        });
        updatePermissionSelectedCount();
    };

    const updatePermissionSelectedCount = () => {
        if (!permissionMenuList) return;
        const total = permissionMenuList.querySelectorAll("input[type=\"checkbox\"]").length;
        const count = permissionMenuList.querySelectorAll("input[type=\"checkbox\"]:checked").length;
        if (permissionMenuSelectedCount) {
            permissionMenuSelectedCount.textContent = String(count);
        }
        if (permissionMenuMasterCheck) {
            if (total > 0 && count === total) {
                permissionMenuMasterCheck.indeterminate = false;
                permissionMenuMasterCheck.checked = true;
            } else if (count === 0) {
                permissionMenuMasterCheck.indeterminate = false;
                permissionMenuMasterCheck.checked = false;
            } else {
                permissionMenuMasterCheck.checked = false;
                permissionMenuMasterCheck.indeterminate = true;
            }
        }
    };

    const applyRoleMenus = (roleId) => {
        const role = cachedRoles.find(item => String(item.id) === String(roleId));
        if (!role) {
            selectedMenuSet = new Set();
            syncPermissionMenuChecks();
            return;
        }
        const menuList = normalizeRoleMenuList(role.menu_list);
        if (menuList === "*") {
            selectedMenuSet = new Set(getAllMenuHtmls());
        } else {
            selectedMenuSet = new Set(menuList);
        }
        syncPermissionMenuChecks();
    };

    const loadSavedPermission = (employeeId) => {
        try {
            const raw = localStorage.getItem(permissionStorageKey(employeeId));
            if (!raw) return null;
            const parsed = JSON.parse(raw);
            if (!parsed || typeof parsed !== "object") return null;
            return parsed;
        } catch (err) {
            return null;
        }
    };

    const savePermissionSelection = (employeeId) => {
        if (!employeeId) return;
        const payload = {
            roleId: selectedRoleId,
            menuList: Array.from(selectedMenuSet)
        };
        try {
            localStorage.setItem(permissionStorageKey(employeeId), JSON.stringify(payload));
        } catch (err) {
        }
    };

    const initPermissionEditor = async (employeeId) => {
        await Promise.all([fetchPermissionRoles(), fetchPermissionMenus()]);
        const saved = loadSavedPermission(employeeId);
        selectedRoleId = saved?.roleId ?? null;
        selectedMenuSet = new Set(Array.isArray(saved?.menuList) ? saved.menuList : []);
        renderPermissionRoles();
        renderPermissionMenus();
    };

    const openAttendanceSettingModal = (id) => {
        try {
            attendanceSettingModal?.setAttribute("data-employee-id", id ? String(id) : "");
        } catch (err) {
        }
        attendanceSettingModal.classList.add("show");
        attendanceSettingModal.setAttribute("aria-hidden", "false");
    }

    const closeAttendanceSettingModal = () => {
        attendanceSettingModal.classList.remove("show");
        attendanceSettingModal.setAttribute("aria-hidden", "true");
    }

    const createEmployee = async (payload) => {
        const res = await fetchWithAuth(`/api/employees`, {
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        const responsePayload = normalizeApiResponse(data);
        if (!res.ok || !responsePayload.success) {
            throw new Error(responsePayload.message || t("personnel.error.create_failed"));
        }
        return responsePayload.data || {};
    }

    const updateEmployee = async (id, payload) => {
        const res = await fetchWithAuth(`/api/employees/${id}`, {
            method: "PUT",
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        const responsePayload = normalizeApiResponse(data);
        if (!res.ok || !responsePayload.success) {
            throw new Error(responsePayload.message || t("personnel.error.update_failed"));
        }
        return responsePayload.data || {};
    }

    const deleteEmployee = async (id) => {
        try {
            const res = await fetchWithAuth(`/api/employees/${id}`, {method: "DELETE"});
            const data = await res.json();
            const payload = normalizeApiResponse(data);
            if (!res.ok || !payload.success) {
                throw new Error(payload.message || t("personnel.error.delete_failed"));
            }
            await fetchEmployees();
        } catch (err) {
            alert(`${t("personnel.error.delete_failed")}：${err.message}`);
        }
    }

    const fetchEmployees = async () => {
        tableBody.innerHTML = `<tr><td colspan="7" class="empty c-empty">${t("common.loading")}</td></tr>`;
        try {
            const params = new URLSearchParams();
            if (currentFilters.keyword) params.append("keyword", currentFilters.keyword);
            if (currentFilters.department && currentFilters.department !== "all") {
                params.append("department", currentFilters.department);
            }
            params.append("page", String(currentPage));
            params.append("page_size", String(pageSize));
            const query = params.toString();
            const url = query ? `/api/employees?${query}` : "/api/employees";
            const res = await fetchWithAuth(url, {method: "GET"});
            const data = await res.json();
            const payload = normalizeApiResponse(data);
            if (!res.ok || !payload.success) {
                throw new Error(payload.message || t("common.load_failed"));
            }
            const result = payload.data || {};
            const meta = payload.meta || {};
            allEmployees = Array.isArray(result.items) ? result.items : [];
            totalCount = Number.isFinite(meta.total) ? meta.total : allEmployees.length;
            totalPages = Number.isFinite(meta.total_pages) ? meta.total_pages : 1;
            currentPage = Number.isFinite(meta.page) ? meta.page : currentPage;
            renderPage();
        } catch (err) {
            tableBody.innerHTML = `<tr><td colspan="7" class="empty c-empty">${t("common.load_failed")}：${err.message}</td></tr>`;
            if (summaryText) {
                summaryText.textContent = format("personnel.summary", {
                    count: 0,
                    page: 1,
                    total: 1
                });
            }
            totalCount = 0;
            totalPages = 1;
        }
    }

    const fetchDepartments = async () => {
        try {
            const res = await fetchWithAuth("/api/employees/departments", {method: "GET"});
            const data = await res.json();
            const payload = normalizeApiResponse(data);
            if (!res.ok || !payload.success) {
                throw new Error(payload.message || t("common.load_failed"));
            }
            const result = payload.data || {};
            ensureDepartments(result.departments || []);
        } catch (err) {
            ensureDepartments([]);
        }
    }

    fetchDepartments();
    fetchEmployees();
    const refreshI18n = () => {
        if (i18n) {
            i18n.apply();
        }
        ensureDepartments(cachedDepartments);
        renderPage();
    };
    if (window && window.addEventListener) {
        window.addEventListener("i18n:change", refreshI18n);
    }
    applyFilterBtn.addEventListener("click", applyFilter);
    deptSelect.addEventListener("change", applyFilter);
    resetBtn.addEventListener("click", resetFilters);
    window.bindPagination(pagination, (value) => {
        const safeTotalPages = Math.max(1, totalPages);
        if (value === "prev") {
            currentPage = Math.max(1, currentPage - 1);
        } else if (value === "next") {
            currentPage = Math.min(safeTotalPages, currentPage + 1);
        } else {
            const targetPage = Number(value);
            if (!Number.isNaN(targetPage)) currentPage = targetPage;
        }
        fetchEmployees();
    });
    tableBody.addEventListener("click", handleAction);
    addBtn.addEventListener("click", () => openModal("add"));
    modalClose.addEventListener("click", closeModal);
    cancelBtn.addEventListener("click", closeModal);
    deleteBtn.addEventListener("click", () => {
        if (!editingId) return;
        const target = allEmployees.find(item => String(item.id) === String(editingId));
        const name = target?.name || "";
        if (!confirm(format("personnel.confirm.delete", { name }))) return;
        deleteEmployee(editingId);
        closeModal();
    });
    permissionClose.addEventListener("click", closePermissionModal);
    permissionModal.addEventListener("click", (e) => {
        if (e.target === permissionModal) closePermissionModal();
    });
    permissionRoleList.addEventListener("change", (event) => {
        const target = event.target;
        if (!target || target.type !== "radio") return;
        selectedRoleId = target.value;
        applyRoleMenus(selectedRoleId);
    });
    permissionMenuList.addEventListener("change", (event) => {
        const target = event.target;
        if (!target || target.type !== "checkbox") return;
        if (target.checked) {
            selectedMenuSet.add(target.value);
        } else {
            selectedMenuSet.delete(target.value);
        }
        updatePermissionSelectedCount();
    });
    if (permissionMenuMasterCheck) {
        permissionMenuMasterCheck.addEventListener("click", () => {
            if (!permissionMenuList) return;
            const allChecks = Array.from(permissionMenuList.querySelectorAll("input[type=\"checkbox\"]"));
            const total = allChecks.length;
            const checkedCount = allChecks.filter(input => input.checked).length;
            const shouldCheckAll = total > 0 && checkedCount !== total;
            selectedMenuSet = new Set(shouldCheckAll ? allChecks.map(input => input.value) : []);
            allChecks.forEach(input => {
                input.checked = shouldCheckAll;
            });
            updatePermissionSelectedCount();
        });
    }
    permissionCancelBtn.addEventListener("click", closePermissionModal);
    permissionSaveBtn.addEventListener("click", () => {
        const employeeId = permissionModal?.getAttribute("data-employee-id") || "";
        savePermissionSelection(employeeId);
        closePermissionModal();
    });
    attendanceSettingClose.addEventListener("click", closeAttendanceSettingModal);
    attendanceSettingModal.addEventListener("click", (e) => {
        if (e.target === attendanceSettingModal) closeAttendanceSettingModal();
    });
    employeeModal.addEventListener("click", (e) => {
        if (e.target === employeeModal) closeModal();
    });
    employeeForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const payload = buildPayload();
        if (!payload.name) {
            alert(t("personnel.error.name_required"));
            return;
        }
        try {
            if (editingId) {
                await updateEmployee(editingId, payload);
            } else {
                await createEmployee(payload);
            }
            closeModal();
            await fetchEmployees();
        } catch (err) {
            alert(err.message || t("common.save_failed"));
        }
    });
</script>
</body>
</html>
