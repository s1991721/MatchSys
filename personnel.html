<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>社内人员管理</title>
  <style>
    :root {
      --bg: #f4f6fb;
      --card: #ffffff;
      --card-soft: #f6f8ff;
      --text: #1f2a3d;
      --muted: #6b7686;
      --border: #e5e9f2;
      --line: #e5e9f2;
      --primary: #1c7bff;
      --primary-strong: #1b6fe8;
      --brand: #1c7bff;
      --brand2: #2e7bff;
      --accent: rgba(28, 123, 255, 0.08);
      --blue: #2f6fec;
      --purple: #7c3aed;
      --green: #16a34a;
      --orange: #f59e0b;
      --red: #ef4444;
      --danger: #ef4444;
      --warning: #f59e0b;
      --warn: #f59e0b;
      --success: #10b981;
      --shadow: 0 12px 28px rgba(31, 53, 90, 0.08);
      --shadowSoft: 0 10px 24px rgba(31, 53, 90, 0.07);
      --radius: 14px;
      --sidebar-w: 260px;
      --sidebar-w-collapsed: 68px;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: "PingFang SC", -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .page {
      padding: 18px;
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .card {
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--line);
      box-shadow: 0 10px 24px rgba(31, 53, 90, 0.07);
      padding: 20px 22px 24px;
    }
    .title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 800;
      margin: 0 0 14px;
    }
    .title::before {
      content: "";
      width: 4px;
      height: 18px;
      border-radius: 12px;
      background: var(--primary);
      box-shadow: 0 0 0 6px rgba(28, 123, 255, 0.12);
    }
    label {
      display: flex;
      flex-direction: column;
      font-size: 13px;
      color: var(--muted);
      gap: 6px;
    }
    input,
    select {
      font: inherit;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #f9fafc;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(28, 123, 255, 0.15);
      background: #fff;
    }
    .action-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 18px;
      border-radius: 10px;
      font-weight: 600;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      box-shadow: 0 8px 16px rgba(15, 23, 42, 0.12);
    }
    .action-btn:active {
      transform: scale(0.97);
    }
    .btn-blue { background: #1c7bff; }
    .btn-search {
      background: #10b981;
      color: #fff;
      box-shadow: 0 10px 18px rgba(16, 185, 129, 0.3);
      border: none;
      border-radius: 12px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-reset {
      background: #f59e0b;
      color: #fff;
      box-shadow: 0 10px 18px rgba(245, 158, 11, 0.35);
      border: none;
      border-radius: 12px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-secondary {
      background: #eef2ff;
      color: var(--primary);
      border: none;
      border-radius: 12px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 600;
    }
    .table-card {
      margin-top: 0;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: var(--card);
      box-shadow: 0 20px 30px rgba(17, 24, 39, 0.08);
      overflow: hidden;
    }
    .filters {
      padding: 20px;
      border-bottom: 1px solid var(--line);
      background: radial-gradient(circle at top, rgba(28, 123, 255, 0.08), transparent 70%);
    }
    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px 18px;
    }
    .filter-actions {
      margin-top: 16px;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-actions-left,
    .filter-actions-right {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .table-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      padding: 16px 20px 0;
      align-items: center;
      justify-content: space-between;
    }
    .table-wrapper {
      overflow-x: auto;
      padding: 12px 20px 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    thead th {
      text-align: left;
      font-size: 13px;
      letter-spacing: 0.4px;
      padding: 12px 10px;
      color: #6b7280;
      font-weight: 600;
      border-bottom: 1px solid var(--line);
    }
    tbody td {
      padding: 14px 10px;
      border-bottom: 1px solid #f0f3fa;
      font-size: 13px;
    }
    tbody tr:last-child td {
      border-bottom: none;
    }
    tbody tr:hover {
      background: #f8fbff;
    }
    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #eef2ff;
      color: var(--primary);
      font-weight: 600;
    }
    .badge.active {
      background: rgba(16, 185, 129, 0.18);
      color: var(--success);
    }
    .badge.leave {
      background: rgba(255, 95, 95, 0.18);
      color: var(--danger);
    }
    .badge.disabled {
      background: #eef2ff;
      color: var(--muted);
    }
    .row-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .row-actions button {
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
      border: 1px solid #d7deea;
      background: #fff;
      cursor: pointer;
      color: #2f4a72;
    }
    .row-actions button:hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    .empty {
      text-align: center;
      padding: 32px 0;
      color: var(--muted);
    }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 50;
    }
    .modal.show {
      display: flex;
    }
    .modal-card {
      width: min(820px, 95%);
      background: #fff;
      border-radius: 20px;
      border: 1px solid var(--line);
      box-shadow: 0 30px 50px rgba(15, 23, 42, 0.25);
      padding: 18px 24px 16px;
      max-height: 86vh;
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 6px;
    }
    .modal-header h4 {
      margin: 0;
      font-size: 18px;
      font-weight: 800;
    }
    .modal-close {
      background: transparent;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      color: var(--muted);
      padding: 0;
      border: none;
      cursor: pointer;
      font-size: 22px;
    }
    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
      max-height: calc(86vh - 120px);
      padding-right: 6px;
    }
    .modal-actions {
      padding-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      border-top: 1px solid var(--line);
      background: #f8f9fb;
      border-bottom-left-radius: 20px;
      border-bottom-right-radius: 20px;
    }
    .modal-actions .btn-primary {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 12px 20px rgba(28, 123, 255, 0.25);
    }
    @media (max-width: 640px) {
      .filter-actions {
        flex-direction: column;
        align-items: stretch;
      }
      thead {
        display: none;
      }
      tbody tr {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px 10px;
        border-bottom: 1px solid #eef2ff;
        padding: 12px 0;
      }
      tbody td {
        padding: 0;
        font-size: 12px;
      }
      tbody td::before {
        content: attr(data-label);
        font-weight: 600;
        display: block;
        color: var(--muted);
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <section class="table-card">
      <div class="filters">
        <div class="filter-grid">
          <label>
            搜索（姓名 / 邮箱 / 手机 / 部门 / 职位）
            <input id="searchInput" type="search" placeholder="输入关键字" />
          </label>
          <label>
            部门
            <select id="deptSelect">
            <option value="all">全部部门</option>
            </select>
          </label>
          <label>
            状态
            <select id="statusSelect">
            <option value="all">全部状态</option>
            <option value="active">在岗</option>
            <option value="leave">离职</option>
            <option value="disabled">停用</option>
            </select>
          </label>
        </div>
        <div class="filter-actions">
          <div class="filter-actions-left">
            <button type="button" class="action-btn btn-blue" id="addBtn">＋ 新增人员</button>
          </div>
          <div class="filter-actions-right">
            <button type="button" class="btn-search" id="applyFilterBtn">搜索</button>
            <button type="button" class="btn-reset" id="resetBtn">重置</button>
            <button type="button" class="btn-secondary" id="exportBtn">导出 CSV</button>
          </div>
        </div>
      </div>

      <div class="table-actions">
        <div style="text-align:right;font-size:13px;color:#6b7280;">
          <span id="summaryText">共 0 人</span>
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>姓名</th>
              <th>部门</th>
              <th>职位</th>
              <th>手机</th>
              <th>邮箱</th>
              <th>入职日期</th>
              <th>状态</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="8" class="empty">加载中…</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <div class="modal" id="employeeModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-header">
        <h4 id="modalTitle">新增人员</h4>
        <button class="modal-close" id="modalClose" aria-label="关闭">×</button>
      </div>
      <form id="employeeForm" class="modal-body">
        <div class="form-grid">
          <label>
            <span>姓名 *</span>
            <input id="fieldName" type="text" required />
          </label>
          <label>
            <span>性别</span>
            <select id="fieldGender">
              <option value="">未设置</option>
              <option value="1">男</option>
              <option value="2">女</option>
              <option value="0">未知</option>
            </select>
          </label>
          <label>
            <span>生日</span>
            <input id="fieldBirthday" type="date" />
          </label>
          <label>
            <span>部门</span>
            <input id="fieldDepartment" type="text" />
          </label>
          <label>
            <span>职位</span>
            <input id="fieldPosition" type="text" />
          </label>
          <label>
            <span>手机</span>
            <input id="fieldPhone" type="text" />
          </label>
          <label>
            <span>邮箱</span>
            <input id="fieldEmail" type="email" />
          </label>
          <label>
            <span>住址</span>
            <input id="fieldAddress" type="text" />
          </label>
          <label>
            <span>紧急联系人姓名</span>
            <input id="fieldEmergencyName" type="text" />
          </label>
          <label>
            <span>紧急联系人电话</span>
            <input id="fieldEmergencyPhone" type="text" />
          </label>
          <label>
            <span>紧急联系人关系</span>
            <input id="fieldEmergencyRelation" type="text" />
          </label>
          <label>
            <span>入职日期</span>
            <input id="fieldHireDate" type="date" />
          </label>
          <label>
            <span>离职日期</span>
            <input id="fieldLeaveDate" type="date" />
          </label>
          <label>
            <span>状态</span>
            <select id="fieldStatus" class="select">
              <option value="active">在岗</option>
              <option value="leave">离职</option>
              <option value="disabled">停用</option>
            </select>
          </label>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" id="cancelBtn">取消</button>
          <button type="submit" class="btn-primary" id="saveBtn">保存</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = "";
    const EMPLOYEE_ENDPOINT = `${API_BASE}/api/employees`;
    const normalizeApiResponse = (raw) => {
      if (raw && typeof raw === "object" && "success" in raw) {
        return raw;
      }
      return {
        success: false,
        code: "ERR_INVALID_RESPONSE",
        message: "Invalid response",
        data: null,
        meta: {},
      };
    };
    const fetchWithAuth = async (url, options = {}) => {
      const res = await fetch(url, options);
      if (res.status === 401) {
        window.location.href = "/login.html";
        throw new Error("Unauthorized");
      }
      return res;
    };

    const tableBody = document.getElementById("tableBody");
    const searchInput = document.getElementById("searchInput");
    const deptSelect = document.getElementById("deptSelect");
    const statusSelect = document.getElementById("statusSelect");
    const applyFilterBtn = document.getElementById("applyFilterBtn");
    const resetBtn = document.getElementById("resetBtn");
    const exportBtn = document.getElementById("exportBtn");
    const addBtn = document.getElementById("addBtn");
    const summaryText = document.getElementById("summaryText");
    const employeeModal = document.getElementById("employeeModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalClose = document.getElementById("modalClose");
    const cancelBtn = document.getElementById("cancelBtn");
    const employeeForm = document.getElementById("employeeForm");
    const fieldName = document.getElementById("fieldName");
    const fieldGender = document.getElementById("fieldGender");
    const fieldBirthday = document.getElementById("fieldBirthday");
    const fieldDepartment = document.getElementById("fieldDepartment");
    const fieldPosition = document.getElementById("fieldPosition");
    const fieldPhone = document.getElementById("fieldPhone");
    const fieldEmail = document.getElementById("fieldEmail");
    const fieldAddress = document.getElementById("fieldAddress");
    const fieldEmergencyName = document.getElementById("fieldEmergencyName");
    const fieldEmergencyPhone = document.getElementById("fieldEmergencyPhone");
    const fieldEmergencyRelation = document.getElementById("fieldEmergencyRelation");
    const fieldHireDate = document.getElementById("fieldHireDate");
    const fieldLeaveDate = document.getElementById("fieldLeaveDate");
    const fieldStatus = document.getElementById("fieldStatus");

    let allEmployees = [];
    let currentList = [];
    let editingId = null;

    const STATUS_LABEL = {
      active:"在岗",
      leave:"离职",
      disabled:"停用"
    };

    function ensureDepartments(departments){
      deptSelect.innerHTML = `<option value="all">全部部门</option>`;
      (departments || []).forEach(dep => {
        if (!dep) return;
        const opt = document.createElement("option");
        opt.value = dep;
        opt.textContent = dep;
        deptSelect.appendChild(opt);
      });
    }


    function renderTable(list){
      if (!list.length){
        tableBody.innerHTML = `<tr><td colspan="8" class="empty">没有符合条件的人员</td></tr>`;
        return;
      }
      tableBody.innerHTML = list.map(item => (
        `<tr>
          <td data-label="姓名">${item.name}</td>
          <td data-label="部门">${item.department}</td>
          <td data-label="职位">${item.position}</td>
          <td data-label="手机">${item.phone}</td>
          <td data-label="邮箱">${item.email}</td>
          <td data-label="入职日期">${formatDate(item.hire_date)}</td>
          <td data-label="状态"><span class="badge ${item.status === "active" ? "active" : item.status === "leave" ? "leave" : "disabled"}">${STATUS_LABEL[item.status] || item.status}</span></td>
          <td data-label="操作">
            <div class="row-actions">
              <button data-action="edit" data-id="${item.id}">编辑</button>
              <button data-action="tech-edit" data-id="${item.id}">技术者编辑</button>
              <button data-action="delete" data-id="${item.id}" data-name="${item.name}">删除</button>
            </div>
          </td>
        </tr>`
      )).join("");
    }

    function applyFilter(){
      const keyword = (searchInput.value || "").trim().toLowerCase();
      const dep = deptSelect.value;
      const status = statusSelect.value;

      const filtered = allEmployees.filter(item => {
        const matchKeyword = !keyword || [
          item.name,
          item.email,
          item.phone,
          item.department,
          item.position
        ].some(text => text.toLowerCase().includes(keyword));

        const matchDep = dep === "all" || item.department === dep;
        const matchStatus = status === "all" || item.status === status;

        return matchKeyword && matchDep && matchStatus;
      });

      currentList = filtered;
      renderTable(currentList);
      if (summaryText) {
        summaryText.textContent = `共 ${currentList.length} 人`;
      }
    }

    function handleAction(e){
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;
      const action = btn.getAttribute("data-action");
      const id = btn.getAttribute("data-id");
      if (action === "edit"){
        const target = allEmployees.find(item => String(item.id) === String(id));
        if (target) openModal("edit", target);
      } else if (action === "tech-edit"){
        if (id) {
          try {
            localStorage.setItem("tech_edit_employee_id", String(id));
          } catch (err) {}
        }
        try {
          if (window.parent && window.parent !== window) {
            window.parent.location.hash = "people.html";
            return;
          }
        } catch (err) {}
        window.location.href = "people.html";
      } else if (action === "delete"){
        const name = btn.getAttribute("data-name") || "";
        if (!confirm(`确认删除 ${name}？`)) return;
        deleteEmployee(id);
      }
    }

    function resetFilters(){
      searchInput.value = "";
      deptSelect.value = "all";
      statusSelect.value = "all";
      applyFilter();
    }

    function exportCSV(){
      const rows = [
        ["姓名","部门","职位","手机","邮箱","入职日期","状态"],
        ...currentList.map(item => [
          item.name,
          item.department,
          item.position,
          item.phone,
          item.email,
          formatDate(item.hire_date),
          STATUS_LABEL[item.status] || item.status
        ])
      ];
      const content = rows.map(row => row.map(cell => `"${cell}"`).join(",")).join("\\n");
      const blob = new Blob([content], { type:"text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "personnel.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function formatDate(raw){
      if (!raw) return "";
      const d = new Date(raw);
      if (Number.isNaN(d.getTime())) return raw;
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function openModal(mode, data){
      editingId = mode === "edit" ? data?.id : null;
      modalTitle.textContent = mode === "edit" ? "编辑人员" : "新增人员";
      fieldName.value = data?.name || "";
      fieldGender.value = data?.gender ?? "";
      fieldBirthday.value = formatDate(data?.birthday || "");
      fieldDepartment.value = data?.department || "";
      fieldPosition.value = data?.position || "";
      fieldPhone.value = data?.phone || "";
      fieldEmail.value = data?.email || "";
      fieldAddress.value = data?.address || "";
      fieldEmergencyName.value = data?.emergency_contact_name || "";
      fieldEmergencyPhone.value = data?.emergency_contact_phone || "";
      fieldEmergencyRelation.value = data?.emergency_contact_relationship || "";
      fieldHireDate.value = formatDate(data?.hire_date || "");
      fieldLeaveDate.value = formatDate(data?.leave_date || "");
      fieldStatus.value = data?.status || "active";
      employeeModal.classList.add("show");
      employeeModal.setAttribute("aria-hidden", "false");
    }

    function closeModal(){
      employeeModal.classList.remove("show");
      employeeModal.setAttribute("aria-hidden", "true");
      employeeForm.reset();
      editingId = null;
    }

    function buildPayload(){
      return {
        name: fieldName.value.trim(),
        gender: fieldGender.value === "" ? null : Number(fieldGender.value),
        birthday: fieldBirthday.value || "",
        department: fieldDepartment.value.trim(),
        position: fieldPosition.value.trim(),
        phone: fieldPhone.value.trim(),
        email: fieldEmail.value.trim(),
        address: fieldAddress.value.trim(),
        emergency_contact_name: fieldEmergencyName.value.trim(),
        emergency_contact_phone: fieldEmergencyPhone.value.trim(),
        emergency_contact_relationship: fieldEmergencyRelation.value.trim(),
        hire_date: fieldHireDate.value || "",
        leave_date: fieldLeaveDate.value || "",
        status: fieldStatus.value
      };
    }

    async function createEmployee(payload){
      const res = await fetchWithAuth(EMPLOYEE_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      const responsePayload = normalizeApiResponse(data);
      if (!res.ok || !responsePayload.success) {
        throw new Error(responsePayload.message || "新增失败");
      }
      return responsePayload.data || {};
    }

    async function updateEmployee(id, payload){
      const res = await fetchWithAuth(`${EMPLOYEE_ENDPOINT}/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      const responsePayload = normalizeApiResponse(data);
      if (!res.ok || !responsePayload.success) {
        throw new Error(responsePayload.message || "更新失败");
      }
      return responsePayload.data || {};
    }

    async function deleteEmployee(id){
      try{
        const res = await fetchWithAuth(`${EMPLOYEE_ENDPOINT}/${id}`, { method: "DELETE", credentials: "include" });
        const data = await res.json();
        const payload = normalizeApiResponse(data);
        if (!res.ok || !payload.success) {
          throw new Error(payload.message || "删除失败");
        }
        await fetchEmployees();
      }catch(err){
        alert(`删除失败：${err.message}`);
      }
    }

    async function fetchEmployees(){
      tableBody.innerHTML = `<tr><td colspan="8" class="empty">加载中…</td></tr>`;
      try{
        const res = await fetchWithAuth(EMPLOYEE_ENDPOINT, { credentials: "include" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const payload = normalizeApiResponse(data);
        if (!payload.success) {
          throw new Error(payload.message || "加载失败");
        }
        const result = payload.data || {};
        allEmployees = Array.isArray(result.items) ? result.items : [];
        ensureDepartments(result.departments || []);
        applyFilter();
      }catch(err){
        tableBody.innerHTML = `<tr><td colspan="8" class="empty">加载失败：${err.message}</td></tr>`;
        if (summaryText) {
          summaryText.textContent = "共 0 人";
        }
      }
    }

    fetchEmployees();

    searchInput.addEventListener("input", applyFilter);
    deptSelect.addEventListener("change", applyFilter);
    statusSelect.addEventListener("change", applyFilter);
    applyFilterBtn.addEventListener("click", applyFilter);
    resetBtn.addEventListener("click", resetFilters);
    exportBtn.addEventListener("click", exportCSV);
    tableBody.addEventListener("click", handleAction);
    addBtn.addEventListener("click", () => openModal("add"));
    modalClose.addEventListener("click", closeModal);
    cancelBtn.addEventListener("click", closeModal);
    employeeModal.addEventListener("click", (e) => {
      if (e.target === employeeModal) closeModal();
    });
    employeeForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const payload = buildPayload();
      if (!payload.name){
        alert("姓名不能为空");
        return;
      }
      try{
        if (editingId){
          await updateEmployee(editingId, payload);
        } else {
          await createEmployee(payload);
        }
        closeModal();
        await fetchEmployees();
      }catch(err){
        alert(err.message || "保存失败");
      }
    });
  </script>
</body>
</html>
