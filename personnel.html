<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="common.css">
    <link rel="stylesheet" href="components.css">
    <title>社内人员管理</title>
    <style></style>
</head>
<body class="c-form-page personnel-page">
<div class="page">
    <section class="c-card">
        <div class="filters c-filter-panel">
            <div class="filter-grid c-filter-grid-wide">
                <label>
                    搜索（姓名 / 邮箱 / 手机 / 部门 / 职位）
                    <input id="searchInput" type="search" placeholder="输入关键字"/>
                </label>
                <label>
                    部门
                    <select id="deptSelect">
                        <option value="all">全部部门</option>
                    </select>
                </label>
            </div>
            <div class="filter-actions c-filter-actions-bar">
                <div class="filter-actions-left">
                    <button type="button" class="c-btn c-btn-primary c-btn-lg c-btn-strong" id="addBtn">＋ 新增人员
                    </button>
                </div>
                <div class="filter-actions-right c-filter-actions-group">
                    <button type="button" class="c-btn c-btn-primary" id="applyFilterBtn">搜索</button>
                    <button type="button" class="c-btn c-btn-warn" id="resetBtn">重置</button>
                </div>
            </div>
        </div>

        <div class="table-actions c-table-actions">
        </div>

        <div class="table-wrapper c-table-wrapper">
            <table class="c-table">
                <thead>
                <tr>
                    <th>姓名</th>
                    <th>部门</th>
                    <th>职位</th>
                    <th>手机</th>
                    <th>邮箱</th>
                    <th>入职日期</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody id="tableBody">
                <tr>
                    <td colspan="7" class="empty c-empty">加载中…</td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="pagination c-pagination" id="pagination">
            <div class="pagination-summary">
                <span id="summaryText">共 0 人</span>
            </div>
            <button type="button" class="c-btn c-btn-ghost c-btn-sm" data-page="prev">上一页</button>
            <div class="pagination-pages" id="paginationPages"></div>
            <button type="button" class="c-btn c-btn-ghost c-btn-sm" data-page="next">下一页</button>
        </div>
    </section>
</div>

<div class="modal" id="employeeModal" aria-hidden="true">
    <div class="modal-card c-card c-card-pad">
        <div class="modal-header">
            <h4 id="modalTitle">新增人员</h4>
            <button class="modal-close" id="modalClose" aria-label="关闭">×</button>
        </div>
        <form id="employeeForm" class="modal-body">
            <div class="form-grid">
                <label>
                    <span>姓名 *</span>
                    <input id="fieldName" type="text" required/>
                </label>
                <label>
                    <span>性别</span>
                    <select id="fieldGender">
                        <option value="">未设置</option>
                        <option value="1">男</option>
                        <option value="2">女</option>
                        <option value="0">未知</option>
                    </select>
                </label>
                <label>
                    <span>生日</span>
                    <input id="fieldBirthday" type="date"/>
                </label>
                <label>
                    <span>部门</span>
                    <input id="fieldDepartment" type="text"/>
                </label>
                <label>
                    <span>职位</span>
                    <input id="fieldPosition" type="text"/>
                </label>
                <label>
                    <span>手机</span>
                    <input id="fieldPhone" type="text"/>
                </label>
                <label>
                    <span>邮箱</span>
                    <input id="fieldEmail" type="email"/>
                </label>
                <label>
                    <span>住址</span>
                    <input id="fieldAddress" type="text"/>
                </label>
                <label>
                    <span>紧急联系人姓名</span>
                    <input id="fieldEmergencyName" type="text"/>
                </label>
                <label>
                    <span>紧急联系人电话</span>
                    <input id="fieldEmergencyPhone" type="text"/>
                </label>
                <label>
                    <span>紧急联系人关系</span>
                    <input id="fieldEmergencyRelation" type="text"/>
                </label>
                <label>
                    <span>入职日期</span>
                    <input id="fieldHireDate" type="date"/>
                </label>
                <label>
                    <span>离职日期</span>
                    <input id="fieldLeaveDate" type="date"/>
                </label>
            </div>
            <div class="modal-actions">
                <button type="button" class="c-btn c-btn-secondary" id="cancelBtn">取消</button>
                <button type="button" class="c-btn c-btn-danger hidden" id="deleteBtn">删除人员</button>
                <button type="submit" class="c-btn c-btn-primary" id="saveBtn">保存</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" id="permissionModal" aria-hidden="true">
    <div class="modal-card c-card c-card-pad">
        <div class="modal-header">
            <h4>权限编辑</h4>
            <button class="modal-close" id="permissionClose" aria-label="关闭">×</button>
        </div>
        <div class="modal-body">
            <div class="c-empty">权限编辑功能待补充。</div>
        </div>
    </div>
</div>

<script src="common.js"></script>
<script>
    const tableBody = document.getElementById("tableBody");
    const searchInput = document.getElementById("searchInput");
    const deptSelect = document.getElementById("deptSelect");
    const applyFilterBtn = document.getElementById("applyFilterBtn");
    const resetBtn = document.getElementById("resetBtn");
    const addBtn = document.getElementById("addBtn");
    const summaryText = document.getElementById("summaryText");
    const pagination = document.getElementById("pagination");
    const paginationPages = document.getElementById("paginationPages");
    const employeeModal = document.getElementById("employeeModal");
    const permissionModal = document.getElementById("permissionModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalClose = document.getElementById("modalClose");
    const cancelBtn = document.getElementById("cancelBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const permissionClose = document.getElementById("permissionClose");
    const employeeForm = document.getElementById("employeeForm");
    const fieldName = document.getElementById("fieldName");
    const fieldGender = document.getElementById("fieldGender");
    const fieldBirthday = document.getElementById("fieldBirthday");
    const fieldDepartment = document.getElementById("fieldDepartment");
    const fieldPosition = document.getElementById("fieldPosition");
    const fieldPhone = document.getElementById("fieldPhone");
    const fieldEmail = document.getElementById("fieldEmail");
    const fieldAddress = document.getElementById("fieldAddress");
    const fieldEmergencyName = document.getElementById("fieldEmergencyName");
    const fieldEmergencyPhone = document.getElementById("fieldEmergencyPhone");
    const fieldEmergencyRelation = document.getElementById("fieldEmergencyRelation");
    const fieldHireDate = document.getElementById("fieldHireDate");
    const fieldLeaveDate = document.getElementById("fieldLeaveDate");

    let allEmployees = [];
    let editingId = null;
    let currentPage = 1;
    const pageSize = 10;
    let totalPages = 1;
    let totalCount = 0;
    let currentFilters = {keyword: "", department: "all"};

    function formatDate(raw) {
        if (!raw) return "";
        const d = new Date(raw);
        if (Number.isNaN(d.getTime())) return raw;
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${day}`;
    }

    function ensureDepartments(departments) {
        deptSelect.innerHTML = `<option value="all">全部部门</option>`;
        (departments || []).forEach(dep => {
            if (!dep) return;
            const opt = document.createElement("option");
            opt.value = dep;
            opt.textContent = dep;
            deptSelect.appendChild(opt);
        });
    }

    function renderTable(list) {
        if (!list.length) {
            tableBody.innerHTML = `<tr><td colspan="7" class="empty c-empty">没有符合条件的人员</td></tr>`;
            return;
        }
        tableBody.innerHTML = list.map(item => (
            `<tr>
          <td data-label="姓名">${item.name}</td>
          <td data-label="部门">${item.department_name}</td>
          <td data-label="职位">${item.position_name}</td>
          <td data-label="手机">${item.phone}</td>
          <td data-label="邮箱">${item.email}</td>
          <td data-label="入职日期">${formatDate(item.hire_date)}</td>
          <td data-label="操作">
            <div class="row-actions c-row-actions">
              <button data-action="edit" data-id="${item.id}">信息编辑</button>
              <button data-action="tech-edit" data-id="${item.id}">技术者编辑</button>
              <button data-action="permission" data-id="${item.id}">权限编辑</button>
            </div>
          </td>
        </tr>`
        )).join("");
    }

    function buildPageItems(totalPages, activePage) {
        if (totalPages <= 7) {
            return Array.from({length: totalPages}, (_, i) => i + 1);
        }
        const pages = [1];
        const start = Math.max(2, activePage - 1);
        const end = Math.min(totalPages - 1, activePage + 1);
        if (start > 2) pages.push("…");
        for (let i = start; i <= end; i += 1) pages.push(i);
        if (end < totalPages - 1) pages.push("…");
        pages.push(totalPages);
        return pages;
    }

    function renderPagination() {
        if (!pagination || !paginationPages) return;
        const safeTotalPages = Math.max(1, totalPages);
        if (currentPage > safeTotalPages) currentPage = safeTotalPages;
        paginationPages.innerHTML = "";
        const pageItems = buildPageItems(safeTotalPages, currentPage);
        paginationPages.append(...pageItems.map((page) => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "c-btn c-btn-ghost c-btn-sm";
            btn.textContent = String(page);
            if (page === "…") {
                btn.disabled = true;
                btn.classList.add("is-ellipsis");
                return btn;
            }
            btn.dataset.page = String(page);
            if (page === currentPage) {
                btn.classList.add("is-active");
            }
            return btn;
        }));
    }

    function renderPage() {
        renderTable(allEmployees);
        renderPagination();
        if (summaryText) {
            const safeTotalPages = Math.max(1, totalPages);
            summaryText.textContent = `共 ${totalCount} 人 · 第 ${currentPage}/${safeTotalPages} 页`;
        }
    }

    function buildPayload() {
        return {
            name: fieldName.value.trim(),
            gender: fieldGender.value === "" ? null : Number(fieldGender.value),
            birthday: fieldBirthday.value || "",
            department: fieldDepartment.value.trim(),
            position: fieldPosition.value.trim(),
            phone: fieldPhone.value.trim(),
            email: fieldEmail.value.trim(),
            address: fieldAddress.value.trim(),
            emergency_contact_name: fieldEmergencyName.value.trim(),
            emergency_contact_phone: fieldEmergencyPhone.value.trim(),
            emergency_contact_relationship: fieldEmergencyRelation.value.trim(),
            hire_date: fieldHireDate.value || "",
            leave_date: fieldLeaveDate.value || ""
        };
    }

    function applyFilter() {
        currentFilters = {
            keyword: (searchInput.value || "").trim(),
            department: deptSelect.value
        };
        currentPage = 1;
        fetchEmployees();
    }

    function resetFilters() {
        searchInput.value = "";
        deptSelect.value = "all";
        applyFilter();
    }


    function handleAction(e) {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;
        const action = btn.getAttribute("data-action");
        const id = btn.getAttribute("data-id");
        if (action === "edit") {
            const target = allEmployees.find(item => String(item.id) === String(id));
            if (target) openModal("edit", target);
        } else if (action === "tech-edit") {
            if (id) {
                try {
                    localStorage.setItem("tech_edit_employee_id", String(id));
                } catch (err) {
                }
            }
            try {
                if (window.parent && window.parent !== window) {
                    window.parent.location.hash = "people.html";
                    return;
                }
            } catch (err) {
            }
            window.location.href = "people.html";
        } else if (action === "permission") {
            openPermissionModal(id);
        }
    }

    function openModal(mode, data) {
        editingId = mode === "edit" ? data?.id : null;
        modalTitle.textContent = mode === "edit" ? "编辑人员" : "新增人员";
        fieldName.value = data?.name || "";
        fieldGender.value = data?.gender ?? "";
        fieldBirthday.value = formatDate(data?.birthday || "");
        fieldDepartment.value = data?.department || "";
        fieldPosition.value = data?.position || "";
        fieldPhone.value = data?.phone || "";
        fieldEmail.value = data?.email || "";
        fieldAddress.value = data?.address || "";
        fieldEmergencyName.value = data?.emergency_contact_name || "";
        fieldEmergencyPhone.value = data?.emergency_contact_phone || "";
        fieldEmergencyRelation.value = data?.emergency_contact_relationship || "";
        fieldHireDate.value = formatDate(data?.hire_date || "");
        fieldLeaveDate.value = formatDate(data?.leave_date || "");
        if (deleteBtn) {
            deleteBtn.classList.toggle("hidden", mode !== "edit");
        }
        employeeModal.classList.add("show");
        employeeModal.setAttribute("aria-hidden", "false");
    }

    function closeModal() {
        employeeModal.classList.remove("show");
        employeeModal.setAttribute("aria-hidden", "true");
        employeeForm.reset();
        editingId = null;
    }

    function openPermissionModal(id) {
        try {
            permissionModal?.setAttribute("data-employee-id", id ? String(id) : "");
        } catch (err) {
        }
        permissionModal.classList.add("show");
        permissionModal.setAttribute("aria-hidden", "false");
    }

    function closePermissionModal() {
        permissionModal.classList.remove("show");
        permissionModal.setAttribute("aria-hidden", "true");
    }

    async function createEmployee(payload) {
        const res = await fetchWithAuth(`/api/employees`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        const responsePayload = normalizeApiResponse(data);
        if (!res.ok || !responsePayload.success) {
            throw new Error(responsePayload.message || "新增失败");
        }
        return responsePayload.data || {};
    }

    async function updateEmployee(id, payload) {
        const res = await fetchWithAuth(`/api/employees/${id}`, {
            method: "PUT",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        const responsePayload = normalizeApiResponse(data);
        if (!res.ok || !responsePayload.success) {
            throw new Error(responsePayload.message || "更新失败");
        }
        return responsePayload.data || {};
    }

    async function deleteEmployee(id) {
        try {
            const res = await fetchWithAuth(`/api/employees/${id}`, {method: "DELETE"});
            const data = await res.json();
            const payload = normalizeApiResponse(data);
            if (!res.ok || !payload.success) {
                throw new Error(payload.message || "删除失败");
            }
            await fetchEmployees();
        } catch (err) {
            alert(`删除失败：${err.message}`);
        }
    }

    async function fetchEmployees() {
        tableBody.innerHTML = `<tr><td colspan="7" class="empty c-empty">加载中…</td></tr>`;
        try {
            const params = new URLSearchParams();
            if (currentFilters.keyword) params.append("keyword", currentFilters.keyword);
            if (currentFilters.department && currentFilters.department !== "all") {
                params.append("department", currentFilters.department);
            }
            params.append("page", String(currentPage));
            params.append("page_size", String(pageSize));
            const query = params.toString();
            const url = query ? `/api/employees?${query}` : "/api/employees";
            const res = await fetchWithAuth(url, {method: "GET"});
            const data = await res.json();
            const payload = normalizeApiResponse(data);
            if (!res.ok || !payload.success) {
                throw new Error(payload.message || "加载失败");
            }
            const result = payload.data || {};
            const meta = payload.meta || {};
            allEmployees = Array.isArray(result.items) ? result.items : [];
            totalCount = Number.isFinite(meta.total) ? meta.total : allEmployees.length;
            totalPages = Number.isFinite(meta.total_pages) ? meta.total_pages : 1;
            currentPage = Number.isFinite(meta.page) ? meta.page : currentPage;
            renderPage();
        } catch (err) {
            tableBody.innerHTML = `<tr><td colspan="7" class="empty c-empty">加载失败：${err.message}</td></tr>`;
            if (summaryText) {
                summaryText.textContent = "共 0 人";
            }
            totalCount = 0;
            totalPages = 1;
        }
    }

    async function fetchDepartments() {
        try {
            const res = await fetchWithAuth("/api/employees/departments", {method: "GET"});
            const data = await res.json();
            const payload = normalizeApiResponse(data);
            if (!res.ok || !payload.success) {
                throw new Error(payload.message || "加载失败");
            }
            const result = payload.data || {};
            ensureDepartments(result.departments || []);
        } catch (err) {
            ensureDepartments([]);
        }
    }

    fetchDepartments();
    fetchEmployees();
    applyFilterBtn.addEventListener("click", applyFilter);
    deptSelect.addEventListener("change", applyFilter);
    resetBtn.addEventListener("click", resetFilters);
    pagination.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-page]");
        if (!btn) return;
        const value = btn.dataset.page;
        const safeTotalPages = Math.max(1, totalPages);
        if (value === "prev") {
            currentPage = Math.max(1, currentPage - 1);
        } else if (value === "next") {
            currentPage = Math.min(safeTotalPages, currentPage + 1);
        } else {
            const targetPage = Number(value);
            if (!Number.isNaN(targetPage)) currentPage = targetPage;
        }
        fetchEmployees();
    });
    tableBody.addEventListener("click", handleAction);
    addBtn.addEventListener("click", () => openModal("add"));
    modalClose.addEventListener("click", closeModal);
    cancelBtn.addEventListener("click", closeModal);
    deleteBtn.addEventListener("click", () => {
        if (!editingId) return;
        const target = allEmployees.find(item => String(item.id) === String(editingId));
        const name = target?.name || "";
        if (!confirm(`确认删除 ${name}？`)) return;
        deleteEmployee(editingId);
        closeModal();
    });
    permissionClose.addEventListener("click", closePermissionModal);
    permissionModal.addEventListener("click", (e) => {
        if (e.target === permissionModal) closePermissionModal();
    });
    employeeModal.addEventListener("click", (e) => {
        if (e.target === employeeModal) closeModal();
    });
    employeeForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const payload = buildPayload();
        if (!payload.name) {
            alert("姓名不能为空");
            return;
        }
        try {
            if (editingId) {
                await updateEmployee(editingId, payload);
            } else {
                await createEmployee(payload);
            }
            closeModal();
            await fetchEmployees();
        } catch (err) {
            alert(err.message || "保存失败");
        }
    });
</script>
</body>
</html>
