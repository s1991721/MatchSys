<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/favicon-32.png" type="image/png" sizes="32x32">
    <link rel="stylesheet" href="common.css">
  <link rel="stylesheet" href="components.css">
  <title data-i18n="songxin.title">送信页</title>
    <style>
* {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "PingFang SC", "Helvetica Neue", Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .page {
            max-width: 1200px;
            margin: 24px auto 32px;
            padding: 0 20px 24px;
        }

        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
            align-items: stretch;
        }

            .grid + .grid {
                margin-top: 16px;
            }
/* 让内容编辑卡片填满可用高度 */
        .editor-card {
            min-height: 520px;
        }

        .editor {
            width: 100%;
            min-height: 420px;
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid #d8dfec;
            background: linear-gradient(180deg, #fbfcff 0%, #f6f7fb 100%);
            font-size: 15px;
            line-height: 1.6;
            resize: vertical;
            outline: none;
            color: var(--text);
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        .editor:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(28, 123, 255, 0.14);
            background: #ffffff;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 14px;
        }

        .field label {
            font-size: 13px;
            color: var(--muted);
        }

        .input {
            width: 100%;
            border-radius: 10px;
            border: 1px solid #d8dfec;
            padding: 12px 12px;
            font-size: 14px;
            outline: none;
            background: #fdfdff;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        .input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(28, 123, 255, 0.12);
            background: #ffffff;
        }

        .subject-area {
            min-height: 70px;
            line-height: 1.5;
            resize: vertical;
        }

        .send-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            margin-top: 4px;
        }

        .detail {
            font-size: 14px;
            color: #455164;
            line-height: 1.7;
            min-height: 140px;
            white-space: pre-line;
        }

        .muted-block {
            background: #f8faff;
            border: 1px dashed #d7e1f4;
            border-radius: 10px;
            padding: 12px 14px;
            color: #556074;
            font-size: 13px;
            line-height: 1.6;
        }

        .upload-bar {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-hint {
            color: var(--muted);
            font-size: 12px;
        }

        .file-input {
            display: none;
        }

            .attachment-list {
                margin-top: 10px;
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

        .attachment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border: 1px solid #e0e7f3;
            border-radius: 10px;
            background: #f9fbff;
        }

        .attachment-name {
            font-size: 13px;
            color: #2f3b4d;
        }

        .attachment-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #6b7686;
            font-size: 12px;
        }

        .remove-link {
            color: #e35d5d;
            cursor: pointer;
            font-weight: 600;
        }

        .empty-tip {
            color: var(--muted);
            font-size: 13px;
        }

        @media (max-width: 980px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .editor {
                height: 280px;
            }
        }

        .loading-mask {
            position: fixed;
            inset: 0;
            background: rgba(18, 36, 66, 0.14);
            backdrop-filter: blur(3px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .loading-box {
            background: #0c1d36;
            color: #e9f2ff;
            padding: 18px 22px;
            border-radius: 14px;
            box-shadow: 0 16px 32px rgba(12, 29, 54, 0.35);
            min-width: 280px;
            display: grid;
            gap: 8px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .loading-main {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            letter-spacing: 0.3px;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.18);
            border-top-color: #68a8ff;
            animation: spin 0.9s linear infinite;
        }

        .loading-sub {
            color: #9db7dd;
            font-size: 13px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
  </style>
</head>
<body>
    <div id="loading-mask" class="loading-mask" role="status" aria-live="assertive" aria-busy="true" hidden>
        <div class="loading-box">
            <div class="loading-main">
                <div class="spinner" aria-hidden="true"></div>
                <div id="loading-text" data-i18n="songxin.loading.wait_title">正在等待 AI 响应…</div>
            </div>
            <div id="loading-sub" class="loading-sub" data-i18n="songxin.loading.wait_sub">请稍候，正在处理中…</div>
        </div>
    </div>
    <div class="page">
        <header class="page-header c-page-header">
            <div>
                <div class="title c-page-title-soft" data-i18n="songxin.title">送信页</div>
                <div class="subtitle c-page-subtitle-soft" data-i18n="songxin.subtitle">整页编辑模式，直接书写并发送邮件内容</div>
            </div>
            <div class="subtitle c-page-subtitle-soft">
                <span data-i18n="songxin.status.label">状态</span>：
                <span data-i18n="songxin.status.draft">草稿</span>
            </div>
        </header>

        <section class="grid">
            <div class="editor-card c-card c-card-pad">
                <div class="c-card-title" data-i18n="songxin.section.editor">内容编辑</div>
                <textarea id="editor" class="editor" placeholder="在此编写您要发送的内容，例如项目进度、补充说明或会议纪要等。" aria-label="内容编辑文本域" data-i18n-placeholder="songxin.editor.placeholder" data-i18n-aria="songxin.editor.aria"></textarea>
            </div>

            <div class="c-card">
                <div class="c-card-title" data-i18n="songxin.section.recipient">收件与附件</div>
                <div class="field">
                    <label for="email" data-i18n="songxin.field.to">收件人邮箱</label>
                    <input id="email" type="email" class="input" placeholder="name@example.com">
                </div>
                <div class="field">
                    <label for="subject" data-i18n="songxin.field.subject">邮件标题</label>
                    <textarea id="subject" class="input subject-area" rows="2" placeholder="请输入邮件标题（未填将使用正文首行）" data-i18n-placeholder="songxin.field.subject_placeholder"></textarea>
                </div>
                <div class="field">
                    <label for="cc" data-i18n="songxin.field.cc">抄送 (可选)</label>
                    <input id="cc" type="email" class="input" placeholder="cc@example.com">
                </div>
                <div class="field">
                    <label for="file-input" data-i18n="songxin.field.attach">上传附件</label>
                    <div class="upload-bar">
                        <input id="file-input" class="file-input" type="file" multiple>
                        <button id="btn-upload" class="c-btn c-btn-ghost" type="button" data-i18n="songxin.action.select_file">选择文件</button>
                        <span class="upload-hint" data-i18n="songxin.attach.hint">支持多文件，建议单个不超过10MB</span>
                    </div>
                    <div id="attachment-list" class="attachment-list">
                        <div class="empty-tip" data-i18n="songxin.attach.empty">暂无附件</div>
                    </div>
                </div>
                <div class="send-actions">
                    <button id="btn-clear" class="c-btn c-btn-ghost" type="button" data-i18n="songxin.action.clear">清空内容</button>
                    <button id="btn-send" class="c-btn c-btn-primary" type="button" aria-label="发送" data-i18n-aria="songxin.action.send">
                        <span data-i18n="songxin.action.send">发送</span>
                        <span aria-hidden="true">➤</span>
                    </button>
                </div>
            </div>
        </section>

        <section class="grid">
            <div class="c-card">
                <div class="c-card-title" data-i18n="songxin.section.preview">预览</div>
                <div id="preview" class="detail">
                    这里会展示即将发送的正文预览，确认排版、换行和关键内容是否完整。ABCDEFG1234567890不想超出屏幕会自动换行。
                </div>
            </div>
            <div class="c-card">
                <div class="c-card-title" data-i18n="songxin.section.tips">提醒</div>
                <div class="muted-block">
                    · <span data-i18n="songxin.tip.1">请确认邮箱地址无误再发送。</span><br>
                    · <span data-i18n="songxin.tip.2">已支持在页面右侧上传附件，发送前请核对文件列表。</span><br>
                    · <span data-i18n="songxin.tip.3">内容较长时建议分段，保持易读性。</span><br>
                    · <span data-i18n="songxin.tip.4">发送后可在历史记录中查看送信状态。</span>
                </div>
            </div>
        </section>
    </div>

    <script src="i18n.js"></script>
    <script src="common.js"></script>
<script>
        (function () {
            const i18n = window.I18N;
            const t = (key) => (i18n ? i18n.t(key) : key);
            const format = (key, vars) => (i18n ? i18n.format(key, vars) : key);
            const editor = document.getElementById('editor');
            const email = document.getElementById('email');
            const subjectInput = document.getElementById('subject');
            const cc = document.getElementById('cc');
            const preview = document.getElementById('preview');
            const clearBtn = document.getElementById('btn-clear');
            const sendBtn = document.getElementById('btn-send');
            const uploadBtn = document.getElementById('btn-upload');
            const fileInput = document.getElementById('file-input');
            const attachmentList = document.getElementById('attachment-list');
            const loadingMask = document.getElementById('loading-mask');
            const loadingText = document.getElementById('loading-text');
            const loadingSub = document.getElementById('loading-sub');
            const API_BASE = '';
            if (i18n) {
                i18n.init();
                i18n.apply();
            }
            const fetchWithAuth = async (url, options = {}) => {
                const res = await fetch(url, options);
                if (res.status === 401) {
                    window.location.href = '/login.html';
                    throw new Error('Unauthorized');
                }
                return res;
            };
            const attachments = [];
            const selectionKey = 'matchSelection';
            let loadingTimer = null;
            let currentSelection = null;

            const readSelection = () => {
                const raw = localStorage.getItem(selectionKey);
                if (!raw) {
                    currentSelection = null;
                    return null;
                }
                try {
                    currentSelection = JSON.parse(raw);
                } catch {
                    currentSelection = null;
                }
                return currentSelection;
            };

            const extractEmail = (raw) => {
                if (!raw) return '';
                const bracketMatch = raw.match(/<([^>]+)>/);
                if (bracketMatch && bracketMatch[1]) {
                    return bracketMatch[1].trim();
                }
                const emailMatch = raw.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
                return emailMatch ? emailMatch[0].trim() : '';
            };

            const applySelectionFromMatch = () => {
                const data = readSelection();
                if (!data || !data.job || !data.person) return null;

                const job = data.job || {};
                const person = data.person || {};

                const jobLines = [
                    t('songxin.job_info'),
                    job.title ? `${t('songxin.label.title')}：${job.title}` : null,
                    job.desc ? `${t('songxin.label.desc')}：${job.desc}` : null,
                    job.time ? `${t('songxin.label.time')}：${job.time}` : null,
                    job.detail ? `${t('songxin.label.detail')}：\n${job.detail}` : null
                ].filter(Boolean).join('\n');

                const personLines = [
                    t('songxin.person_info'),
                    person.name ? `${t('songxin.label.name')}：${person.name}` : null,
                    person.belong ? `${t('songxin.label.belong')}：${person.belong}` : null,
                    person.time ? `${t('songxin.label.time')}：${person.time}` : null,
                    person.detail ? `${t('songxin.label.detail')}：\n${person.detail}` : null
                ].filter(Boolean).join('\n');

                const combined = [jobLines, personLines].filter(Boolean).join('\n\n');

                if (combined) {
                    editor.value = combined;
                }

                const personSubject = person.subject || person.title || person.name || '';
                if (personSubject) {
                    subjectInput.value = personSubject.startsWith('Re:')
                        ? personSubject
                        : `Re: ${personSubject}`;
                } else {
                    subjectInput.value = deriveSubject(combined);
                }

                if (!email.value) {
                    const replyTo = extractEmail(person.belong || person.from || '');
                    if (replyTo) {
                        email.value = replyTo;
                    }
                }

                return job.detail || job.desc || jobLines || '';
            };

            const setLoading = (isLoading, options = {}) => {
                const { title = t('songxin.loading.processing'), subtitle = t('songxin.loading.wait_sub') } =
                    typeof options === 'string'
                        ? { title: options, subtitle: t('songxin.loading.wait_sub') }
                        : options;

                if (isLoading) {
                    loadingText.textContent = title;
                    loadingSub.textContent = subtitle;
                    loadingMask.hidden = false;
                    loadingMask.style.display = 'none';
                    loadingMask.setAttribute('aria-busy', 'true');
                    // 避免闪屏：只有超过 200ms 的等待才展示
                    clearTimeout(loadingTimer);
                    loadingTimer = setTimeout(() => {
                        loadingMask.style.display = 'flex';
                    }, 200);
                    return;
                }
                clearTimeout(loadingTimer);
                loadingMask.hidden = true;
                loadingMask.style.display = 'none';
                loadingMask.setAttribute('aria-busy', 'false');
            };

            const analyzeQiuren = async (jobText) => {
                if (!jobText) return;
                setLoading(true, { title: t('songxin.loading.analyze_title'), subtitle: t('songxin.loading.analyze_sub') });
                try {
                    const res = await fetchWithAuth(`${API_BASE}/extract-qiuren-detail`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ text: jobText })
                    });
                    if (!res.ok) {
                        throw new Error(`HTTP ${res.status}`);
                    }
                    const data = await res.json();
                    const payload = normalizeApiResponse(data);
                    if (!payload.success) {
                        throw new Error(payload.message || '解析失败');
                    }
                    const result = payload.data || {};
                    const message = typeof result.data === 'string' ? result.data.trim() : '';
                    let formatted = message;
                    if (!formatted) {
                        if (result.data) {
                            formatted = JSON.stringify(result.data, null, 2);
                        } else if (typeof result.raw === 'string') {
                            formatted = result.raw;
                        } else {
                            formatted = '';
                        }
                    }
                    const normalized = normalizeMultiline(formatted);
                    editor.value = normalized || t('songxin.preview.unavailable');
                    renderPreview();
                } catch (err) {
                    console.error('调用 extract_qiuren_detail 失败', err);
                    alert(t('songxin.alert.ai_unavailable'));
                } finally {
                    setLoading(false);
                }
            };

            const formatSize = (bytes) => {
                if (bytes < 1024) return bytes + 'B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + 'KB';
                return (bytes / (1024 * 1024)).toFixed(1) + 'MB';
            };

            const readFileAsBase64 = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const result = reader.result || '';
                    const base64 = typeof result === 'string' && result.includes(',')
                        ? result.split(',').pop()
                        : result;
                    resolve(base64);
                };
                reader.onerror = () => reject(reader.error || new Error(t('songxin.loading.file_failed')));
                reader.readAsDataURL(file);
            });

            const normalizeMultiline = (text) => {
                if (typeof text !== 'string') return '';
                let clean = text
                    .replace(/\r\n/g, '\n')
                    .replace(/\\n/g, '\n')
                    .replace(/\t/g, '    ');
                const trimmed = clean.trim();
                if (trimmed.startsWith('"') && trimmed.endsWith('"')) {
                    clean = trimmed.slice(1, -1);
                }
                return clean;
            };

            const deriveSubject = (text) => {
                const firstLine = (text || '').split('\n').map(t => t.trim()).find(Boolean);
                if (!firstLine) return t('songxin.subject.default');
                return firstLine.slice(0, 60);
            };

            const renderAttachments = () => {
                if (!attachments.length) {
                    attachmentList.innerHTML = `<div class="empty-tip">${t('songxin.attach.empty')}</div>`;
                    return;
                }

                attachmentList.innerHTML = attachments.map((file, idx) => `
                    <div class="attachment-item" data-idx="${idx}">
                        <div class="attachment-name">${file.name}</div>
                        <div class="attachment-meta">
                            <span>${file.sizeLabel}</span>
                            <span class="remove-link" data-remove="${idx}">${t('songxin.attach.remove')}</span>
                        </div>
                    </div>
                `).join('');
            };

            const renderPreview = () => {
                const content = editor.value.trim();

                if (!content) {
                    preview.textContent = t('songxin.preview.empty');
                    return;
                }

                // 使用 textContent 搭配 pre-line 确保换行正常展示
                preview.textContent = content;
            };

            clearBtn.addEventListener('click', () => {
                editor.value = '';
                email.value = '';
                subjectInput.value = '';
                cc.value = '';
                attachments.length = 0;
                renderAttachments();
                renderPreview();
                editor.focus();
            });

            editor.addEventListener('input', renderPreview);
            uploadBtn.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', () => {
                const files = Array.from(fileInput.files || []);
                files.forEach(f => attachments.push({
                    file: f,
                    name: f.name,
                    sizeLabel: formatSize(f.size),
                    type: f.type || 'application/octet-stream',
                    size: f.size
                }));
                fileInput.value = '';
                renderAttachments();
            });

            attachmentList.addEventListener('click', (e) => {
                const idx = e.target.getAttribute('data-remove');
                if (idx === null) return;
                attachments.splice(Number(idx), 1);
                renderAttachments();
            });

            sendBtn.addEventListener('click', async () => {
                const target = email.value.trim();
                if (!target) {
                    alert(t('songxin.alert.email_required'));
                    email.focus();
                    return;
                }
                const content = editor.value.trim();
                if (!content) {
                    alert(t('songxin.alert.content_required'));
                    editor.focus();
                    return;
                }

                const selection = currentSelection || readSelection();
                const personMeta = selection?.person || null;

                setLoading(true, { title: t('songxin.loading.sending_title'), subtitle: t('songxin.loading.sending_sub') });
                try {
                    const attachmentsPayload = await Promise.all(
                        attachments.map(async (att) => ({
                            filename: att.name,
                            content_type: att.type,
                            content: await readFileAsBase64(att.file)
                        }))
                    );

                    const subject = subjectInput.value.trim() || deriveSubject(content);

                    const payload = {
                        to: target,
                        cc: cc.value.trim(),
                        subject,
                        body: content,
                        attachments: attachmentsPayload
                    };
                    if (personMeta) {
                        if (personMeta.thread_id) {
                            payload.thread_id = personMeta.thread_id;
                        }
                        if (personMeta.message_id_header) {
                            payload.in_reply_to = personMeta.message_id_header;
                        }
                        if (personMeta.references_header) {
                            payload.references = personMeta.references_header;
                        }
                    }

                    const res = await fetchWithAuth(`${API_BASE}/send-mail`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(payload)
                    });

                    if (!res.ok) {
                        const err = await res.json().catch(() => ({}));
                        const errPayload = normalizeApiResponse(err);
                        throw new Error(errPayload.message || `HTTP ${res.status}`);
                    }
                    const data = await res.json().catch(() => ({}));
                    const responsePayload = normalizeApiResponse(data);
                    if (!responsePayload.success) {
                        throw new Error(responsePayload.message || '发送失败');
                    }

                    alert(t('songxin.alert.sent'));
                    window.location.href = 'songxinhistory.html';
                } catch (err) {
                    console.error('发送邮件失败', err);
                    alert(format('songxin.alert.send_failed', { error: err.message || err }));
                } finally {
                    setLoading(false);
                }
            });

            const jobText = applySelectionFromMatch();
            renderAttachments();
            renderPreview();
            analyzeQiuren(jobText);
            if (window && window.addEventListener) {
                window.addEventListener("i18n:change", () => {
                    if (i18n) {
                        i18n.apply();
                    }
                    renderAttachments();
                    renderPreview();
                });
            }
        })();
    </script>
</body>
</html>
