<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>送信页</title>
    <style>
        :root {
            --bg: #f4f6fb;
            --card: #ffffff;
            --line: #e5e9f2;
            --primary: #1c7bff;
            --text: #1f2a3d;
            --muted: #6b7686;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "PingFang SC", "Helvetica Neue", Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .page {
            max-width: 1200px;
            margin: 24px auto 32px;
            padding: 0 20px 24px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin: 6px 0 18px;
        }

        .title {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: 0.3px;
        }

        .subtitle {
            color: var(--muted);
            font-size: 14px;
        }

        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
            align-items: stretch;
        }

            .grid + .grid {
                margin-top: 16px;
            }

        .card {
            background: var(--card);
            border-radius: 12px;
            border: 1px solid var(--line);
            box-shadow: 0 12px 28px rgba(31, 53, 90, 0.08);
            padding: 16px 18px 18px;
            display: flex;
            flex-direction: column;
        }

        /* 让内容编辑卡片填满可用高度 */
        .editor-card {
            min-height: 520px;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .card-title::before {
            content: "";
            width: 4px;
            height: 18px;
            border-radius: 12px;
            background: var(--primary);
            box-shadow: 0 0 0 6px rgba(28, 123, 255, 0.12);
        }

        .editor {
            width: 100%;
            min-height: 420px;
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid #d8dfec;
            background: linear-gradient(180deg, #fbfcff 0%, #f6f7fb 100%);
            font-size: 15px;
            line-height: 1.6;
            resize: vertical;
            outline: none;
            color: var(--text);
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        .editor:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(28, 123, 255, 0.14);
            background: #ffffff;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 14px;
        }

        .field label {
            font-size: 13px;
            color: var(--muted);
        }

        .input {
            width: 100%;
            border-radius: 10px;
            border: 1px solid #d8dfec;
            padding: 12px 12px;
            font-size: 14px;
            outline: none;
            background: #fdfdff;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        .input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(28, 123, 255, 0.12);
            background: #ffffff;
        }

        .subject-area {
            min-height: 70px;
            line-height: 1.5;
            resize: vertical;
        }

        .send-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            margin-top: 4px;
        }

        .ghost-button {
            border: 1px solid #d8dfec;
            background: #f7f9fd;
            color: #405169;
            border-radius: 10px;
            padding: 10px 14px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.15s ease, border-color 0.15s ease;
        }

        .ghost-button:hover {
            background: #eef3fb;
            border-color: #cfd7e6;
        }

        .send-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 11px 18px;
            background: linear-gradient(135deg, #5e90ff, #2e7bff);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 12px 24px rgba(46, 123, 255, 0.25);
            transition: transform 0.12s ease, box-shadow 0.12s ease;
        }

        .send-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 14px 28px rgba(46, 123, 255, 0.28);
        }

        .send-button:active {
            transform: translateY(0);
        }

        .detail {
            font-size: 14px;
            color: #455164;
            line-height: 1.7;
            min-height: 140px;
            white-space: pre-line;
        }

        .muted-block {
            background: #f8faff;
            border: 1px dashed #d7e1f4;
            border-radius: 10px;
            padding: 12px 14px;
            color: #556074;
            font-size: 13px;
            line-height: 1.6;
        }

        .upload-bar {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-hint {
            color: var(--muted);
            font-size: 12px;
        }

        .file-input {
            display: none;
        }

            .attachment-list {
                margin-top: 10px;
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

        .attachment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border: 1px solid #e0e7f3;
            border-radius: 10px;
            background: #f9fbff;
        }

        .attachment-name {
            font-size: 13px;
            color: #2f3b4d;
        }

        .attachment-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #6b7686;
            font-size: 12px;
        }

        .remove-link {
            color: #e35d5d;
            cursor: pointer;
            font-weight: 600;
        }

        .empty-tip {
            color: var(--muted);
            font-size: 13px;
        }

        @media (max-width: 980px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .editor {
                height: 280px;
            }
        }

        .loading-mask {
            position: fixed;
            inset: 0;
            background: rgba(18, 36, 66, 0.14);
            backdrop-filter: blur(3px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .loading-box {
            background: #0c1d36;
            color: #e9f2ff;
            padding: 18px 22px;
            border-radius: 14px;
            box-shadow: 0 16px 32px rgba(12, 29, 54, 0.35);
            min-width: 280px;
            display: grid;
            gap: 8px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .loading-main {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            letter-spacing: 0.3px;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.18);
            border-top-color: #68a8ff;
            animation: spin 0.9s linear infinite;
        }

        .loading-sub {
            color: #9db7dd;
            font-size: 13px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <div id="loading-mask" class="loading-mask" role="status" aria-live="assertive" aria-busy="true" hidden>
        <div class="loading-box">
            <div class="loading-main">
                <div class="spinner" aria-hidden="true"></div>
                <div id="loading-text">正在等待 AI 响应…</div>
            </div>
            <div id="loading-sub" class="loading-sub">请稍候，正在处理中…</div>
        </div>
    </div>
    <div class="page">
        <header class="page-header">
            <div>
                <div class="title">送信页</div>
                <div class="subtitle">整页编辑模式，直接书写并发送邮件内容</div>
            </div>
            <div class="subtitle">状态：草稿</div>
        </header>

        <section class="grid">
            <div class="card editor-card">
                <div class="card-title">内容编辑</div>
                <textarea id="editor" class="editor" placeholder="在此编写您要发送的内容，例如项目进度、补充说明或会议纪要等。" aria-label="内容编辑文本域"></textarea>
            </div>

            <div class="card">
                <div class="card-title">收件与附件</div>
                <div class="field">
                    <label for="email">收件人邮箱</label>
                    <input id="email" type="email" class="input" placeholder="name@example.com">
                </div>
                <div class="field">
                    <label for="subject">邮件标题</label>
                    <textarea id="subject" class="input subject-area" rows="2" placeholder="请输入邮件标题（未填将使用正文首行）"></textarea>
                </div>
                <div class="field">
                    <label for="cc">抄送 (可选)</label>
                    <input id="cc" type="email" class="input" placeholder="cc@example.com">
                </div>
                <div class="field">
                    <label for="file-input">上传附件</label>
                    <div class="upload-bar">
                        <input id="file-input" class="file-input" type="file" multiple>
                        <button id="btn-upload" class="ghost-button" type="button">选择文件</button>
                        <span class="upload-hint">支持多文件，建议单个不超过10MB</span>
                    </div>
                    <div id="attachment-list" class="attachment-list">
                        <div class="empty-tip">暂无附件</div>
                    </div>
                </div>
                <div class="send-actions">
                    <button id="btn-clear" class="ghost-button" type="button">清空内容</button>
                    <button id="btn-send" class="send-button" type="button" aria-label="发送">
                        <span>发送</span>
                        <span aria-hidden="true">➤</span>
                    </button>
                </div>
            </div>
        </section>

        <section class="grid">
            <div class="card">
                <div class="card-title">预览</div>
                <div id="preview" class="detail">
                    这里会展示即将发送的正文预览，确认排版、换行和关键内容是否完整。ABCDEFG1234567890不想超出屏幕会自动换行。
                </div>
            </div>
            <div class="card">
                <div class="card-title">提醒</div>
                <div class="muted-block">
                    · 请确认邮箱地址无误再发送。<br>
                    · 已支持在页面右侧上传附件，发送前请核对文件列表。<br>
                    · 内容较长时建议分段，保持易读性。<br>
                    · 发送后可在历史记录中查看送信状态。
                </div>
            </div>
        </section>
    </div>

    <script>
        (function () {
            const editor = document.getElementById('editor');
            const email = document.getElementById('email');
            const subjectInput = document.getElementById('subject');
            const cc = document.getElementById('cc');
            const preview = document.getElementById('preview');
            const clearBtn = document.getElementById('btn-clear');
            const sendBtn = document.getElementById('btn-send');
            const uploadBtn = document.getElementById('btn-upload');
            const fileInput = document.getElementById('file-input');
            const attachmentList = document.getElementById('attachment-list');
            const loadingMask = document.getElementById('loading-mask');
            const loadingText = document.getElementById('loading-text');
            const loadingSub = document.getElementById('loading-sub');
            const API_BASE = '';
            const fetchWithAuth = async (url, options = {}) => {
                const res = await fetch(url, options);
                if (res.status === 401) {
                    window.location.href = '/login.html';
                    throw new Error('Unauthorized');
                }
                return res;
            };
            const attachments = [];
            const selectionKey = 'matchSelection';
            let loadingTimer = null;

            const readSelection = () => {
                const raw = localStorage.getItem(selectionKey);
                if (!raw) return null;
                try {
                    return JSON.parse(raw);
                } catch {
                    return null;
                }
            };

            const applySelectionFromMatch = () => {
                const data = readSelection();
                if (!data || !data.job || !data.person) return null;

                const job = data.job || {};
                const person = data.person || {};

                const jobLines = [
                    '【求人信息】',
                    job.title ? `标题：${job.title}` : null,
                    job.desc ? `描述：${job.desc}` : null,
                    job.time ? `时间：${job.time}` : null,
                    job.detail ? `详情：\n${job.detail}` : null
                ].filter(Boolean).join('\n');

                const personLines = [
                    '【人员信息】',
                    person.name ? `姓名：${person.name}` : null,
                    person.belong ? `所属：${person.belong}` : null,
                    person.time ? `时间：${person.time}` : null,
                    person.detail ? `详情：\n${person.detail}` : null
                ].filter(Boolean).join('\n');

                const combined = [jobLines, personLines].filter(Boolean).join('\n\n');

                if (combined) {
                    editor.value = combined;
                }

                // 默认主题优先使用求人标题，其次人员姓名，再其次取正文首行
                if (job.title) {
                    subjectInput.value = job.title;
                } else if (person.name) {
                    subjectInput.value = `${person.name} - 应聘`;
                } else {
                    subjectInput.value = deriveSubject(combined);
                }

                return job.detail || job.desc || jobLines || '';
            };

            const setLoading = (isLoading, options = {}) => {
                const { title = '正在处理…', subtitle = '请稍候，正在处理中…' } =
                    typeof options === 'string'
                        ? { title: options, subtitle: '请稍候，正在处理中…' }
                        : options;

                if (isLoading) {
                    loadingText.textContent = title;
                    loadingSub.textContent = subtitle;
                    loadingMask.hidden = false;
                    loadingMask.style.display = 'none';
                    loadingMask.setAttribute('aria-busy', 'true');
                    // 避免闪屏：只有超过 200ms 的等待才展示
                    clearTimeout(loadingTimer);
                    loadingTimer = setTimeout(() => {
                        loadingMask.style.display = 'flex';
                    }, 200);
                    return;
                }
                clearTimeout(loadingTimer);
                loadingMask.hidden = true;
                loadingMask.style.display = 'none';
                loadingMask.setAttribute('aria-busy', 'false');
            };

            const analyzeQiuren = async (jobText) => {
                if (!jobText) return;
                setLoading(true, { title: '正在生成邮件内容…', subtitle: 'AI 正在解析信息并准备正文，请稍候。' });
                try {
                    const res = await fetchWithAuth(`${API_BASE}/extract-qiuren-detail`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ text: jobText })
                    });
                    if (!res.ok) {
                        throw new Error(`HTTP ${res.status}`);
                    }
                    const data = await res.json();
                    const formatted =
                        data.data
                            ? JSON.stringify(data.data, null, 2)
                            : (typeof data.raw === 'string' ? data.raw : '');
                    const content = [
                        '【解析结果】',
                        formatted || '暂无结果'
                    ].join('\n');
                    editor.value = content;
                    renderPreview();
                } catch (err) {
                    console.error('调用 extract_qiuren_detail 失败', err);
                    alert('AI 解析暂时不可用，请稍后重试。');
                } finally {
                    setLoading(false);
                }
            };

            const formatSize = (bytes) => {
                if (bytes < 1024) return bytes + 'B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + 'KB';
                return (bytes / (1024 * 1024)).toFixed(1) + 'MB';
            };

            const readFileAsBase64 = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const result = reader.result || '';
                    const base64 = typeof result === 'string' && result.includes(',')
                        ? result.split(',').pop()
                        : result;
                    resolve(base64);
                };
                reader.onerror = () => reject(reader.error || new Error('读取文件失败'));
                reader.readAsDataURL(file);
            });

            const deriveSubject = (text) => {
                const firstLine = (text || '').split('\n').map(t => t.trim()).find(Boolean);
                if (!firstLine) return '送信页邮件';
                return firstLine.slice(0, 60);
            };

            const renderAttachments = () => {
                if (!attachments.length) {
                    attachmentList.innerHTML = '<div class="empty-tip">暂无附件</div>';
                    return;
                }

                attachmentList.innerHTML = attachments.map((file, idx) => `
                    <div class="attachment-item" data-idx="${idx}">
                        <div class="attachment-name">${file.name}</div>
                        <div class="attachment-meta">
                            <span>${file.sizeLabel}</span>
                            <span class="remove-link" data-remove="${idx}">移除</span>
                        </div>
                    </div>
                `).join('');
            };

            const renderPreview = () => {
                const content = editor.value.trim();

                if (!content) {
                    preview.textContent = '这里会展示即将发送的正文预览，确认排版、换行和关键内容是否完整。';
                    return;
                }

                // 使用 textContent 搭配 pre-line 确保换行正常展示
                preview.textContent = content;
            };

            clearBtn.addEventListener('click', () => {
                editor.value = '';
                email.value = '';
                subjectInput.value = '';
                cc.value = '';
                attachments.length = 0;
                renderAttachments();
                renderPreview();
                editor.focus();
            });

            editor.addEventListener('input', renderPreview);
            uploadBtn.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', () => {
                const files = Array.from(fileInput.files || []);
                files.forEach(f => attachments.push({
                    file: f,
                    name: f.name,
                    sizeLabel: formatSize(f.size),
                    type: f.type || 'application/octet-stream',
                    size: f.size
                }));
                fileInput.value = '';
                renderAttachments();
            });

            attachmentList.addEventListener('click', (e) => {
                const idx = e.target.getAttribute('data-remove');
                if (idx === null) return;
                attachments.splice(Number(idx), 1);
                renderAttachments();
            });

            sendBtn.addEventListener('click', async () => {
                const target = email.value.trim();
                if (!target) {
                    alert('请先填写收件人邮箱。');
                    email.focus();
                    return;
                }
                const content = editor.value.trim();
                if (!content) {
                    alert('请输入邮件正文后再发送。');
                    editor.focus();
                    return;
                }

                setLoading(true, { title: '正在发送邮件…', subtitle: '正在上传附件并发送，请稍候。' });
                try {
                    const attachmentsPayload = await Promise.all(
                        attachments.map(async (att) => ({
                            filename: att.name,
                            content_type: att.type,
                            content: await readFileAsBase64(att.file)
                        }))
                    );

                    const subject = subjectInput.value.trim() || deriveSubject(content);

                    const payload = {
                        to: target,
                        cc: cc.value.trim(),
                        subject,
                        body: content,
                        attachments: attachmentsPayload
                    };

                    const res = await fetchWithAuth(`${API_BASE}/send-mail`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(payload)
                    });

                    if (!res.ok) {
                        const err = await res.json().catch(() => ({}));
                        throw new Error(err.error || `HTTP ${res.status}`);
                    }

                    alert('发送成功！即将跳转到历史记录。');
                    window.location.href = 'songxinhistory.html';
                } catch (err) {
                    console.error('发送邮件失败', err);
                    alert(`发送失败：${err.message || err}`);
                } finally {
                    setLoading(false);
                }
            });

            const jobText = applySelectionFromMatch();
            renderAttachments();
            renderPreview();
            analyzeQiuren(jobText);
        })();
    </script>
</body>
</html>
