<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/favicon-32.png" type="image/png" sizes="32x32">
    <link rel="stylesheet" href="common.css">
  <link rel="stylesheet" href="components.css">
  <title data-i18n="songxin.title">送信页</title>
</head>
<body>
    <div id="loading-mask" class="songxin-loading-mask" role="status" aria-live="assertive" aria-busy="true" hidden>
        <div class="songxin-loading-box">
            <div class="songxin-loading-main">
                <div class="songxin-spinner" aria-hidden="true"></div>
                <div id="loading-text" data-i18n="songxin.loading.wait_title">正在等待 AI 响应…</div>
            </div>
            <div id="loading-sub" class="songxin-loading-sub" data-i18n="songxin.loading.wait_sub">请稍候，正在处理中…</div>
        </div>
    </div>
    <div class="page page-wide songxin-page">
        <section class="songxin-grid songxin-grid-half">
            <div class="songxin-editor-card c-card c-card-pad">
                <div class="c-card-title" data-i18n="songxin.section.editor">内容编辑</div>
                <textarea id="editor" class="songxin-editor" placeholder="在此编写您要发送的内容，例如项目进度、补充说明或会议纪要等。" aria-label="内容编辑文本域" data-i18n-placeholder="songxin.editor.placeholder" data-i18n-aria="songxin.editor.aria"></textarea>
            </div>

            <div class="c-card c-card-pad songxin-original-card">
                <div class="c-card-title">案件原文</div>
                <textarea id="job-original" class="songxin-editor songxin-editor-readonly" readonly aria-label="案件原文"></textarea>
            </div>
        </section>

        <section class="songxin-grid">
            <div class="c-card c-card-pad">
                <div class="c-card-title" data-i18n="songxin.section.preview">预览</div>
                <div id="preview" class="songxin-preview">
                    这里会展示即将发送的正文预览，确认排版、换行和关键内容是否完整。ABCDEFG1234567890不想超出屏幕会自动换行。
                </div>
            </div>
            <div class="c-card c-card-pad songxin-form">
                <div class="c-card-title" data-i18n="songxin.section.recipient">收件与附件</div>
                <div class="form-field">
                    <label for="email" data-i18n="songxin.field.to">收件人邮箱</label>
                    <input id="email" type="email" placeholder="name@example.com">
                </div>
                <div class="form-field">
                    <label for="subject" data-i18n="songxin.field.subject">邮件标题</label>
                    <textarea id="subject" rows="2" placeholder="请输入邮件标题（未填将使用正文首行）" data-i18n-placeholder="songxin.field.subject_placeholder"></textarea>
                </div>
                <div class="form-field">
                    <label for="cc" data-i18n="songxin.field.cc">抄送 (可选)</label>
                    <input id="cc" type="email" placeholder="cc@example.com">
                </div>
                <div class="form-field">
                    <label for="file-input" data-i18n="songxin.field.attach">上传附件</label>
                    <div class="songxin-upload-bar">
                        <input id="file-input" class="songxin-file-input" type="file" multiple>
                        <button id="btn-upload" class="c-btn c-btn-ghost" type="button" data-i18n="songxin.action.select_file">选择文件</button>
                        <span class="songxin-upload-hint" data-i18n="songxin.attach.hint">支持多文件，建议单个不超过10MB</span>
                    </div>
                    <div id="attachment-list" class="songxin-attachment-list">
                        <div class="songxin-empty-tip" data-i18n="songxin.attach.empty">暂无附件</div>
                    </div>
                </div>
                <div class="songxin-send-actions">
                    <button id="btn-clear" class="c-btn c-btn-ghost" type="button" data-i18n="songxin.action.clear">清空内容</button>
                    <button id="btn-send" class="c-btn c-btn-primary" type="button" aria-label="发送" data-i18n-aria="songxin.action.send">
                        <span data-i18n="songxin.action.send">发送</span>
                        <span aria-hidden="true">➤</span>
                    </button>
                </div>
            </div>
        </section>
    </div>

    <script src="i18n.js"></script>
    <script src="common.js"></script>
<script>
        (function () {
            const i18n = window.I18N;
            const t = (key) => (i18n ? i18n.t(key) : key);
            const format = (key, vars) => (i18n ? i18n.format(key, vars) : key);
            const editor = document.getElementById('editor');
            const email = document.getElementById('email');
            const subjectInput = document.getElementById('subject');
            const cc = document.getElementById('cc');
            const preview = document.getElementById('preview');
            const clearBtn = document.getElementById('btn-clear');
            const sendBtn = document.getElementById('btn-send');
            const uploadBtn = document.getElementById('btn-upload');
            const fileInput = document.getElementById('file-input');
            const attachmentList = document.getElementById('attachment-list');
            const jobOriginal = document.getElementById('job-original');
            const loadingMask = document.getElementById('loading-mask');
            const loadingText = document.getElementById('loading-text');
            const loadingSub = document.getElementById('loading-sub');
            const API_BASE = '';
            if (i18n) {
                i18n.init();
                i18n.apply();
            }
            const fetchWithAuth = async (url, options = {}) => {
                const res = await fetch(url, options);
                if (res.status === 401) {
                    window.location.href = '/login.html';
                    throw new Error('Unauthorized');
                }
                return res;
            };
            const attachments = [];
            const selectionKey = 'matchSelection';
            const matchMailType = 2;
            const isMatchFlow = new URLSearchParams(window.location.search).get('from') === 'match';
            let loadingTimer = null;
            let currentSelection = null;

            const readSelection = () => {
                const raw = localStorage.getItem(selectionKey);
                if (!raw) {
                    currentSelection = null;
                    return null;
                }
                try {
                    currentSelection = JSON.parse(raw);
                } catch {
                    currentSelection = null;
                }
                return currentSelection;
            };

            const extractEmail = (raw) => {
                if (!raw) return '';
                const bracketMatch = raw.match(/<([^>]+)>/);
                if (bracketMatch && bracketMatch[1]) {
                    return bracketMatch[1].trim();
                }
                const emailMatch = raw.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
                return emailMatch ? emailMatch[0].trim() : '';
            };

            const applySelectionFromMatch = () => {
                const data = readSelection();
                if (!data || !data.job || !data.person) return null;

                const job = data.job || {};
                const person = data.person || {};

                const jobLines = [
                    t('songxin.job_info'),
                    job.title ? `${t('songxin.label.title')}：${job.title}` : null,
                    job.desc ? `${t('songxin.label.desc')}：${job.desc}` : null,
                    job.time ? `${t('songxin.label.time')}：${job.time}` : null,
                    job.detail ? `${t('songxin.label.detail')}：\n${job.detail}` : null
                ].filter(Boolean).join('\n');

                const personLines = [
                    t('songxin.person_info'),
                    person.name ? `${t('songxin.label.name')}：${person.name}` : null,
                    person.belong ? `${t('songxin.label.belong')}：${person.belong}` : null,
                    person.time ? `${t('songxin.label.time')}：${person.time}` : null,
                    person.detail ? `${t('songxin.label.detail')}：\n${person.detail}` : null
                ].filter(Boolean).join('\n');

                const combined = [jobLines, personLines].filter(Boolean).join('\n\n');

                if (combined) {
                    editor.value = combined;
                }

                const personSubject = person.subject || person.title || person.name || '';
                if (personSubject) {
                    subjectInput.value = personSubject.startsWith('Re:')
                        ? personSubject
                        : `Re: ${personSubject}`;
                } else {
                    subjectInput.value = deriveSubject(combined);
                }

                if (!email.value) {
                    const replyTo = extractEmail(person.belong || person.from || '');
                    if (replyTo) {
                        email.value = replyTo;
                    }
                }

                return job.detail || job.desc || jobLines || '';
            };

            const setLoading = (isLoading, options = {}) => {
                const { title = t('songxin.loading.processing'), subtitle = t('songxin.loading.wait_sub') } =
                    typeof options === 'string'
                        ? { title: options, subtitle: t('songxin.loading.wait_sub') }
                        : options;

                if (isLoading) {
                    loadingText.textContent = title;
                    loadingSub.textContent = subtitle;
                    loadingMask.hidden = false;
                    loadingMask.style.display = 'none';
                    loadingMask.setAttribute('aria-busy', 'true');
                    // 避免闪屏：只有超过 200ms 的等待才展示
                    clearTimeout(loadingTimer);
                    loadingTimer = setTimeout(() => {
                        loadingMask.style.display = 'flex';
                    }, 200);
                    return;
                }
                clearTimeout(loadingTimer);
                loadingMask.hidden = true;
                loadingMask.style.display = 'none';
                loadingMask.setAttribute('aria-busy', 'false');
            };

            const analyzeQiuren = async (jobText) => {
                if (!jobText) return;
                setLoading(true, { title: t('songxin.loading.analyze_title'), subtitle: t('songxin.loading.analyze_sub') });
                try {
                    const res = await fetchWithAuth(`${API_BASE}/extract-qiuren-detail`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ text: jobText })
                    });
                    if (!res.ok) {
                        throw new Error(`HTTP ${res.status}`);
                    }
                    const data = await res.json();
                    const payload = normalizeApiResponse(data);
                    if (!payload.success) {
                        throw new Error(payload.message || '解析失败');
                    }
                    const result = payload.data || {};
                    const message = typeof result.data === 'string' ? result.data.trim() : '';
                    let formatted = message;
                    if (!formatted) {
                        if (result.data) {
                            formatted = JSON.stringify(result.data, null, 2);
                        } else if (typeof result.raw === 'string') {
                            formatted = result.raw;
                        } else {
                            formatted = '';
                        }
                    }
                    const normalized = normalizeMultiline(formatted);
                    editor.value = normalized || t('songxin.preview.unavailable');
                    renderPreview();
                } catch (err) {
                    console.error('调用 extract_qiuren_detail 失败', err);
                    alert(t('songxin.alert.ai_unavailable'));
                } finally {
                    setLoading(false);
                }
            };

            const formatSize = (bytes) => {
                if (bytes < 1024) return bytes + 'B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + 'KB';
                return (bytes / (1024 * 1024)).toFixed(1) + 'MB';
            };

            const readFileAsBase64 = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const result = reader.result || '';
                    const base64 = typeof result === 'string' && result.includes(',')
                        ? result.split(',').pop()
                        : result;
                    resolve(base64);
                };
                reader.onerror = () => reject(reader.error || new Error(t('songxin.loading.file_failed')));
                reader.readAsDataURL(file);
            });

            const normalizeMultiline = (text) => {
                if (typeof text !== 'string') return '';
                let clean = text
                    .replace(/\r\n/g, '\n')
                    .replace(/\\n/g, '\n')
                    .replace(/\t/g, '    ');
                const trimmed = clean.trim();
                if (trimmed.startsWith('"') && trimmed.endsWith('"')) {
                    clean = trimmed.slice(1, -1);
                }
                return clean;
            };

            const deriveSubject = (text) => {
                const firstLine = (text || '').split('\n').map(t => t.trim()).find(Boolean);
                if (!firstLine) return t('songxin.subject.default');
                return firstLine.slice(0, 60);
            };

            const renderAttachments = () => {
                if (!attachments.length) {
                attachmentList.innerHTML = `<div class="songxin-empty-tip">${t('songxin.attach.empty')}</div>`;
                    return;
                }

                attachmentList.innerHTML = attachments.map((file, idx) => `
                    <div class="songxin-attachment-item" data-idx="${idx}">
                        <div class="songxin-attachment-name">${file.name}</div>
                        <div class="songxin-attachment-meta">
                            <span>${file.sizeLabel}</span>
                            <span class="songxin-remove-link" data-remove="${idx}">${t('songxin.attach.remove')}</span>
                        </div>
                    </div>
                `).join('');
            };

            const renderPreview = () => {
                const content = editor.value.trim();

                if (!content) {
                    preview.textContent = t('songxin.preview.empty');
                    return;
                }

                // 使用 textContent 搭配 pre-line 确保换行正常展示
                preview.textContent = content;
            };

            const renderOriginal = (text) => {
                const content = (text || '').trim();
                jobOriginal.value = content || '';
                jobOriginal.scrollTop = 0;
            };

            clearBtn.addEventListener('click', () => {
                editor.value = '';
                email.value = '';
                subjectInput.value = '';
                cc.value = '';
                attachments.length = 0;
                renderAttachments();
                renderPreview();
                renderOriginal('');
                editor.focus();
            });

            editor.addEventListener('input', renderPreview);
            uploadBtn.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', () => {
                const files = Array.from(fileInput.files || []);
                files.forEach(f => attachments.push({
                    file: f,
                    name: f.name,
                    sizeLabel: formatSize(f.size),
                    type: f.type || 'application/octet-stream',
                    size: f.size
                }));
                fileInput.value = '';
                renderAttachments();
            });

            attachmentList.addEventListener('click', (e) => {
                const idx = e.target.getAttribute('data-remove');
                if (idx === null) return;
                attachments.splice(Number(idx), 1);
                renderAttachments();
            });

            sendBtn.addEventListener('click', async () => {
                const target = email.value.trim();
                if (!target) {
                    alert(t('songxin.alert.email_required'));
                    email.focus();
                    return;
                }
                const content = editor.value.trim();
                if (!content) {
                    alert(t('songxin.alert.content_required'));
                    editor.focus();
                    return;
                }

                const selection = currentSelection || readSelection();
                const personMeta = selection?.person || null;
                const rawMailType = selection?.mail_type;
                const mailType = Number.isFinite(Number(rawMailType))
                    ? Number(rawMailType)
                    : (isMatchFlow ? matchMailType : null);

                setLoading(true, { title: t('songxin.loading.sending_title'), subtitle: t('songxin.loading.sending_sub') });
                try {
                    const attachmentsPayload = await Promise.all(
                        attachments.map(async (att) => ({
                            filename: att.name,
                            content_type: att.type,
                            content: await readFileAsBase64(att.file)
                        }))
                    );

                    const subject = subjectInput.value.trim() || deriveSubject(content);

                    const payload = {
                        to: target,
                        cc: cc.value.trim(),
                        subject,
                        body: content,
                        attachments: attachmentsPayload
                    };
                    if (mailType !== null) {
                        payload.mail_type = mailType;
                    }
                    if (personMeta) {
                        if (personMeta.thread_id) {
                            payload.thread_id = personMeta.thread_id;
                        }
                        if (personMeta.message_id_header) {
                            payload.in_reply_to = personMeta.message_id_header;
                        }
                        if (personMeta.references_header) {
                            payload.references = personMeta.references_header;
                        }
                    }

                    const res = await fetchWithAuth(`${API_BASE}/send-mail`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(payload)
                    });

                    if (!res.ok) {
                        const err = await res.json().catch(() => ({}));
                        const errPayload = normalizeApiResponse(err);
                        throw new Error(errPayload.message || `HTTP ${res.status}`);
                    }
                    const data = await res.json().catch(() => ({}));
                    const responsePayload = normalizeApiResponse(data);
                    if (!responsePayload.success) {
                        throw new Error(responsePayload.message || '发送失败');
                    }

                    alert(t('songxin.alert.sent'));
                    if (window.top && window.top !== window) {
                        window.top.location.hash = 'songxinhistory.html';
                    } else {
                        window.location.href = 'songxinhistory.html';
                    }
                } catch (err) {
                    console.error('发送邮件失败', err);
                    alert(format('songxin.alert.send_failed', { error: err.message || err }));
                } finally {
                    setLoading(false);
                }
            });

            const jobText = applySelectionFromMatch();
            renderAttachments();
            renderPreview();
            renderOriginal(jobText);
            analyzeQiuren(jobText);
            if (window && window.addEventListener) {
                window.addEventListener("i18n:change", () => {
                    if (i18n) {
                        i18n.apply();
                    }
                    renderAttachments();
                    renderPreview();
                    renderOriginal(jobText);
                });
            }
        })();
    </script>
</body>
</html>
