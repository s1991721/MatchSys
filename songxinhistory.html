<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/favicon-32.png" type="image/png" sizes="32x32">
    <link rel="stylesheet" href="common.css">
  <link rel="stylesheet" href="components.css">
  <title data-i18n="songxinhistory.title">送信历史</title>
</head>
<body>
    <div class="page page-wide songxinhistory-page">
        <section class="c-split-grid-wide">
            <div class="c-card c-card-pad">
                <div class="c-card-title" data-i18n="songxinhistory.list.title">历史列表</div>
                <div class="c-filter-grid">
                    <div class="c-filter-group">
                        <span class="c-filter-label" data-i18n="songxinhistory.filter.type">类型</span>
                        <div class="c-chip-row" id="status-group">
                            <button class="c-chip active" data-type="all" type="button">全部</button>
                            <button class="c-chip" data-type="0" type="button">BP</button>
                            <button class="c-chip" data-type="1" type="button">技术者送信</button>
                            <button class="c-chip" data-type="2" type="button">案件送信</button>
                        </div>
                    </div>
                    <div class="c-filter-group">
                        <span class="c-filter-label" data-i18n="songxinhistory.search.label">收件人</span>
                        <div class="songxinhistory-search-row">
                            <input id="search" class="c-input" type="search" placeholder="搜索收件人" data-i18n-placeholder="songxinhistory.search.placeholder">
                            <button id="search-btn" class="c-btn c-btn-primary" type="button" data-i18n="songxinhistory.search.button">搜索</button>
                        </div>
                    </div>
                </div>
                <ul id="history-list" class="c-list c-list-spaced songxinhistory-list"></ul>
                <div class="pagination c-pagination" id="history-pagination">
                    <div class="pagination-summary">
                        <span id="history-page-summary">共 0 条 · 第 1/1 页</span>
                    </div>
                    <div class="pagination-pages" id="history-pagination-pages"></div>
                </div>
            </div>

            <div class="c-card c-card-pad">
                <div class="c-card-title" data-i18n="songxinhistory.detail.title">送信详情</div>
                <div class="songxinhistory-detail-meta" id="detail-meta"></div>
                <div class="c-page-subtitle songxinhistory-section-title" data-i18n="songxinhistory.detail.body">正文</div>
                <div id="history-detail" class="songxin-preview songxinhistory-detail"></div>
                <div class="c-page-subtitle songxinhistory-section-title" data-i18n="songxinhistory.detail.attachments">附件</div>
                <div id="detail-attachments" class="c-chip-row songxinhistory-attachments"></div>
            </div>
        </section>
    </div>

    <script src="i18n.js"></script>
    <script src="common.js"></script>
<script>
        (function () {
            const i18n = window.I18N;
            const t = (key) => (i18n ? i18n.t(key) : key);
            const format = (key, vars) => (i18n ? i18n.format(key, vars) : key);
            const listEl = document.getElementById('history-list');
            const detailEl = document.getElementById('history-detail');
            const metaEl = document.getElementById('detail-meta');
            const attachEl = document.getElementById('detail-attachments');
            const searchInput = document.getElementById('search');
            const searchButton = document.getElementById('search-btn');
            const statusGroup = document.getElementById('status-group');
            const pagination = document.getElementById('history-pagination');
            const paginationPages = document.getElementById('history-pagination-pages');
            const pageSummary = document.getElementById('history-page-summary');
            if (i18n) {
                i18n.init();
                i18n.apply();
            }

            let records = [];
            let currentPage = 1;
            let totalPages = 1;
            let totalCount = 0;
            const PAGE_SIZE = 10;
            let isLoading = false;
            let lastQueryKey = '';

            let activeType = 'all';
            const buildTypeMap = () => ({
                0: { text: t('songxinhistory.type.bp'), cls: 'c-tag-success' },
                1: { text: t('songxinhistory.type.tech'), cls: 'c-tag-warn' },
                2: { text: t('songxinhistory.type.project'), cls: 'c-tag-danger' }
            });
            let typeMap = buildTypeMap();

            const renderAttachments = (files) => {
                if (!files || !files.length) {
                    attachEl.innerHTML = `<div class="songxin-empty-tip">${t('songxinhistory.empty.attachments')}</div>`;
                    return;
                }
                attachEl.innerHTML = files.map(f => `<span class="c-chip">${f}</span>`).join('');
            };

            const renderDetail = (record) => {
                if (!record) {
                    metaEl.innerHTML = `<span class="songxin-empty-tip">${t('songxinhistory.empty.detail')}</span>`;
                    detailEl.textContent = '';
                    renderAttachments([]);
                    return;
                }

                const meta = [
                    format('songxinhistory.meta.to', { value: record.to || '--' }),
                    format('songxinhistory.meta.cc', { value: record.cc || t('songxinhistory.status.none') }),
                    format('songxinhistory.meta.time', { value: record.time }),
                    format(
                        'songxinhistory.meta.status',
                        { value: typeMap[record.mail_type]?.text || t('songxinhistory.type.unknown') }
                    )
                ];
                metaEl.innerHTML = meta.map(m => `<span>${m}</span>`).join('');
                detailEl.innerHTML = `
                    <h4>${record.title}</h4>
                    <p>${(record.content || '').replace(/\n/g, '<br>')}</p>
                `;
                renderAttachments(record.attachments || []);
            };

            const renderList = () => {
                listEl.innerHTML = '';

                if (!records.length) {
                    listEl.innerHTML = `
                        <li class="songxinhistory-item songxinhistory-item-empty">
                            <div class="songxinhistory-title c-empty">${t('songxinhistory.empty.list')}</div>
                        </li>
                    `;
                    renderDetail(null);
                    if (pagination) {
                        pagination.classList.add('hidden');
                    }
                    return;
                }

                if (pagination) {
                    pagination.classList.remove('hidden');
                }

                records.forEach((item, idx) => {
                    const li = document.createElement('li');
                    li.className = 'songxinhistory-item' + (idx === 0 ? ' is-active' : '');
                    li.dataset.id = item.id;
                    li.innerHTML = `
                        <div>
                            <div class="songxinhistory-title">${item.title}</div>
                            <div class="c-chip-row songxinhistory-meta">
                                <span class="c-chip">${format('songxinhistory.meta.to', { value: item.to })}</span>
                                ${item.cc ? `<span class="c-chip">${format('songxinhistory.meta.cc', { value: item.cc })}</span>` : ''}
                            </div>
                        </div>
                        <div class="songxinhistory-time">
                            <div class="c-tag ${typeMap[item.mail_type]?.cls || 'c-tag-neutral'}">
                                ${typeMap[item.mail_type]?.text || t('songxinhistory.type.unknown')}
                            </div>
                            <div>${item.time}</div>
                        </div>
                    `;
                    listEl.appendChild(li);
                });

                renderDetail(records[0]);
            };

            const updatePaginationUI = () => {
                if (pageSummary) {
                    pageSummary.textContent = format('songxinhistory.page_summary', {
                        count: totalCount,
                        page: currentPage,
                        total: totalPages
                    });
                }
                if (pagination && window.renderPagination) {
                    window.renderPagination(pagination, paginationPages, currentPage, totalPages);
                }
            };

            const loadRecords = async (page = 1) => {
                currentPage = page;
                const keyword = searchInput.value.trim();
                const params = window.createParams([
                    ['page', String(currentPage)],
                    ['page_size', String(PAGE_SIZE)],
                    ['mail_type', activeType && activeType !== 'all' ? activeType : ''],
                    ['keyword', keyword]
                ]);
                const queryKey = params.toString();
                if (isLoading && queryKey === lastQueryKey) {
                    return;
                }
                isLoading = true;
                lastQueryKey = queryKey;
                try {
                    const resp = await fetchWithAuth(`/api/send-history?${queryKey}`);
                    if (!resp.ok) {
                        throw new Error(t('songxinhistory.error.load_failed'));
                    }
                    const data = await resp.json();
                    const payload = normalizeApiResponse(data);
                    if (!payload.success) {
                        throw new Error(payload.message || t('songxinhistory.error.load_failed'));
                    }
                    const result = payload.data || {};
                    const meta = payload.meta || {};
                    records = (result.items || []).map(item => {
                        const mailType = Number(item.mail_type);
                        return {
                        id: item.id,
                        title: item.title || t('songxinhistory.placeholder.title'),
                        to: item.to || '',
                        cc: item.cc || '',
                        mail_type: Number.isFinite(mailType) ? mailType : 0,
                        time: item.time || '',
                        content: item.content || '',
                        attachments: item.attachments || [],
                        };
                    });
                    totalCount = Number.isFinite(meta.total) ? meta.total : records.length;
                    totalPages = Number.isFinite(meta.total_pages) ? meta.total_pages : 1;
                    currentPage = Number.isFinite(meta.page) ? meta.page : currentPage;
                } catch (err) {
                    console.error('加载送信历史失败', err);
                    records = [];
                    totalCount = 0;
                    totalPages = 1;
                    currentPage = 1;
                } finally {
                    isLoading = false;
                }
                renderList();
                updatePaginationUI();
            };

            listEl.addEventListener('click', (e) => {
                const item = e.target.closest('.songxinhistory-item');
                if (!item) return;
                const id = Number(item.dataset.id);
                listEl.querySelectorAll('.songxinhistory-item').forEach(el => el.classList.remove('is-active'));
                item.classList.add('is-active');
                const record = records.find(r => r.id === id);
                renderDetail(record);
            });

            statusGroup.addEventListener('click', (e) => {
                const btn = e.target.closest('.c-chip');
                if (!btn) return;
                statusGroup.querySelectorAll('.c-chip').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                activeType = btn.dataset.type || 'all';
                loadRecords(1);
            });

            searchButton.addEventListener('click', () => {
                    loadRecords(1);
                });

            window.bindPagination(pagination, (value) => {
                    let nextPage = currentPage;
                    if (value === 'prev') {
                        nextPage = Math.max(1, currentPage - 1);
                    } else if (value === 'next') {
                        nextPage = Math.min(totalPages, currentPage + 1);
                    } else {
                        const parsed = Number(value);
                        if (Number.isFinite(parsed) && parsed >= 1) {
                            nextPage = parsed;
                        }
                    }
                    if (nextPage !== currentPage) {
                        loadRecords(nextPage);
                    }
                });

            loadRecords(1);

            window.addEventListener("i18n:change", () => {
                if (i18n) {
                    i18n.apply();
                }
                typeMap = buildTypeMap();
                renderList();
                updatePaginationUI();
            });

        })();
    </script>
</body>
</html>
