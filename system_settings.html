<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/favicon-32.png" type="image/png" sizes="32x32">
  <link rel="stylesheet" href="common.css">
  <link rel="stylesheet" href="components.css">
  <title data-i18n="nav.system_settings">系统设置</title>
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "PingFang SC", -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: transparent;
      color: var(--text);
    }

    .page {
      padding: 20px;
      width: 100%;
      max-width: none;
      margin: 0;
    }

    .card {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      background: #fff;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .tile {
      border-radius: 14px;
      border: 1px dashed var(--border);
      padding: 14px;
      background: #f8faff;
    }

    .tile h3 {
      margin: 0 0 6px 0;
      font-size: 14px;
      font-weight: 700;
    }

    .tile p {
      margin: 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.5;
    }

    .settings-stack {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
    }

    .settings-left {
      display: grid;
      gap: 16px;
      align-content: start;
    }

    .settings-card {
      box-shadow: var(--shadowSoft);
    }

    .settings-card .c-card-title {
      margin-bottom: 6px;
    }

    .settings-desc {
      margin: 0 0 16px;
      color: var(--muted);
      font-size: 13px;
    }

    .match-head {
      display: flex;
      align-items: baseline;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .match-head .c-card-title,
    .match-head .settings-desc {
      margin: 0;
    }

    .match-form {
      display: block;
    }

    .match-row {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .match-row .form-field {
      flex: 0 0 auto;
      min-width: 0;
    }

    .match-field {
      flex-direction: row;
      align-items: center;
      gap: 10px;
    }

    .match-field input {
      width: 140px;
    }

    .match-row .form-actions {
      margin-top: 0;
    }

    .inline-status {
      font-size: 12px;
      color: var(--muted);
    }

    .inline-status.success {
      color: var(--success);
    }

    .file-note {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .ai-toggle {
      display: inline-flex;
      gap: 8px;
      padding: 4px;
      border-radius: 999px;
      background: #f1f4fb;
      border: 1px solid var(--border);
    }

    .ai-toggle button {
      border: 0;
      background: transparent;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 700;
      color: #5b6b86;
      cursor: pointer;
    }

    .ai-toggle button.is-active {
      background: #1c7bff;
      color: #fff;
      box-shadow: 0 6px 14px rgba(28, 123, 255, 0.18);
    }

    .ai-fields {
      display: none;
    }

    .ai-fields.is-active {
      display: contents;
    }

    .task-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 12px;
    }

    .task-item {
      border: 1px dashed var(--border);
      border-radius: 14px;
      padding: 14px;
      background: #f9fbff;
    }

    .task-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .task-title {
      font-weight: 700;
      font-size: 13px;
      color: #516079;
    }

    .span-2 {
      grid-column: 1 / -1;
    }

    .config-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 12px;
    }

    .config-item {
      border: 1px dashed var(--border);
      border-radius: 14px;
      padding: 14px;
      background: #f9fbff;
    }

    .config-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .config-title {
      font-weight: 700;
      font-size: 13px;
      color: #516079;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal-backdrop.is-active {
      display: flex;
    }

    .modal {
      background: #fff;
      border-radius: 16px;
      padding: 18px;
      width: min(92vw, 360px);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .modal h3 {
      margin: 0 0 8px;
      font-size: 16px;
    }

    .modal p {
      margin: 0 0 16px;
      color: var(--muted);
      font-size: 13px;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    @media (max-width: 980px) {
      .settings-stack {
        grid-template-columns: 1fr;
      }
      .page {
        margin: 0;
      }
    }

    @media (max-width: 720px) {
      .match-row {
        flex-direction: column;
        align-items: stretch;
      }
      .match-field input {
        width: 100%;
      }
      .match-row .form-actions {
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="settings-stack">
      <div class="settings-left">
        <section class="c-card c-card-pad settings-card">
          <h2 class="c-card-title">营业邮箱配置</h2>
          <form class="form-grid form-grid-spaced">
            <div class="form-field full">
              <label for="gmail-auth">Gmail 认证文件</label>
              <input id="gmail-auth" type="file" accept=".json" />
              <div class="file-note">仅支持上传 Google OAuth 凭据 JSON 文件。</div>
              <div class="file-note" id="gmail-auth-current"></div>
            </div>
            <div class="form-actions">
              <button class="c-btn c-btn-secondary" type="button" id="gmail-test">连接测试</button>
              <button class="c-btn c-btn-primary" type="button" id="gmail-save">保存配置</button>
            </div>
          </form>
        </section>

        <section class="c-card c-card-pad settings-card">
          <div class="match-head">
            <h2 class="c-card-title">Match 配置</h2>
            <p class="settings-desc">周期配置的长短会影响Match的效率和成功率，建议不超过两周</p>
          </div>
          <form class="form-grid form-grid-spaced match-form">
            <div class="match-row">
              <div class="form-field match-field">
                <label for="match-cycle">周期（天）</label>
                <input id="match-cycle" type="number" inputmode="numeric" step="1" min="1" placeholder="例如：14" />
              </div>
              <div class="form-actions">
                <button class="c-btn c-btn-primary" type="button" id="match-save">保存配置</button>
              </div>
            </div>
          </form>
        </section>
      </div>

      <section class="c-card c-card-pad settings-card">
        <h2 class="c-card-title">AI 设置</h2>
        <p class="settings-desc">选择本地或云端模式，并填写对应模型配置。</p>
        <div class="ai-toggle" role="tablist" aria-label="AI 模式切换">
          <button type="button" class="is-active" data-ai-mode="local">本地</button>
          <button type="button" data-ai-mode="cloud">云端</button>
        </div>
        <form class="form-grid form-grid-spaced">
          <div class="ai-fields is-active" data-ai-fields="local">
            <div class="form-field full">
              <label for="ai-model-local">模型名</label>
              <input id="ai-model-local" type="text" placeholder="例如：Qwen2.5-7B" />
            </div>
          </div>
          <div class="ai-fields" data-ai-fields="cloud">
            <div class="form-field full">
              <label for="ai-model-cloud">模型名</label>
              <input id="ai-model-cloud" type="text" placeholder="例如：gpt-4o-mini" />
            </div>
            <div class="form-field full">
              <label for="ai-api-key">API Key</label>
              <input id="ai-api-key" type="password" placeholder="sk-xxxxxxxxxxxxxxxx" />
            </div>
          </div>
          <div class="form-actions">
            <button class="c-btn c-btn-primary" type="button" id="ai-save">保存配置</button>
          </div>
        </form>
      </section>

      <section class="c-card c-card-pad settings-card span-2">
        <h2 class="c-card-title">数据备份</h2>
        <p class="settings-desc">填写备用数据库连接信息，用于备份与灾备切换。</p>
        <form class="form-grid form-grid-spaced">
          <div class="form-field">
            <label for="backup-host">备用数据库地址</label>
            <input id="backup-host" type="text" placeholder="db-backup.internal" />
          </div>
          <div class="form-field">
            <label for="backup-port">端口</label>
            <input id="backup-port" type="number" placeholder="5432" />
          </div>
          <div class="form-field">
            <label for="backup-db">数据库名称</label>
            <input id="backup-db" type="text" placeholder="matchsys_backup" />
          </div>
          <div class="form-field">
            <label for="backup-user">用户名</label>
            <input id="backup-user" type="text" placeholder="backup_admin" />
          </div>
          <div class="form-field">
            <label for="backup-password">密码</label>
            <input id="backup-password" type="password" placeholder="••••••••" />
          </div>
          <div class="form-field">
            <label for="backup-ssl">SSL 模式</label>
            <select id="backup-ssl">
              <option>require</option>
              <option>prefer</option>
              <option>disable</option>
            </select>
          </div>
          <div class="form-field full">
            <label for="backup-note">备注</label>
            <textarea id="backup-note" placeholder="例如：与主库保持实时同步"></textarea>
          </div>
          <div class="form-actions">
            <button class="c-btn c-btn-secondary" type="button" id="backup-test">连接测试</button>
            <button class="c-btn c-btn-primary" type="button" id="backup-save">保存备份配置</button>
          </div>
        </form>
      </section>

      <section class="c-card c-card-pad settings-card">
        <h2 class="c-card-title">送信配置</h2>
        <p class="settings-desc">配置常用邮箱登录信息，并指定使用人。</p>
        <ul class="config-list" id="sendmsg-list"></ul>
        <div class="form-actions">
          <button class="c-btn c-btn-secondary" type="button" id="add-sendmsg">新增配置</button>
        </div>
      </section>

      <section class="c-card c-card-pad settings-card">
        <h2 class="c-card-title">定时任务</h2>
        <p class="settings-desc">支持配置多个任务，每个任务可单独执行与保存。</p>
        <ul class="task-list" id="task-list"></ul>
        <div class="form-actions">
          <button class="c-btn c-btn-secondary" type="button" id="add-task">新增任务</button>
        </div>
      </section>
    </div>
    <div class="modal-backdrop" id="delete-modal" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="delete-title">
        <h3 id="delete-title">确认删除</h3>
        <p id="delete-message">确定删除该项配置吗？</p>
        <div class="modal-actions">
          <button class="c-btn c-btn-ghost" type="button" id="cancel-delete">取消</button>
          <button class="c-btn c-btn-danger" type="button" id="confirm-delete">确认删除</button>
        </div>
      </div>
    </div>
  </div>

  <script src="i18n.js"></script>
  <script>
    if (window.I18N) {
      window.I18N.apply();
    }
    const apiBase = "/api/sys-settings";
    const sections = {
      businessEmail: "business-email",
      match: "match",
      ai: "ai",
      backup: "backup",
      sendmsg: "sendmsg",
      tasks: "tasks",
    };

    const taskList = document.getElementById("task-list");
    const addTaskButton = document.getElementById("add-task");
    const sendmsgList = document.getElementById("sendmsg-list");
    const addSendmsgButton = document.getElementById("add-sendmsg");
    const deleteModal = document.getElementById("delete-modal");
    const deleteMessage = document.getElementById("delete-message");
    const confirmDeleteButton = document.getElementById("confirm-delete");
    const cancelDeleteButton = document.getElementById("cancel-delete");
    const gmailAuthInput = document.getElementById("gmail-auth");
    const gmailAuthCurrent = document.getElementById("gmail-auth-current");
    const gmailSaveButton = document.getElementById("gmail-save");
    const gmailTestButton = document.getElementById("gmail-test");
    const matchSaveButton = document.getElementById("match-save");
    const aiSaveButton = document.getElementById("ai-save");
    const backupSaveButton = document.getElementById("backup-save");
    const backupTestButton = document.getElementById("backup-test");
    let pendingDelete = null;
    let systemTasks = [];
    let sendmsgConfigs = [];
    let businessEmailConfig = { auth_filename: "", auth_json: "" };

    const notifyError = (message) => {
      window.alert(message || "请求失败，请稍后再试。");
    };

    const flashButton = (button, text) => {
      if (!button) return;
      const original = button.textContent;
      button.textContent = text;
      button.disabled = true;
      setTimeout(() => {
        button.textContent = original;
        button.disabled = false;
      }, 1400);
    };

    const requestJson = (url, options) =>
      fetch(url, {
        credentials: "same-origin",
        headers: { "Content-Type": "application/json" },
        ...options,
      }).then(async (response) => {
        const payload = await response.json().catch(() => ({}));
        if (!response.ok || !payload.success) {
          const message = payload.message || "请求失败";
          throw new Error(message);
        }
        return payload;
      });

    const fetchSettings = async (section, fallback) => {
      try {
        const payload = await requestJson(`${apiBase}/${section}`, { method: "GET" });
        return payload.data && payload.data.settings !== undefined
          ? payload.data.settings
          : fallback;
      } catch (error) {
        console.warn(error);
        return fallback;
      }
    };

    const saveSettings = async (section, settings) => {
      const payload = await requestJson(`${apiBase}/${section}`, {
        method: "PUT",
        body: JSON.stringify({ settings }),
      });
      return payload.data && payload.data.settings !== undefined
        ? payload.data.settings
        : settings;
    };

    const taskFormHtml = (index, task) => `
      <li class="task-item">
        <div class="task-head">
          <span class="task-title">任务 ${String(index + 1).padStart(2, "0")}</span>
          <span class="inline-status" id="task-status-${index}">未执行</span>
        </div>
        <form class="form-grid">
          <div class="form-field">
            <label for="task-name-${index}">任务名称</label>
            <input id="task-name-${index}" type="text" placeholder="每日同步客户" value="${task.name || ""}" />
          </div>
          <div class="form-field">
            <label for="task-time-${index}">执行时间</label>
            <input id="task-time-${index}" type="time" value="${task.time || "09:00"}" />
          </div>
          <div class="form-field">
            <label for="task-frequency-${index}">执行频率</label>
            <select id="task-frequency-${index}">
              <option ${task.frequency === "每天" ? "selected" : ""}>每天</option>
              <option ${task.frequency === "每周" ? "selected" : ""}>每周</option>
              <option ${task.frequency === "每月" ? "selected" : ""}>每月</option>
              <option ${task.frequency === "自定义 Cron" ? "selected" : ""}>自定义 Cron</option>
            </select>
          </div>
          <div class="form-field">
            <label for="task-method-${index}">请求方式</label>
            <select id="task-method-${index}">
              <option ${task.method === "POST" ? "selected" : ""}>POST</option>
              <option ${task.method === "GET" ? "selected" : ""}>GET</option>
              <option ${task.method === "PUT" ? "selected" : ""}>PUT</option>
              <option ${task.method === "DELETE" ? "selected" : ""}>DELETE</option>
            </select>
          </div>
          <div class="form-field full">
            <label for="task-api-${index}">API 地址</label>
            <input id="task-api-${index}" type="text" placeholder="https://api.example.com/sync" value="${task.api || ""}" />
          </div>
          <div class="form-field full">
            <label for="task-body-${index}">请求参数 / Body</label>
            <textarea id="task-body-${index}" placeholder='{"range":"today"}'>${task.body || ""}</textarea>
          </div>
          <div class="form-actions">
            <button class="c-btn c-btn-success" type="button" data-run-now="${index}">立即执行</button>
            <button class="c-btn c-btn-primary" type="button" data-save-task="${index}">保存任务</button>
            <button class="c-btn c-btn-danger" type="button" data-delete-task="${index}">删除</button>
          </div>
        </form>
      </li>
    `;

    const renderTasks = (tasks) => {
      if (!taskList) return;
      taskList.innerHTML = "";
      const items = tasks.length ? tasks : [{}];
      taskList.innerHTML = items.map((task, index) => taskFormHtml(index, task)).join("");
    };

    const openDeleteModal = (message, onConfirm) => {
      if (!deleteModal || !deleteMessage) return;
      pendingDelete = onConfirm;
      deleteMessage.textContent = message;
      deleteModal.classList.add("is-active");
      deleteModal.setAttribute("aria-hidden", "false");
    };

    const closeDeleteModal = () => {
      if (!deleteModal) return;
      deleteModal.classList.remove("is-active");
      deleteModal.setAttribute("aria-hidden", "true");
      pendingDelete = null;
    };

    if (confirmDeleteButton) {
      confirmDeleteButton.addEventListener("click", () => {
        if (typeof pendingDelete === "function") {
          pendingDelete();
        }
        closeDeleteModal();
      });
    }

    if (cancelDeleteButton) {
      cancelDeleteButton.addEventListener("click", closeDeleteModal);
    }

    if (deleteModal) {
      deleteModal.addEventListener("click", (event) => {
        const target = event.target;
        if (target instanceof HTMLElement && target.classList.contains("modal-backdrop")) {
          closeDeleteModal();
        }
      });
    }


    const sendmsgFormHtml = (index, config) => `
      <li class="config-item">
        <div class="config-head">
          <span class="config-title">配置 ${String(index + 1).padStart(2, "0")}</span>
          <span class="inline-status" id="sendmsg-status-${index}"></span>
        </div>
        <form class="form-grid">
          <div class="form-field">
            <label for="sendmsg-email-${index}">邮箱账号</label>
            <input id="sendmsg-email-${index}" type="email" placeholder="staff@company.com" value="${config.email || ""}" />
          </div>
          <div class="form-field">
            <label for="sendmsg-password-${index}">密码 / 授权码</label>
            <input id="sendmsg-password-${index}" type="password" placeholder="••••••••" value="${config.password || ""}" />
          </div>
          <div class="form-field">
            <label for="sendmsg-smtp-${index}">SMTP 服务器</label>
            <input id="sendmsg-smtp-${index}" type="text" placeholder="smtp.gmail.com" value="${config.smtp || ""}" />
          </div>
          <div class="form-field">
            <label for="sendmsg-port-${index}">端口</label>
            <input id="sendmsg-port-${index}" type="number" placeholder="587" value="${config.port || ""}" />
          </div>
          <div class="form-field">
            <label for="sendmsg-user-${index}">使用人</label>
            <select id="sendmsg-user-${index}">
              <option ${!config.user ? "selected" : ""}>请选择使用人</option>
              <option ${config.user === "张三" ? "selected" : ""}>张三</option>
              <option ${config.user === "李四" ? "selected" : ""}>李四</option>
              <option ${config.user === "王五" ? "selected" : ""}>王五</option>
            </select>
          </div>
          <div class="form-actions">
            <button class="c-btn c-btn-secondary" type="button">连接测试</button>
            <button class="c-btn c-btn-primary" type="button" data-save-sendmsg="${index}">保存配置</button>
            <button class="c-btn c-btn-danger" type="button" data-delete-sendmsg="${index}">删除</button>
          </div>
        </form>
      </li>
    `;

    const renderSendmsgConfigs = (configs) => {
      if (!sendmsgList) return;
      sendmsgList.innerHTML = "";
      const items = configs.length ? configs : [{}];
      sendmsgList.innerHTML = items
        .map((config, index) => sendmsgFormHtml(index, config))
        .join("");
    };


    const aiToggleButtons = document.querySelectorAll(".ai-toggle button");
    const aiFields = document.querySelectorAll("[data-ai-fields]");

    const setAiMode = (mode) => {
      aiToggleButtons.forEach((btn) => btn.classList.toggle("is-active", btn.getAttribute("data-ai-mode") === mode));
      aiFields.forEach((block) => {
        block.classList.toggle(
          "is-active",
          block.getAttribute("data-ai-fields") === mode
        );
      });
    };

    aiToggleButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const mode = button.getAttribute("data-ai-mode");
        setAiMode(mode);
      });
    });

    const getValue = (id) => {
      const el = document.getElementById(id);
      return el ? el.value : "";
    };

    const setValue = (id, value) => {
      const el = document.getElementById(id);
      if (el) el.value = value == null ? "" : value;
    };

    const setInlineStatus = (id, text, success) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = text;
      el.classList.toggle("success", Boolean(success));
    };

    const collectSendmsgConfig = (index) => ({
      email: getValue(`sendmsg-email-${index}`).trim(),
      password: getValue(`sendmsg-password-${index}`),
      smtp: getValue(`sendmsg-smtp-${index}`).trim(),
      port: getValue(`sendmsg-port-${index}`),
      user: getValue(`sendmsg-user-${index}`),
    });

    const collectTaskConfig = (index) => ({
      name: getValue(`task-name-${index}`).trim(),
      time: getValue(`task-time-${index}`),
      frequency: getValue(`task-frequency-${index}`),
      method: getValue(`task-method-${index}`),
      api: getValue(`task-api-${index}`).trim(),
      body: getValue(`task-body-${index}`),
    });

    if (gmailAuthInput) {
      gmailAuthInput.addEventListener("change", async (event) => {
        const file = event.target.files ? event.target.files[0] : null;
        if (!file) return;
        try {
          const content = await file.text();
          businessEmailConfig = {
            auth_filename: file.name || "",
            auth_json: content,
          };
          if (gmailAuthCurrent) {
            gmailAuthCurrent.textContent = businessEmailConfig.auth_filename
              ? `已选择：${businessEmailConfig.auth_filename}`
              : "已选择凭据";
          }
        } catch (error) {
          notifyError("读取文件失败，请重试。");
        }
      });
    }

    if (gmailSaveButton) {
      gmailSaveButton.addEventListener("click", async () => {
        if (!businessEmailConfig.auth_json) {
          notifyError("请先选择 Gmail 认证文件。");
          return;
        }
        try {
          businessEmailConfig = await saveSettings(sections.businessEmail, businessEmailConfig);
          flashButton(gmailSaveButton, "已保存");
        } catch (error) {
          notifyError(error.message);
        }
      });
    }

    if (gmailTestButton) {
      gmailTestButton.addEventListener("click", () => {
        notifyError("连接测试暂未实现，请先保存配置。");
      });
    }

    if (matchSaveButton) {
      matchSaveButton.addEventListener("click", async () => {
        const cycleValue = Number(getValue("match-cycle"));
        if (!cycleValue || cycleValue < 1) {
          notifyError("周期（天）必须大于 0。");
          return;
        }
        const settings = { cycle_days: cycleValue };
        try {
          await saveSettings(sections.match, settings);
          flashButton(matchSaveButton, "已保存");
        } catch (error) {
          notifyError(error.message);
        }
      });
    }

    if (aiSaveButton) {
      aiSaveButton.addEventListener("click", async () => {
        const modeButton = document.querySelector(".ai-toggle button.is-active");
        const mode = modeButton ? modeButton.getAttribute("data-ai-mode") : "local";
        const settings = {
          mode,
          local_model: getValue("ai-model-local").trim(),
          cloud_model: getValue("ai-model-cloud").trim(),
          cloud_api_key: getValue("ai-api-key"),
        };
        try {
          await saveSettings(sections.ai, settings);
          flashButton(aiSaveButton, "已保存");
        } catch (error) {
          notifyError(error.message);
        }
      });
    }

    if (backupSaveButton) {
      backupSaveButton.addEventListener("click", async () => {
        const settings = {
          host: getValue("backup-host").trim(),
          port: getValue("backup-port").trim(),
          database: getValue("backup-db").trim(),
          user: getValue("backup-user").trim(),
          password: getValue("backup-password"),
          ssl_mode: getValue("backup-ssl"),
          note: getValue("backup-note").trim(),
        };
        try {
          await saveSettings(sections.backup, settings);
          flashButton(backupSaveButton, "已保存");
        } catch (error) {
          notifyError(error.message);
        }
      });
    }

    if (backupTestButton) {
      backupTestButton.addEventListener("click", () => {
        notifyError("连接测试暂未实现，请先保存配置。");
      });
    }

    if (taskList) {
      taskList.addEventListener("click", async (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        const runButton = target.closest("[data-run-now]");
        const deleteButton = target.closest("[data-delete-task]");
        const saveButton = target.closest("[data-save-task]");
        if (deleteButton) {
          const index = Number(deleteButton.getAttribute("data-delete-task"));
          if (Number.isNaN(index)) return;
          openDeleteModal("确定删除该定时任务吗？", async () => {
            systemTasks.splice(index, 1);
            renderTasks(systemTasks);
            try {
              await saveSettings(sections.tasks, systemTasks);
            } catch (error) {
              notifyError(error.message);
            }
          });
          return;
        }
        if (saveButton) {
          const index = Number(saveButton.getAttribute("data-save-task"));
          if (Number.isNaN(index)) return;
          systemTasks[index] = collectTaskConfig(index);
          try {
            await saveSettings(sections.tasks, systemTasks);
            setInlineStatus(`task-status-${index}`, "已保存", true);
          } catch (error) {
            notifyError(error.message);
          }
          return;
        }
        if (!runButton) return;
        const index = runButton.getAttribute("data-run-now");
        const statusEl = document.getElementById(`task-status-${index}`);
        if (!statusEl) return;
        const now = new Date();
        statusEl.textContent = `已触发：${now.toLocaleString("zh-CN", {
          hour12: false,
        })}`;
        statusEl.classList.add("success");
      });
    }

    if (addTaskButton) {
      addTaskButton.addEventListener("click", () => {
        systemTasks.push({});
        renderTasks(systemTasks);
      });
    }

    if (sendmsgList) {
      sendmsgList.addEventListener("click", async (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        const deleteButton = target.closest("[data-delete-sendmsg]");
        const saveButton = target.closest("[data-save-sendmsg]");
        if (deleteButton) {
          const index = Number(deleteButton.getAttribute("data-delete-sendmsg"));
          if (Number.isNaN(index)) return;
          openDeleteModal("确定删除该送信配置吗？", async () => {
            sendmsgConfigs.splice(index, 1);
            renderSendmsgConfigs(sendmsgConfigs);
            try {
              await saveSettings(sections.sendmsg, sendmsgConfigs);
            } catch (error) {
              notifyError(error.message);
            }
          });
          return;
        }
        if (saveButton) {
          const index = Number(saveButton.getAttribute("data-save-sendmsg"));
          if (Number.isNaN(index)) return;
          sendmsgConfigs[index] = collectSendmsgConfig(index);
          try {
            await saveSettings(sections.sendmsg, sendmsgConfigs);
            setInlineStatus(`sendmsg-status-${index}`, "已保存", true);
          } catch (error) {
            notifyError(error.message);
          }
        }
      });
    }

    if (addSendmsgButton) {
      addSendmsgButton.addEventListener("click", () => {
        sendmsgConfigs.push({});
        renderSendmsgConfigs(sendmsgConfigs);
      });
    }

    const loadSettings = async () => {
      businessEmailConfig = await fetchSettings(sections.businessEmail, businessEmailConfig);
      if (gmailAuthCurrent) {
        gmailAuthCurrent.textContent = businessEmailConfig.auth_filename
          ? `已保存：${businessEmailConfig.auth_filename}`
          : businessEmailConfig.auth_json
            ? "已保存凭据"
            : "";
      }

      const matchSettings = await fetchSettings(sections.match, { cycle_days: 14 });
      setValue("match-cycle", matchSettings.cycle_days || "");

      const aiSettings = await fetchSettings(sections.ai, {
        mode: "local",
        local_model: "",
        cloud_model: "",
        cloud_api_key: "",
      });
      setAiMode(aiSettings.mode || "local");
      setValue("ai-model-local", aiSettings.local_model || "");
      setValue("ai-model-cloud", aiSettings.cloud_model || "");
      setValue("ai-api-key", aiSettings.cloud_api_key || "");

      const backupSettings = await fetchSettings(sections.backup, {});
      setValue("backup-host", backupSettings.host || "");
      setValue("backup-port", backupSettings.port || "");
      setValue("backup-db", backupSettings.database || "");
      setValue("backup-user", backupSettings.user || "");
      setValue("backup-password", backupSettings.password || "");
      setValue("backup-ssl", backupSettings.ssl_mode || "require");
      setValue("backup-note", backupSettings.note || "");

      sendmsgConfigs = await fetchSettings(sections.sendmsg, []);
      if (!Array.isArray(sendmsgConfigs)) {
        sendmsgConfigs = [];
      }
      renderSendmsgConfigs(sendmsgConfigs);

      systemTasks = await fetchSettings(sections.tasks, []);
      if (!Array.isArray(systemTasks)) {
        systemTasks = [];
      }
      renderTasks(systemTasks);
    };

    loadSettings();
  </script>
</body>
</html>
